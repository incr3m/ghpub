import{j as s}from"./TransitionGroupContext-9d36972e.js";import{R as d}from"./index-f1f749bf.js";import{T as x}from"./TextField-66711980.js";import{ar as W,as as I,T as w,m as S,b5 as $,ab as E,$ as C,L as P,B as p,aw as R,l as B,s as y}from"./papaparse.min-b66e70e7.js";import{g as h}from"./_baseForOwn-9b89c4b6.js";import{g as j}from"./github-91d085b0.js";import{B as v}from"./Button-352c3435.js";import{u as F}from"./useGetProjectSummaryFields-0ab32aca.js";import"./assertThisInitialized-ad1db8e7.js";import"./_commonjsHelpers-042e6b4d.js";import"./Play-87fed129.js";import"./react-router-19e5b27c.js";import"./index-4d501b15.js";import"./tiny-invariant-dd7d57d2.js";import"./index-bcfaa842.js";import"./index-96c5f47c.js";import"./isNativeReflectConstruct-05c29d01.js";import"./iframe-ed7f5a3f.js";import"../sb-preview/runtime.js";import"./filter-f99df4e5.js";import"./LocalizationProvider-a287304f.js";import"./react-router-dom-60ea8218.js";import"./debounce-213cd46f.js";import"./uniq-0d482d7b.js";import"./_arrayIncludes-2cfb33ae.js";import"./cloneDeep-91467704.js";import"./isPlainObject-07477f89.js";const T=S({black:{color:"#000 !important"}});function N({inputProps:n,disabled:i,classes:e,label:u,checked:l,...r}){const c=T();return s.jsx(W,{classes:{label:c.black},control:s.jsx(I,{...r,checked:!!l,disabled:i,classes:{...e,disabled:i&&l?c.black:void 0},inputProps:n}),label:s.jsx(w,{style:{fontSize:"12px"},children:u})})}const _=S({root:{}});function L({repo:n,token:i},e){const u=$(),l=d.useMemo(()=>h(u,"aws_cloud_logic_custom",[]).reduce((t,o)=>(o.name==="embraceRestApi"&&(t=`${o.endpoint}/hooks/github`),t),""),[]),[r,c]=d.useState({hookId:void 0,error:null}),m=E("project-setting");console.log(">>github/Webhooks::","awsExports",u),console.log(">>github/Webhooks::","hookPayloadUrl",l);const g=m==null?void 0:m.githubWebhookSecret,b=_();e.current=e.current||{},e.current.getHookId=d.useCallback(async()=>{if(console.log(">>github/Webhooks::","repo,token",n,i),!n||!i)return;const t=await j({path:`/repos/${n}/hooks`,token:i});console.log(">>github/Webhooks::","res",t);let o=null;if(t.message==="Not Found")throw Error("Not Found");return t instanceof Array&&t.some(a=>{if(h(a,"config.url")===l)return o=a.id,!0}),console.log(">>github/Webhooks::","hookId",o),o},[l,n,i]),C(async t=>{try{const o=await e.current.getHookId();t()&&c(a=>({...a,hookId:o}))}catch(o){console.error(o),c(a=>({...a,error:o.message}))}},[e.current.getHookId]);const f=d.useCallback(async()=>{if(!n||!i)return;if(c(o=>({...o,loading:!0})),r.hookId)await j({method:"DELETE",path:`/repos/${n}/hooks/${r.hookId}`,token:i,toJson:!1});else{const o=await j({method:"POST",path:`/repos/${n}/hooks`,token:i,body:{config:{url:l,content_type:"json",secret:g},events:["*"]}});console.log(">>github/Webhooks::","res",o)}const t=await e.current.getHookId();c(o=>({...o,loading:!1,hookId:t}))},[n,i,r.hookId,e,l,g]);return s.jsx("div",{className:b.root,children:s.jsxs(P,{text:"Webhooks",contentBox:{pl:1},mb:1,children:[!g&&s.jsx(p,{color:"red",children:"Github Webhook Secret is Empty"}),g&&r.hookId!==void 0&&s.jsx(v,{variant:"outlined",size:"small",disabled:r.loading,onClick:f,children:r.hookId?"Enabled":"Disabled"}),r.error&&s.jsx(p,{color:"orange",children:r.error})]})})}const O=d.forwardRef(L);function go({projectId:n,onSubmit:i}){const[e,u]=d.useState({integrations:{}}),l=d.useRef(),r=F({projectId:n});d.useEffect(()=>{console.log(">>project/ProjectForm::","data",r);const t=(r.integrations||[]).reduce((o,a)=>{const k=JSON.parse(a);return k.code&&(o[k.code]=k),o},{});u(o=>({...o,integrations:t}))},[r]),console.log(">>project/ProjectForm::","state",e);const[c,{loading:m}]=R(B`
    mutation ($integrations: [AWSJSON], $id: ID!) {
      updateProject(input: { id: $id, integrations: $integrations }) {
        id
        integrations
      }
    }
  `),g=async function(){await c({variables:{id:r.id,integrations:Object.entries(e.integrations).map(([t,o])=>JSON.stringify({...o,code:t}))}}),i()},b=function(t){return{value:h(e,t,""),onChange:o=>{const a=o.target.value;u(y(t,a))}}},f=function(t){return{value:h(e,t,""),onChange:o=>{const a=o.target.checked;u(y(t,a))}}};return s.jsxs(p,{p:2,children:[s.jsxs(p,{mt:2,mb:2,minWidth:"400",children:[s.jsx(x,{label:"Repository",fullWidth:!0,...b("integrations.github.repository")}),s.jsx(x,{label:"Token",fullWidth:!0,...b("integrations.github.token"),type:"password"}),s.jsx(x,{label:"Label",fullWidth:!0,...b("integrations.github.label")}),s.jsx(N,{...f("integrations.github.embraceSync"),checked:h(e,"integrations.github.embraceSync"),label:"Sync updates to github"})]}),s.jsx(O,{repo:h(e,"integrations.github.repository"),token:h(e,"integrations.github.token"),ref:l}),s.jsx(p,{display:"flex",flexDirection:"row-reverse",children:s.jsx(v,{variant:"contained",disabled:m,onClick:g,color:"primary",children:"Save"})})]})}export{go as default};
