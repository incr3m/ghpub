import{j as l}from"./TransitionGroupContext-9d36972e.js";import{R as $}from"./index-f1f749bf.js";import{a$ as B,b0 as K,b1 as O,b2 as M,b3 as Q,k as z,v as ee,w as te,a2 as re,J as oe,P as ae,B as k,T as _,x as se}from"./papaparse.min-b66e70e7.js";import{R as ne,A as ie,p,E as le,T as ue,c as S,a as ce,L as q}from"./EmptyFiltersWarning-efcfc65c.js";import"./_baseForOwn-9b89c4b6.js";import{l as x,w as N}from"./index-bcfaa842.js";import"./index-96c5f47c.js";import{X as me,L as W,A as pe,V as de,a as ge,b as ye,B as I}from"./AxisRendererY-0d50d85b.js";import{C as fe,a as he}from"./ColumnSeries-d191de0f.js";import{c as Ae}from"./stories-1f769a10.js";import"./assertThisInitialized-ad1db8e7.js";import"./_commonjsHelpers-042e6b4d.js";import"./_arrayIncludes-2cfb33ae.js";import"./Button-352c3435.js";import"./isPlainObject-07477f89.js";import"./debounce-213cd46f.js";import"./iframe-ed7f5a3f.js";import"../sb-preview/runtime.js";import"./index-4d501b15.js";import"./isNativeReflectConstruct-05c29d01.js";const xe=B(K);async function be(a){var C,T,V,F,J,L,X,Y,E,P;const{agentId:r}=a||{},e=await O({index:"project",body:{size:0,query:{bool:{must_not:[{terms:{"attributes.liveJobStatus.keyword":["invoiced","lost"]}}],filter:M([r&&{term:{"attributes.leadAgent.keyword":r}}])}},aggs:{byStage:{terms:{field:"attributes.probability",size:1e4,min_doc_count:1},aggs:{byJob:{terms:{field:"id.keyword",size:1e4,min_doc_count:1},aggs:{totalValue:{sum:{field:"attributes.likelySellingPrice"}},filterZeroAmount:{bucket_selector:{buckets_path:{amount:"totalValue.value"},script:"params.amount > 0"}}}},totalValue:{sum:{field:"attributes.likelySellingPrice"}},filterZeroAmount:{bucket_selector:{buckets_path:{amount:"totalValue.value"},script:"params.amount > 0"}}}},totalValue:{sum:{field:"attributes.likelySellingPrice"}}}}}),o=await xe.find(Q({"attributes.leadAgent.keyword":r?[r]:void 0}),{size:1e4,query:{bool:{must_not:[{terms:{"attributes.liveJobStatus.keyword":["invoiced","lost"]}}]}}}),u=o==null?void 0:o.map(t=>t==null?void 0:t.id),s=await O({index:"resource",body:{size:0,query:{bool:{must_not:[{range:{"attributes.agentsFee":{lte:0}}}],filter:[r&&{terms:{"attributes.valuerId.keyword":[r]}},(u==null?void 0:u.length)&&{terms:{"groups.id.keyword":u}}]}},aggs:{byJob:{terms:{field:"groups.id.keyword",size:1e4,min_doc_count:1},aggs:{byAgent:{terms:{field:"attributes.valuerId.keyword",size:1e4,min_doc_count:1},aggs:{totalAmount:{sum:{field:"attributes.agentsFee"}},filterZeroAmount:{bucket_selector:{buckets_path:{amount:"totalAmount.value"},script:"params.amount > 0"}}}},totalAmount:{sum:{field:"attributes.agentsFee"}},filterZeroAmount:{bucket_selector:{buckets_path:{amount:"totalAmount.value"},script:"params.amount > 0"}}}},totalAmount:{sum:{field:"attributes.agentsFee"}}}}});console.log(">>charts/getSalesJobChartData::","res",e);const A=((T=(C=e.aggregations)==null?void 0:C.totalValue)==null?void 0:T.value)||0,w=((F=(V=s==null?void 0:s.aggregations)==null?void 0:V.totalAmount)==null?void 0:F.value)||0,d=z(o,t=>{var i,h;return(h=(i=t==null?void 0:t.id)==null?void 0:i.trim())==null?void 0:h.toLowerCase()}),y=(X=(L=(J=s==null?void 0:s.aggregations)==null?void 0:J.byJob)==null?void 0:L.buckets)==null?void 0:X.map(t=>{var h,R,D;const i=d==null?void 0:d[t==null?void 0:t.key];return{id:i==null?void 0:i.id,probability:i==null?void 0:i.probability,totalAmount:((h=t==null?void 0:t.totalAmount)==null?void 0:h.value)||0,agents:(D=(R=t==null?void 0:t.byAgent)==null?void 0:R.buckets)==null?void 0:D.map(g=>{var j;return{id:g==null?void 0:g.key,totalAmount:((j=g==null?void 0:g.totalAmount)==null?void 0:j.value)||0}})}}),c=x.mapValues(x.groupBy(y,"probability"),t=>x.sumBy(t,"totalAmount")),f=x.groupBy(o,"probability"),m=(P=(E=(Y=e.aggregations)==null?void 0:Y.byStage)==null?void 0:E.buckets)==null?void 0:P.map(t=>({...t,totalNet:{value:(c==null?void 0:c[t==null?void 0:t.key])||0}})),n=z(m,"key"),v={totalPropertyValue:A,totalNet:w,stages:n};return console.log({getSalesJobChartData:v,feeSplitsByJob:y,jobsByStages:f,jobs:o,jobIds:u,res:e,totalNetFeeByStage:c,stages:n}),v}function U(){const[{agent:a}]=ee({agent:te}),{data:r}=re({queryKey:["AGENT_ACTIVITY_REPORT_SALES_JOBS_CHART_DATA",{agent:a}],queryFn:async()=>{if(a)return be({agentId:a})}});return console.log("@SALES_JOBS_CHART_DATA::",r),$.useLayoutEffect(()=>{if(!r)return;const e=ne.new("sales-jobs-column-bar-chart");e.setThemes([ie.new(e)]),e!=null&&e._logo&&e._logo.dispose();const o=e.container.children.push(me.new(e,{panX:!0,panY:!0,wheelY:"zoomXY",paddingLeft:0,layout:e.verticalLayout}));let u=o.children.push(W.new(e,{centerX:p,x:p}));const s=Object.entries((r==null?void 0:r.stages)||[]).map(c=>{const[f,m]=c;return{jobStage:oe(we(f)),netFee:m.totalNet.value,propertyValue:m.totalValue.value}}),A=o.yAxes.push(fe.new(e,{categoryField:"jobStage",renderer:pe.new(e,{inversed:!0,cellStartLocation:.1,cellEndLocation:.9,minorGridEnabled:!0})}));A.data.setAll(s);const w=o.xAxes.push(de.new(e,{renderer:ge.new(e,{strokeOpacity:.1,minGridDistance:110}),min:0}));function d(c,f,m){const n=o.series.push(he.new(e,{name:f,xAxis:w,yAxis:A,valueXField:c,categoryYField:"jobStage",sequencedInterpolation:!0,tooltip:ue.new(e,{pointerOrientation:"horizontal",labelText:"[bold]{name}[/]\n{categoryY}: ${valueX}"}),fill:S(m),stroke:S(m)}));return n.columns.template.setAll({height:ce,strokeOpacity:0}),n.bullets.push(function(){return I.new(e,{locationX:1,locationY:.5,sprite:q.new(e,{centerY:p,text:"{valueX}",populateText:!0})})}),n.bullets.push(function(){return I.new(e,{locationX:1,locationY:.5,sprite:q.new(e,{centerX:p,centerY:p,fill:S(16777215)})})}),n.data.setAll(s),n.appear(),n}d("netFee","Net Fee","#cd7f32"),d("propertyValue","Property Value","#184e9a"),u=o.children.push(W.new(e,{centerX:p,x:p})),u.data.setAll(o.series.values);const y=o.set("cursor",ye.new(e,{behavior:"zoomY"}));return y.lineY.set("forceHidden",!0),y.lineX.set("forceHidden",!0),o.appear(1e3,100),()=>e.dispose()},[r]),l.jsxs(ae,{sx:{borderRadius:"4px",p:4,display:"flex",flexDirection:"column"},children:[l.jsxs(k,{sx:e=>({pb:2,display:"flex",flexDirection:"row",justifyContent:"space-between",borderBottom:`1px solid ${e.palette.text.disabled}`}),children:[l.jsx(_,{component:"h6",fontWeight:900,children:"Sales Jobs"}),l.jsxs(se,{direction:"row",columnGap:4,children:[l.jsxs(_,{component:"h6",fontWeight:900,children:["Property Value:",N.numberFormatter((r==null?void 0:r.totalPropertyValue)||0).toCurrencyRounded()]}),l.jsxs(_,{component:"h6",fontWeight:900,children:["Net Fee:"," ",N.numberFormatter((r==null?void 0:r.totalNet)||0).toCurrencyRounded()]})]})]}),a?l.jsx(k,{id:"sales-jobs-column-bar-chart",sx:{width:1,height:800}}):l.jsx(le,{message:"Please fill agent filter accordingly"})]})}function we(a){return a==20?"Executed Agency":a==40?"Listed Campaign":a==60?"Offers Received":a==80?"Offer & Acceptance":a==100?"Unconditional":`${a}`}const We={title:"LAWD/User View Sales Job Chart",component:U,tags:["LAWD"]},{RenderComponent:_e}=Ae(()=>l.jsx(U,{})),b={render:_e};var G,H,Z;b.parameters={...b.parameters,docs:{...(G=b.parameters)==null?void 0:G.docs,source:{originalSource:`{
  render: RenderComponent
}`,...(Z=(H=b.parameters)==null?void 0:H.docs)==null?void 0:Z.source}}};const Ie=["Default"];export{b as Default,Ie as __namedExportsOrder,We as default};
