import{j as e}from"./TransitionGroupContext-9d36972e.js";import{R as i}from"./index-f1f749bf.js";import{at as V,B as d,a4 as B,d as S,T as C,W as M,ag as $,J as I,a9 as z,K as Q,m as D,v as E,w as k,Y as Z,p as A,af as q,V as U,L as Y,Z as K,aC as J,aN as X,l as ee,ad as te,u as re,z as se,D as oe,a3 as ne,R as ae,P as ie,U as ce}from"./papaparse.min-b66e70e7.js";import{g as L}from"./_baseForOwn-9b89c4b6.js";import{d as le}from"./debounce-213cd46f.js";import{S as de,e as ue,w as me}from"./Play-87fed129.js";import{u as pe}from"./uniq-0d482d7b.js";import{U as he}from"./index-4d31058a.js";import{B as w}from"./Button-352c3435.js";import{d as fe}from"./Undo-33c7aa7a.js";import{c as xe}from"./camelCase-4e7e8b23.js";import{C as N}from"./SelectEsModelInput-d580a9f7.js";import{u as ye}from"./useIncludeFieldNames-35a180a9.js";import{e as je,j as ge}from"./pick-dba65392.js";import{u as O}from"./react-router-19e5b27c.js";import{f as T}from"./index-bcfaa842.js";import{u as Ce}from"./useTagSearch-f4fcfbe9.js";import{u as be}from"./useFetchMore-be228481.js";import"./assertThisInitialized-ad1db8e7.js";import"./_commonjsHelpers-042e6b4d.js";import"./_arrayIncludes-2cfb33ae.js";import"./index-96c5f47c.js";import"./isPlainObject-07477f89.js";import"./iframe-ed7f5a3f.js";import"../sb-preview/runtime.js";import"./index-4d501b15.js";import"./filter-f99df4e5.js";import"./LocalizationProvider-a287304f.js";import"./react-router-dom-60ea8218.js";import"./tiny-invariant-dd7d57d2.js";import"./cloneDeep-91467704.js";import"./capitalize-c31f38e2.js";import"./index-61adb48a.js";import"./useGetProjectSummaryFields-0ab32aca.js";import"./Link-c687dc07.js";import"./Save-b67fa0ac.js";import"./index-147ad7aa.js";import"./Add-be7f5660.js";import"./isNativeReflectConstruct-05c29d01.js";const ve="Everyone",R=i.createContext();function Ie(r){return({defaultPrivacyOpts:c={},footer:o,...t})=>{const s=i.useRef({}),u=i.useRef(null),{globalState:{authUser:p}}=V();console.log(">>BeForm/withAuth::","authUser",p);const[a,n]=i.useState({recEditors:[],recViewers:[],recGroupEditors:[],recGroupViewers:[]});s.current.defaultPrivacyOpts=c;const m=i.useCallback((l={})=>{const f=we(a,s.current.defaultPrivacyOpts),v={...l,...f};return t.beforeSave?t.beforeSave(v):v},[a,t]),h=i.useCallback(l=>{u.current.open(l.currentTarget)},[]),j=i.useMemo(()=>{let l="";return a.recEditors.length>0&&(l=`Me and ${a.recEditors.length} users`),l||s.current.defaultPrivacyOpts.label||ve},[a]),y=i.useCallback(l=>{console.log(">>BeForm/withAuth::","ids",l),n(f=>({...f,recEditors:l,recViewers:[],recGroupEditors:[],recGroupViewers:[]}))},[]);console.log(">>BeForm/withAuth::","privacy",a);const g=i.useMemo(()=>{const l={...t.names};for(const f in a)l[f]=void 0;return l},[JSON.stringify([Object.keys(t.names||{}),Object.keys(a)])]);return console.log(">>BeForm/withAuth::","names",g),e.jsx(R.Provider,{value:{privacy:a,setPrivacy:n},children:e.jsx(r,{...t,beforeSave:m,names:g,footer:e.jsxs(e.Fragment,{children:[o,e.jsxs(d,{mt:1,children:[e.jsx(B,{}),e.jsxs(d,{pt:3,pb:2,children:[e.jsx(ke,{}),e.jsx(S.Consumer,{children:({state:l})=>e.jsxs(e.Fragment,{children:[e.jsx(C,{variant:"caption",className:"lbl",children:"Privacy:"}),e.jsx(d,{component:"span",mr:1}),e.jsxs(w,{onClick:h,disabled:l.readOnly,children:[j," can access"]})]})})]}),e.jsxs(M,{ref:u,anchorOrigin:{vertical:"top",horizontal:"left"},transformOrigin:{vertical:"bottom",horizontal:"left"},children:[e.jsxs($,{children:[I(t.name)," Privacy"]}),e.jsx(z,{children:e.jsx(Se,{ids:[...a.recEditors,...a.recViewers],onChange:y})})]})]})]})})})}}function we(r,c){let o=!0;for(const s in r)if(r[s].length>0){o=!1;break}let t=r;if(o){const{editors:s=[],viewers:u=[],groupEditors:p=[],groupViewers:a=[]}=c;t={recEditors:s,recViewers:u,recGroupEditors:p,recGroupViewers:a}}return t}function ke(){const{setPrivacy:r}=i.useContext(R),{data:c}=i.useContext(S);return i.useEffect(()=>{c!=null&&c.id&&r(o=>{const t={...o};for(const s in o){if(!c[s])return;t[s]=c[s]}return t})},[c,r]),null}function Se({onChange:r,ids:c}){const[o,t]=i.useState({users:Object.fromEntries(c.map(n=>[n,null])),selectedUser:null});i.useEffect(()=>{r(Object.keys(o.users))},[r,o.users]);const s=i.useCallback((n,m)=>{const h=m==null?void 0:m._source;h!=null&&h.id&&t(j=>({...j,selectedUser:h}))},[]),u=i.useCallback(()=>{t(n=>({...n,users:{...n.users,[n.selectedUser.id]:n.selectedUser}}))},[]),{globalState:{authUser:p}}=V();console.log(">>BeForm/withAuth::","UserCard",o);const a=pe([p.id,...Object.keys(o.users)]);return e.jsx(e.Fragment,{children:e.jsxs(d,{pb:2,minWidth:"350px",children:[e.jsx(B,{}),a.length>0&&e.jsx(C,{variant:"caption",children:"Users can access:"}),a.map(n=>e.jsxs(d,{display:"flex",children:[e.jsx(d,{flex:"1",mt:2,children:e.jsx(he,{id:n,data:o.users[n]})}),n!==p.id&&e.jsx(w,{onClick:()=>{t(m=>{const h={...m.users};return delete h[n],{...m,users:h}})},children:"✖"})]},n)),e.jsxs(d,{display:"flex",mt:3,children:[e.jsx(d,{flex:"1",children:e.jsx(Q,{model:"User",label:"Select User",fullWidth:!0,onChange:s})}),e.jsx(w,{disabled:!o.selectedUser,onClick:u,children:"➕"})]})]})})}const Fe=Ie(me(K)),Ne=()=>e.jsx("svg",{width:"13",height:"14",viewBox:"0 0 13 14",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M11.5 8.875V2H1.5V12H8.375V10.125C8.375 9.43464 8.93464 8.875 9.625 8.875H11.5ZM11.2411 10.125H9.625V11.7411L11.2411 10.125ZM1.5 13.25C0.809644 13.25 0.25 12.6904 0.25 12V2C0.25 1.30964 0.809644 0.75 1.5 0.75H11.5C12.1904 0.75 12.75 1.30964 12.75 2V10.3839L9.88388 13.25H1.5ZM3.375 10.125V8.875H7.125V10.125H3.375ZM3.375 7.625V6.375H9.625V7.625H3.375ZM3.375 5.125V3.875H9.625V5.125H3.375Z",fill:"white"})}),H=["Contact","Sprint","Company","Location",{model:"User",connectionName:"noteTeamMemberId"},"Project","Opportunity","Task"],Te=({...r})=>{const c=O(),[o]=E({projectId:k}),t=r.id,s=new Date,u=String(s.getDate()).padStart(2,"0"),p=String(s.getMonth()+1).padStart(2,"0"),n=s.getFullYear()+"-"+p+"-"+u,m={...n&&{when:n}};H.forEach(y=>{const g=y.model||y,l=`${xe(g)}Id`;if(c[l]){const f=y.connectionName||`note${g}Id`;m[f]=c[l]}});const j=je().getData();return j&&Object.assign(m,j),console.log(">>NoteLFist/NoteForm::","initialValues",m),e.jsx(d,{children:e.jsx(Fe,{title:"Note",cancelStartIcon:e.jsx(fe,{}),saveStartIcon:e.jsx(Ne,{}),beforeSave:({when:y,...g})=>{const l=(o==null?void 0:o.projectId)??null;if(y){const f={...g,when:new Date(y)};return(l||t)&&(f.noteProjectId=l),f}},name:"note",initialValues:m,withUrls:!0,...r,children:e.jsx(Ve,{})})})},Pe=D(r=>({chip:{backgroundColor:"#FFD9B7"},subject:{"& .MuiTypography-root":{color:r.palette.primary.dark}}}));function Ve(){const r=Pe(),{state:{readOnly:c}}=i.useContext(S);ye(["when","type","urls"]);const[o]=Z(["kwNoteTypes"]),{values:t={}}=A(),s=i.useMemo(()=>{const p=q();return H.map(a=>{const n=a.model||a,m=a.connectionName||`note${n}Id`,h=L(p,["MODELS",n,"labelComponent"]);return h?e.jsx(Be,{label:n,field:m,Component:h},n):null})},[]),u=i.useMemo(()=>((o==null?void 0:o.kwNoteTypes)||[]).map(a=>({value:a,label:I(a.toLowerCase())})),[o]);return e.jsxs(e.Fragment,{children:[s,e.jsx("div",{className:r.subject,children:e.jsx(N,{fullWidth:!0,fieldName:"subject"})}),!c&&e.jsxs(d,{style:{display:"grid",gridTemplateColumns:"repeat(2, auto)",gridColumnGap:5},children:[e.jsx(de,{name:"type",options:u}),e.jsx(ue,{type:"date",fullWidth:!0,name:"when",label:"Date",format:p=>p&&T(new Date(p),"MMM dd, yyyy")})]}),e.jsx(N,{fullWidth:!0,fieldName:"details",multiline:!0,rows:3}),c&&e.jsxs(d,{display:"flex",justifyContent:"space-between",children:[t.type?e.jsx(U,{className:r.chip,label:I(t.type),size:"small"}):e.jsx("div",{}),e.jsx(d,{color:"#9BA8B6",children:t.when&&T(new Date(t.when),"MMM dd, yyyy")})]})]})}function Be({label:r,field:c,Component:o}){const{values:t={}}=A(),s=t[c];return!s||!o?null:e.jsx(Y,{text:r,children:e.jsx(i.Suspense,{fallback:e.jsx("div",{}),children:e.jsx(o,{id:s})})})}const Me=D({root:{display:"grid",gridRowGap:10,backgroundColor:"#FFF0D0",maxHeight:300,padding:20,width:350,cursor:"pointer"},chip:{backgroundColor:"#FFD9B7"}});function De({note:r,onClick:c}){const o=Me();return e.jsxs(J,{className:o.root,onClick:c,children:[e.jsx(C,{style:{display:"flex"},children:r.noteCompanyId?e.jsx(ge,{id:r.noteCompanyId}):""}),e.jsx(C,{style:{fontWeight:"bold"},children:r.subject}),e.jsx(C,{variant:"body2",component:"p",style:{color:"#697D92",maxHeight:140,overflowY:"auto",fontSize:13},children:r.details}),e.jsxs(d,{style:{display:"grid",gridTemplateColumns:"repeat(2, auto)",justifyContent:"space-between",alignItems:"center",gridColumnGap:10},children:[r.type&&e.jsx(U,{label:I(r.type),size:"small",className:o.chip}),e.jsx(C,{variant:"body2",component:"p",style:{color:"#9BA8B6",fontSize:12},children:r.createdAt&&X(new Date(r.createdAt),new Date,{addSuffix:!0})})]})]},r.id)}const Ee=ee`
  query ($filter: SearchableNoteFilterInput, $nextToken: String) {
    searchNotes(
      filter: $filter
      nextToken: $nextToken
      limit: 10
      sort: { field: createdAt, direction: desc }
    ) {
      nextToken
      items {
        urls
        id
        subject
        details
        when
        type
        createdAt
        noteCompanyId
      }
    }
  }
`,P={contactId:"noteContactId",sprintId:"noteSprintId",companyId:"noteCompanyId",locationId:"noteLocationId",userId:"noteTeamMemberId",projectId:"noteProjectId",opportunityId:"noteOpportunityId",taskId:"noteTaskId",jobId:"noteProjectId",propertyId:"noteProjectId"},vt=({showButton:r=!0,paperContainer:c=!1})=>{const o=O(),[t,s]=E({noteId:k,searchText:k}),u=i.useRef(null),p=Ce({model:"Note",keyword:t.searchText}),a={archived:{ne:!0}};for(const x in P){const b=o[x];!b||[null,void 0,"null"].includes(b)||(a[P[x]]={eq:b})}t.searchText&&te(a,"or.0",{or:[{subject:{matchPhrasePrefix:t.searchText}},{details:{matchPhrasePrefix:t.searchText}},...(p||[]).map(x=>({id:{eq:x.id}}))]});const n=re(Ee,{variables:{filter:a},fetchPolicy:"network-only",nextFetchPolicy:"cache-first"}),m=be({...n,model:"Note",op:"search",maxLength:5}),{data:h,refetch:j}=n,y=L(h,"searchNotes.items",[]);i.useEffect(()=>{t.noteId&&(s({noteId:t.noteId}),u.current.open())},[t.noteId,s]);const g=x=>{s({noteId:x}),u.current.open()},l=i.useCallback(()=>{s({noteId:void 0}),u.current.close(),j()},[j,s]),f=le(x=>{const b=x.target.value;s({searchText:b})},800),v=c?Ae:i.Fragment,{TextFieldClear:W,ClearVisibilityRuleSx:_,isValueUndefined:G}=ce(),F=i.useRef();return e.jsxs(d,{sx:{marginTop:"0px"},children:[e.jsxs(d,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:3},children:[e.jsx(C,{variant:"h1",sx:{textTransform:"uppercase",fontSize:20,fontWeight:"bold"},children:"Notes"}),e.jsx(e.Fragment,{children:r&&e.jsx(w,{color:"primary",variant:"contained",sx:{height:"38px"},onClick:()=>{u.current.toggle(),s({noteId:void 0})},children:"Add Note ➕"})})]}),e.jsx(M,{variant:"dialog",ref:u,dialogProps:{maxWidth:"sm",fullWidth:!0,scroll:"body"},children:e.jsx(Te,{id:t.noteId,onSubmit:l,onDelete:l,onCancel:()=>{s({noteId:void 0}),u.current.close()},defaultPrivacyOpts:{groupEditors:["admin","crm.note.*","crm.note.update","crm.note.read"],groupViewers:["admin","crm.note.*","crm.note.read"]}})}),e.jsx(d,{pr:1,mb:2,mt:1,display:"flex",justifyContent:"space-between",alignItems:"center",children:e.jsx("div",{children:e.jsx(se,{children:e.jsx(oe,{value:t.searchText,label:"Text",onChange:f,textFieldProps:{endAdornment:G(t==null?void 0:t.searchText)?void 0:e.jsx(W,{clearFn:()=>{s({searchText:""}),F.current.value=""}}),sx:_,inputProps:{ref:F}}})})})}),e.jsxs(v,{children:[n.loading?e.jsx(ne,{}):e.jsx(d,{style:{margin:10,display:"grid",gridGap:"1rem",gridTemplateColumns:"repeat(auto-fit, minmax(350px, auto))",justifyContent:"start"},children:y.map(x=>e.jsx(De,{note:x,onClick:()=>{g(x.id)}},x.id))}),!n.loading&&e.jsx(ae,{onClick:m.more})]})]})};function Ae({children:r}){return e.jsx(ie,{children:e.jsx(d,{p:2,children:r})})}export{vt as default};
