import{j as e}from"./TransitionGroupContext-9d36972e.js";import{r as D,R as m}from"./index-f1f749bf.js";import{P as Lt}from"./index-79afbab1.js";import{g as A}from"./_baseForOwn-9b89c4b6.js";import{F as se,B as k,a8 as Pt,T as R,X as F,i as B,Y as ne,G as le,f as ce,K as Mt,bZ as At,d8 as _t,d9 as Nt,b as Rt,ci as Ft,m as K,aC as Ze,c5 as zt,a3 as Ht,L as Gt,ad as Fe,aP as ke,bC as $t,ax as Je,V as Xe,da as Kt,db as Vt,a2 as pe,S as Ut,M as Bt,v as de,W,w as z,b1 as et,u as je,dc as Wt,ah as Se,ai as X,aj as ee,dd as tt,aw as st,g as nt,a4 as qt,l as Yt,de as ze,z as fe,ac as Qt,C as Zt,A as Jt,h as at,df as Xt,k as es,dg as ts,D as ss,ct as ns,dh as as,di as rs}from"./papaparse.min-b66e70e7.js";import{u as os}from"./TaskAssignees-858ea3c9.js";import{b as Y,f as q,u as G,w as rt,l as $,i as oe}from"./index-bcfaa842.js";import{d as ot}from"./Check-78df5e8e.js";import{K as is,N as ve,d as He,B as Te,b as ye,at as ls,a9 as it,i as cs,g as Ge,o as ds,a7 as us,T as gs,p as lt,R as hs,L as te,j as fs,G as ms,ar as xs,a5 as ps,aa as js,ab as ys}from"./Play-87fed129.js";import{S as ks}from"./Skeleton-cd6f071e.js";import{u as Ss}from"./useFetchMore-be228481.js";import{s as ct,D as vs,R as Ts}from"./bundle-053bdffd.js";import{a as dt,u as be,D as ut,H as gt,M as bs}from"./MilestoneIcon-61fb6e69.js";import{d as ht}from"./debounce-213cd46f.js";import{a as ws,S as Cs,d as Is,E as Es}from"./SortUpIcon-3aecf5f0.js";import{a as Ds,d as Os}from"./DragIndicator-582939ba.js";import{c as ft}from"./capitalize-c31f38e2.js";import{p as Ls}from"./_arrayIncludes-2cfb33ae.js";import{T as Ps}from"./Trash-822e65ce.js";import{a as Ms,c as As}from"./index.esm-bf21a293.js";import{F as $e}from"./index-f70ce446.js";import{u as _s}from"./index-5d349c56.js";import{B as U}from"./Button-352c3435.js";import{i as Ns,j as Rs,G as Fs,m as zs}from"./pick-dba65392.js";import{T as Hs}from"./TaskForm-863cdb73.js";import{d as Gs}from"./Add-be7f5660.js";import{S as mt,u as xt,E as $s}from"./EstimateEditorPopover-b8debf9a.js";import Ks from"./AssigneeEditorPopover-2b4e6473.js";import{u as Vs}from"./useTaskAssignees-9f1fd5d3.js";import{U as Us}from"./filter-f99df4e5.js";import{s as Bs}from"./searchUsers-04324aeb.js";import{T as Ws,a as Ke}from"./ToggleButtonGroup-93d9af56.js";function qs(t){return e.jsx(se,{...t,width:"11px",height:"15px",viewBox:"0 0 11 15",paths:["M3.62461 9.375H0.449219L7.37461 0.718258V5.625H10.55L3.62461 14.2817V9.375ZM3.05 8.125H4.87461V10.7183L7.94922 6.875H6.12461V4.28173L3.05 8.125Z"]})}const Ys=({id:t,iconOnly:s,...n})=>{const[a,{loading:r}]=is(t,{fetchPolicy:"network-only"}),[d,o]=D.useState(!1);console.log("TaskSetInvoiceDateButton",{task:a});const{enqueueSnackbar:c}=Y(),[l,{loading:i}]=ve({variables:{input:{id:t}},onCompleted:()=>{c(a.invoiceSetting.invoiceDate?"Task has been unmarked":"Task marked as invoiced",{variant:"success"})},onError:p=>{console.log(p),c("Failed to mark as invoiced",{variant:"error"})}}),u=D.useMemo(()=>({...a==null?void 0:a.invoiceSetting}),[a==null?void 0:a.invoiceSetting]),f=D.useMemo(()=>(u==null?void 0:u.invoiceDate)&&q(new Date(u==null?void 0:u.invoiceDate),"PPp"),[u==null?void 0:u.invoiceDate]);console.log({invoiceSetting:u,task:a});const g=D.useCallback(()=>{if(r||i)return;const{invoiceDate:p}=u,T=JSON.stringify({invoiceDate:p?null:+new Date});l({variables:{input:{id:t,invoiceSetting:T}}}),o(!1)},[t,u,r,i,l]);return r?e.jsx(k,{children:"Loading..."}):s&&!r&&f?e.jsx(He,{color:"success"}):s?null:e.jsxs(e.Fragment,{children:[e.jsxs(U,{variant:"outlined",color:f?"success":"primary",disabled:r||i,onClick:f?()=>o(!0):g,...n,children:[!r&&f||"Mark as Invoiced",!r&&f&&e.jsx(He,{})]}),e.jsxs(Pt,{disableEscapeKeyDown:!0,maxWidth:"sm",onClose:()=>o(!1),scroll:"body",open:d,children:[e.jsx(k,{m:2,children:e.jsx(R,{children:"Are you sure you want to unmark this task?"})}),e.jsxs(k,{m:2,display:"flex",flexDirection:"row",justifyContent:"flex-end",children:[e.jsx(U,{onClick:()=>o(!1),children:"Cancel"}),e.jsx(U,{onClick:g,children:"Confirm"})]})]})]})};function Qs({users:t,hideName:s,assigneeAvatars:n,...a}){const r=A(t,"0.user");if(!r)return null;const d={};for(const l of t){const i=A(l,"user.fullname");d[i]=!0}const o=Object.keys(d),c=o.length-1;return e.jsxs(e.Fragment,{children:[!n&&e.jsx(F,{title:o.join(", "),children:e.jsx(Te,{badgeContent:c>0?`+${c}`:0,color:"secondary",children:e.jsx(ye,{compact:!0,member:r,disableTooltip:!0,hideName:s,...a})})}),n&&e.jsx(e.Fragment,{children:t.map((l,i)=>e.jsx(ye,{compact:!0,member:l.user,disableTooltip:!0,hideName:s,...a},i))})]})}function Zs(t){var l;const{task:s,hideName:n,assigneeAvatars:a}=t,r=m.useRef(null),[d,o]=m.useState({showEdit:!1,openPopover:!1}),c=((l=s==null?void 0:s.userAssignments)==null?void 0:l.items)||[];return e.jsxs(e.Fragment,{children:[e.jsxs(k,{ref:r,display:"flex",justifyContent:"space-between",alignItems:"center",onMouseEnter:()=>{o(i=>({...i,showEdit:!0}))},onMouseLeave:()=>{o(i=>({...i,showEdit:!1}))},children:[c.length?e.jsx(Qs,{users:c,hideName:n,assigneeAvatars:a}):e.jsx(k,{sx:{fontSize:"smaller",opacity:.5},children:"No Assignees"}),e.jsx(F,{title:"Set Assignees",children:e.jsx(B,{size:"small",sx:{visibility:d.showEdit?"visible":"hidden",border:"dashed 1.7px lightgrey"},onClick:()=>{o(i=>({...i,openPopover:!0}))},children:e.jsx(ls,{})})})]}),e.jsx(Ks,{taskId:s.id,anchorOrigin:{vertical:"bottom",horizontal:"left"},anchorEl:r.current,open:d.openPopover,onClose:()=>{o(i=>({...i,openPopover:!1}))}})]})}function Js({status:t,taskCellColor:s}){const n=(t||"").toLowerCase(),a={fontSize:"smaller",color:r=>{switch(n){case"complete":case"finished":case"completed":return r.palette.success.main;default:return r.palette.info.main}},...s?{display:"flex",py:"2px",px:"1px",backgroundColor:"#47ed8c",borderRadius:"12px",color:"white",justifyContent:"center",width:"50px"}:{}};return e.jsx(k,{sx:a,children:s?(t||"").charAt(0).toUpperCase():ft(n)})}const we={cursor:"pointer","&:hover":{backgroundColor:"lightgrey",borderRadius:"5px"}};function Xs(t){const{taskId:s,status:n,...a}=t,r=xt({id:s,fieldName:"status",model:"Task"}),[d]=ne(["kwTaskStatusList"]);return e.jsx(mt,{...a,editor:{label:"Status",value:n||null,async onSave(o){var c;await r.save(o),(c=t.onClose)==null||c.call(t,{},"backdropClick")},renderEditor(o){return e.jsx(k,{width:"200px",children:e.jsx(le,{fullWidth:!0,value:o.value,label:o.label,options:(d==null?void 0:d.kwTaskStatusList)||[],onChange:c=>{const l=c.currentTarget.value;o.onChange(c,l)},onKeyDown:c=>{c.key==="Enter"&&o.onSubmit()}})})}}})}function en(t,s){const{task:n}=t,a=m.useRef(null),[r,d]=m.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsx(F,{title:s?t.task.status:"Set status",children:e.jsx(k,{ref:a,sx:{...we,...s?{width:"50px"}:{}},onClick:()=>{d(!0)},children:e.jsx(Js,{status:t.task.status,taskCellColor:s})})}),e.jsx(Xs,{taskId:n.id,status:n.status||null,anchorOrigin:{vertical:"bottom",horizontal:"left"},anchorEl:a.current,open:r,onClose:()=>{d(!1)}})]})}function tn(t){const{taskId:s,dueDate:n,...a}=t,r=xt({id:s,fieldName:"due",model:"Task"});return e.jsx(mt,{...a,editor:{label:"Due Date",value:n,async onSave(d){var o;await r.save(d),(o=t.onClose)==null||o.call(t,{},"backdropClick")},renderEditor(d){return e.jsx(k,{width:"200px",children:e.jsx(it,{label:d.label,value:d.value,onChange:o=>d.onChange({},o==null?void 0:o.toISOString())})})}}})}function sn(t){const{task:s}=t,n=m.useRef(null),[a,r]=m.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsx(F,{title:"Due Date",children:e.jsx(k,{ref:n,sx:we,onClick:()=>{r(!0)},children:e.jsxs(R,{sx:{fontSize:11,display:"flex",opacity:.7,"& svg":{height:15}},children:[e.jsx(qs,{}),(s==null?void 0:s.due)&&q(new Date(s.due),"LLL dd, yyyy")]})})}),e.jsx(tn,{taskId:s.id,dueDate:s.due,anchorOrigin:{vertical:"bottom",horizontal:"left"},anchorEl:n.current,open:a,onClose:()=>{r(!1)}})]})}function nn({value:t,label:s,onChange:n,icon:a}){const r=ce({key:"TASK_STATUS_Q",index:"task",body:{size:0,aggs:{distinct_status:{terms:{field:"status.keyword"}}}}}),d=[{value:"OPEN",text:"OPEN"},...A(r,"result.aggregations.distinct_status.buckets",[]).map(f=>({value:f.key,text:f.key}))],[o]=ne(["kwTaskStatusList"]),c=m.useMemo(()=>{var f;return(f=o==null?void 0:o.kwTaskStatusList)==null?void 0:f.map(g=>{var p;return{value:(p=g==null?void 0:g.toLowerCase())==null?void 0:p.trim(),label:g}})},[o==null?void 0:o.kwTaskStatusList]),i=G("TASK_STATUS_PROGRESS")?c:d,u=m.useCallback(f=>{const g=f.currentTarget.value;n&&n(g)},[n]);return e.jsx(le,{fullWidth:!0,shrinkLabel:!0,value:t,variant:"default",options:i,label:s,onChange:u,icon:a})}function an({value:t,onChange:s,icon:n}){const a=m.useCallback(r=>{const d=r.currentTarget.value;s(d)},[s]);return e.jsx(Mt,{value:t,shrinkLabel:!0,variant:"default",label:"Assignee",model:"User",fullWidth:!0,onChange:a,query:Ns,icon:n})}function rn({value:t,onChange:s,icon:n}){const[a]=ne(["kwTaskTypeList"]),r=m.useCallback(d=>{const o=d.currentTarget.value;s&&s(o)},[s]);return e.jsx(le,{fullWidth:!0,shrinkLabel:!0,value:t,variant:"default",options:a==null?void 0:a.kwTaskTypeList,label:"Type",onChange:r,icon:n})}function on({task:t}){const[s,n]=m.useState(null);return m.useEffect(()=>{t!=null&&t.sourceUrl&&t.sourceUrl.startsWith("https://github.com")&&n(t.sourceUrl)},[t]),s?e.jsx("a",{href:s,target:"_blank",children:e.jsx(F,{title:"Open Github",children:e.jsx(B,{size:"small",children:e.jsx(Ds,{})})})}):null}function ln(t){return e.jsx(se,{...t,width:"34",height:"34",viewBox:"0 0 34 34",paths:["M17.0001 32.5833C8.39364 32.5833 1.41675 25.6064 1.41675 17C1.41675 8.39356 8.39364 1.41667 17.0001 1.41667C25.6065 1.41667 32.5834 8.39356 32.5834 17C32.5834 25.6064 25.6065 32.5833 17.0001 32.5833ZM17.0001 29.75C24.0417 29.75 29.7501 24.0416 29.7501 17C29.7501 9.95837 24.0417 4.25 17.0001 4.25C9.95845 4.25 4.25008 9.95837 4.25008 17C4.25008 24.0416 9.95845 29.75 17.0001 29.75ZM11.3334 24.0833V9.91667C11.3334 8.80397 12.5573 8.12561 13.5009 8.71534L24.8342 15.7987C25.722 16.3535 25.722 17.6465 24.8342 18.2013L13.5009 25.2847C12.5573 25.8744 11.3334 25.196 11.3334 24.0833ZM21.4105 17L14.1667 12.4727V21.5273L21.4105 17Z"]})}function cn({task:t,taskId:s,projectId:n}){const[a,r]=m.useState({loading:!1}),{startCurrentInterval:d}=m.useContext(At),{enqueueSnackbar:o}=Y(),c=m.useCallback(async()=>{t!=null&&t.estimatedEffort||o("Please set an Estimated Effort on your current interval.",{variant:"warning"}),r(l=>({...l,loading:!0})),await d({targetId:s,targetType:"task"}),r(l=>({...l,loading:!1}))},[d,s,t,n]);return e.jsx(F,{title:"Start Interval",children:e.jsx(B,{disabled:a.loading,size:"small",onClick:c,children:e.jsx(ln,{gradient:!0})})})}var dn=Math.floor,un=Math.random;function gn(t,s){return t+dn(un()*(s-t+1))}var hn=gn,fn=hn,mn=_t,Ve=Nt,xn=parseFloat,pn=Math.min,jn=Math.random;function yn(t,s,n){if(n&&typeof n!="boolean"&&mn(t,s,n)&&(s=n=void 0),n===void 0&&(typeof s=="boolean"?(n=s,s=void 0):typeof t=="boolean"&&(n=t,t=void 0)),t===void 0&&s===void 0?(t=0,s=1):(t=Ve(t),s===void 0?(s=t,t=0):s=Ve(s)),t>s){var a=t;t=s,s=a}if(n||t%1||s%1){var r=jn();return pn(t+r*(s-t+xn("1e-"+((r+"").length-1))),s)}return fn(t,s)}var kn=yn;const Sn=kn,vn=K({root:t=>({padding:10,minHeight:t.cardMinHeight,justifyContent:"space-between",alignItems:"baseline",cursor:"pointer"}),itemBorder:()=>({border:"1px solid #1AE970 !important"})});function Tn({data:t}){const[s,n]=m.useState({appear:!1}),{CardComponent:a,onCardClick:r,cardDragOptions:d,cardMinHeight:o}=m.useContext(Ce),c=vn({cardMinHeight:o}),[,l]=dt(d(t));m.useEffect(()=>{Rt.delay(Sn(0,800)).then(()=>{n(g=>({...g,appear:!0}))})},[]);const i=m.useCallback(()=>{r&&r(t)},[t,r]),u=g=>e.jsx(Ze,{className:g,ref:l,onClick:i,children:a?e.jsx(a,{data:t}):e.jsx("div",{children:".."})}),f=window.localStorage.getItem("latestOppUpdated");return e.jsx(Ft,{in:s.appear,children:(t==null?void 0:t.id)!==f?u(c.root):u(`${c.root} ${c.itemBorder}`)})}const bn=(t,s="0px")=>{const[n,a]=D.useState(!1);return D.useEffect(()=>{const r=new IntersectionObserver(([o])=>{a(o.isIntersecting)},{rootMargin:s}),d=t==null?void 0:t.current;return d&&r.observe(d),()=>{r.unobserve(d)}},[]),n};var V=(t=>(t.Blue="#12C7FA",t.Yellow="#FF9F4B",t.LightYellow="#FFC493",t.Pink="#FB4189",t.LightPink="#FDA0C4",t.Green="#1AE970",t))(V||{});function wn({name:t,total:s,color:n,children:a}){return e.jsxs(k,{sx:{backgroundColor:"#fff",boxShadow:`1px 0px 0px #E9ECF2, inset 0px -3px 0px ${n}`,borderRadius:"8px",padding:"15px"},children:[e.jsx(k,{children:e.jsxs(k,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(R,{sx:{fontWeight:"bold",fontSize:"15px",textTransform:"uppercase",color:"#052649",letterSpacing:"0.75px",marginTop:"2px"},children:t}),e.jsx(k,{sx:{backgroundColor:"#052649",padding:"3px 4px",borderRadius:"6px",color:"#fff",fontSize:"12px",lineHeight:"18px",marginLeft:"8px",minWidth:"24px",textAlign:"center"},children:s})]})}),a]})}const Cn=()=>{const[t,s]=cs(zt),{loading:n}=s,[a,r]=D.useState();return D.useEffect(()=>{var c;if(n||!t)return;const o=(c=t==null?void 0:t.value)==null?void 0:c.stages;r(()=>Object.fromEntries((o==null?void 0:o.map(l=>{var i;return[(i=l==null?void 0:l.name)==null?void 0:i.toLowerCase(),l]}))??[]))},[n,t]),[D.useMemo(()=>Object.values(a??{})??[],[a]),{stagesMap:a,setStagesMap:r},t,s]},In=t=>{const[,{stagesMap:s}]=Cn();return[D.useMemo(()=>s==null?void 0:s[t==null?void 0:t.toLowerCase()],[t,s])]},ie=400,Ue=10,En=K({root:{display:"grid",backgroundColor:"#dbe0e6",borderRadius:12,minWidth:"313px"},bodyContentOver:{overflowY:"auto",display:"grid",gridRowGap:10},bodyContent:t=>({height:`${t.laneHeight||ie}px`,overflowY:"auto","& > *":{marginBottom:15}}),title:{fontWeight:"bold",fontSize:13,textTransform:"uppercase"},body:{padding:15,paddingTop:20,paddingBottom:20},onTop:{display:"grid",justifyContent:"center",alignContent:"center"}}),Dn=(t,s)=>rt.numberFormatter(ct(t,n=>((n==null?void 0:n.estimatedValue)||0)*s)).toRounded();function On(t){const{id:s,title:n,data:a=[],total:r,type:d}=t,[o,c]=m.useState({currentLength:Ue}),{cardDropOptions:l,laneHeight:i}=m.useContext(Ce),u=En({laneHeight:i}),[{isOver:f,canDrop:g},p]=be(l(s,a)),T=m.useMemo(()=>a.slice(0,o.currentLength),[a,o.currentLength]),S={lead:V.Blue,contacted:V.Yellow,qualified:V.LightPink,proposed:V.Pink,validated:V.LightYellow,won:V.Green},[b]=In(n),v=D.useMemo(()=>{if(!(!a||!b))return Dn(a,b==null?void 0:b.rate)},[a,b]),h=D.useMemo(()=>rt.numberFormatter(ct(a,"estimatedValue")).toCurrency(),[a]);return e.jsx("div",{className:u.root,ref:p,children:e.jsxs(k,{className:u.body,children:[e.jsx(k,{sx:{marginBottom:"15px"},children:e.jsx(wn,{name:n,total:r,color:S[n],children:d==="sales"&&e.jsxs(k,{sx:{marginTop:"8.5px",display:"flex",justifyContent:"space-between"},children:[e.jsxs(k,{children:[e.jsx(R,{sx:{fontSize:"12px",color:"#9BA8B6",letterSpacing:"0.25px",lineHeight:"1.5"},children:"Total Value"}),e.jsx(R,{sx:{fontSize:"14px",color:"#052649",letterSpacing:"0.5px",fontWeight:"500",lineHeight:"1.5"},children:h})]}),e.jsxs(k,{children:[e.jsx(R,{sx:{fontSize:"12px",color:"#9BA8B6",letterSpacing:"0.25px",lineHeight:"1.5"},children:"Total Weighted Value"}),e.jsx(R,{sx:{fontSize:"14px",color:"#052649",letterSpacing:"0.5px",fontWeight:"500",lineHeight:"1.5"},children:`$${v!==void 0?v:0}`})]})]})})}),f&&g?e.jsx(k,{className:u.bodyContentOver,children:e.jsx(Ze,{className:u.onTop,children:e.jsx(R,{children:e.jsx(Gs,{fontSize:"large"})})})}):e.jsxs(k,{className:u.bodyContent,children:[T==null?void 0:T.map((y,C)=>e.jsx(Tn,{data:y},C)),T.length<a.length&&e.jsx(Ln,{onVisible:()=>{c(y=>({...y,currentLength:y.currentLength+Ue}))}})]})]})})}function Ln(t){const s=m.useRef(null),n=bn(s);return m.useEffect(()=>{t.onVisible()},[n]),e.jsx("div",{ref:s,children:e.jsx(Ht,{})})}const Ce=m.createContext({}),Pn=K({root:t=>({display:"grid",paddingTop:20,gridTemplateColumns:`repeat(${t.cols}, 1fr)`,gridColumnGap:10,marginBottom:15,overflowX:"auto",width:"1625px"})});function Mn(t){const{data:s,context:n,cardMinHeight:a=100,CardComponent:r,onCardClick:d,boards:o=[],type:c}=t,l=m.useRef(null),i=m.useRef(null),[u,f]=m.useState({containerWidth:null,laneHeight:null}),g=Pn({cols:o.length,width:u.containerWidth});return m.useLayoutEffect(()=>{const p=l.current;if(!p)return;const T=p.offsetWidth;T>0&&f(S=>({...S,containerWidth:T}))},[]),m.useLayoutEffect(()=>{const p=i.current;if(!p||!u.containerWidth)return;const T=window.innerHeight-p.offsetTop;let S=ie+T-30;S<ie&&(S=ie),f(b=>({...b,laneHeight:S}))},[u.containerWidth]),e.jsxs(Ce.Provider,{value:{...n,CardComponent:r,onCardClick:d,cardDragOptions:t.cardDragOptions||_n,cardDropOptions:t.cardDropOptions||An,cardMinHeight:a,laneHeight:u.laneHeight},children:[e.jsx("div",{ref:l,className:g.root,children:u.containerWidth&&u.containerWidth>0&&e.jsx(ut,{backend:gt,children:o.map(p=>{const T=s==null?void 0:s.filter(p.filter).length;return e.jsx(On,{id:p.key,title:p.label||p.key,total:T,data:s==null?void 0:s.filter(p.filter),type:c},p.key)})})}),e.jsx("div",{ref:i})]})}const An=()=>({accept:"NONE"}),_n=()=>({canDrag:!1,type:"-"});function Nn(t){const s=m.useRef(null),{task:n}=t,[a,r]=m.useState(!1);let d=null;return t.allocationInfo?d=e.jsx(e.Fragment,{children:t.allocationInfo}):d=e.jsx(e.Fragment,{children:isNaN(n.estimatedEffort||"-")?e.jsx(k,{component:"span",sx:{fontSize:"smaller",color:"warning.main"},children:"No estimate"}):`${n.estimatedEffort} h`}),e.jsxs(e.Fragment,{children:[e.jsx(F,{title:"Set estimate",children:e.jsx(k,{ref:s,sx:we,onClick:()=>{r(!0)},children:d})}),e.jsx($s,{taskId:n.id,estimatedEffort:n.estimatedEffort,anchorOrigin:{vertical:"bottom",horizontal:"left"},anchorEl:s.current,open:a,onClose:()=>{r(!1)}})]})}const Rn=K({title:{marginTop:15,fontSize:15,display:"flex",alignItems:"center","& svg":{marginRight:10,opacity:.4,height:16}},project:{fontSize:15,display:"flex",alignItems:"center","& svg":{marginLeft:"-5px",marginRight:"5px",height:16}},client:{marginTop:15,fontSize:15,display:"flex",alignItems:"center","& svg":{marginRight:10,height:17}}});function Fn(t){var c,l,i,u,f,g;const{task:s,withTitle:n=!0,withProject:a=!0,withStatus:r=!0,withEstimate:d}=t,o=Rn();return console.log(">>TaskKanban/TaskCard::","task",s),e.jsxs(k,{children:[e.jsxs("div",{children:[a&&e.jsxs(k,{sx:{fontSize:"12px",opacity:.6,textOverflow:"ellipsis",overflow:"hidden","& > a":{whiteSpace:"nowrap"}},children:[e.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"baseline",children:[e.jsx(k,{children:(c=s.project)!=null&&c.name?e.jsx(R,{variant:"h3",className:o.project,children:e.jsxs(Ge,{model:"Project",data:s.project,children:[e.jsx(ds,{}),(l=s.project)==null?void 0:l.name]})}):""}),e.jsx(sn,{task:s})]}),(i=s.opportunity)!=null&&i.name?e.jsx(R,{variant:"h3",className:o.title,children:e.jsxs(Ge,{model:"Opportunity",data:s.opportunity,children:[e.jsx(us,{}),(u=s.opportunity)==null?void 0:u.name]})}):""]}),n&&e.jsx(R,{variant:"h3",className:o.title,children:e.jsx(gs,{data:s})}),e.jsx(k,{mb:1}),(f=s==null?void 0:s.project)!=null&&f.companyId?e.jsx(R,{variant:"h3",className:o.client,children:e.jsx(Rs,{id:(g=s==null?void 0:s.project)==null?void 0:g.companyId,noWrap:!1})}):""]}),d&&e.jsxs(k,{mb:1,display:"flex",justifyContent:"space-between",children:[e.jsxs(Gt,{sx:{},text:"Est Time",children:[s.estimatedEffort||"-"," h"]}),s.priority&&e.jsx(k,{children:s.priority})]}),e.jsx(k,{mb:1}),e.jsx(Zs,{task:s}),e.jsxs(k,{mt:1,sx:{display:"flex",justifyContent:"space-between",alignItems:"end"},children:[e.jsx("div",{children:r&&e.jsx(en,{task:s})}),e.jsx(k,{sx:{fontSize:"smaller",opacity:.6},children:e.jsx(Nn,{task:s,allocationInfo:t.allocationInfo})})]})]})}function zn(t,s){return{key:t,filter:n=>(n.status||"")===t||s&&(!n.status||n.status==="UNKNOWN")}}function Hn({data:t}){const[s]=ve(),n=m.useCallback(o=>({accept:"CARD_ENTRY",collect:c=>{var l,i;return{isOver:!!c.isOver(),canDrop:!!c.canDrop&&((i=(l=c.getItem())==null?void 0:l.item)==null?void 0:i.status)!==o}},drop:async({item:c})=>{if(!c.status||c.status!==o)try{await s({variables:{input:{id:c.id,status:o}}})}catch(l){console.error("cardDropOptions-drop",l)}}}),[s]),a=m.useCallback(o=>({type:"CARD_ENTRY",item:{item:{...o},type:"CARD_ENTRY"},collect:c=>({isDragging:c.isDragging()})}),[]),[r]=ne(["kwTaskStatusList"],{sort:["sortOrder","text"]}),d=r.kwTaskStatusList||[];return e.jsx(Mn,{data:t,boards:d.map((o,c)=>zn(o,c===0)),CardComponent:({data:o})=>e.jsx(Fn,{task:o}),cardDropOptions:n,cardDragOptions:a,cardMinHeight:50})}const Gn="@stage_key@";function $n({filter:t={},stages:s=[],tasks:n,metadata:a,mapping:r}){const d=JSON.parse(JSON.stringify(s));function o(h,y){return`${h}${Gn}${y}`}const c=JSON.parse(a),l=(c==null?void 0:c.taskDurations)||{},{searchText:i="",tgAssignee:u,tgStatus:f}=t,g=i&&new RegExp(i,"gi"),p=[],T=[],S=[];for(const h of d)h.__count=0,Fe(r,["stage",h.id],h),S.push(o(h.name,h.id));for(const h of n){if(h.archived)continue;const y=h.title||"";if(i.startsWith("#")){if(`#${h.code}`!==i)continue}else if(g&&!y.match(g)&&!y.startsWith(i))continue;if(u&&!A(h,"userAssignments.items",[]).some(_=>_.user.id===u)||f&&h.status!==f)continue;const C=l[h.id]||A(r,["task",h.id,"taskDuration"]),E=A(r,["stage",h.taskSprintId]);E&&E.__count++;const N=E?o(E.name,h.taskSprintId):"<NO-GROUP>";let O;C&&(O=Math.round(h.estimatedEffort>0?C/h.estimatedEffort*100:100));const L=A(h,"userAssignments.items[0].user.fullname");p.push({...h,taskDuration:C,stageName:N,progress:O,assignee:L,actualProgress:h==null?void 0:h.progress}),Fe(r,["task",h.id,"taskDuration"],C)}const b=[];for(const h in r.stage){const y=r.stage[h];y.__count===0?p.push({id:h,stage:y,stageName:o(y.name,h),taskSprintId:y.id,_isEmptyPlaceholder:!0}):b.push(o(y.name,y.id))}const v=ke(p,["stage.startDate"],["asc"]);return console.log({orderedTasks:v}),{mapping:r,tasks:v,stages:T,stageKeys:S,nonEmptyStageKeys:b}}function Kn(t){const[s,n]=m.useState({users:null});if(m.useEffect(()=>{const c={};for(const l of t.tasks)for(const i of A(l,"userAssignments.items",[])){if(!i.user)continue;const u=i.user.id;c[u]=i.user}n(l=>({...l,users:Object.values(c)}))},[t.tasks]),console.log("state",s),s.users===null)return e.jsx(ks,{});const a=s.users||[],r={};for(const c of a){const l=A(c,"fullname");r[l]=!0}const d=Object.keys(r);console.log("names",d);const o=d.length-1;return a[0]?e.jsx(F,{title:d.join(", "),children:e.jsx(Te,{badgeContent:o>0?`+${o}`:0,color:"secondary",overlap:"circular",children:e.jsx(ye,{disableTooltip:!0,iconOnly:!0,compact:!0,id:a[0].id})})}):null}const Vn=100,Un=K(t=>({root:{padding:"10px","& div.rdg div.rdg-row.dropping":{backgroundColor:"blue"}},grid:{height:"600px","& > div":{height:"100% !important"},"& .tsuccess":{color:t.palette.success.light},"& .tinfo":{color:t.palette.info.light},"& .twarning":{color:t.palette.warning.light},"& .terror":{color:t.palette.error.light},"& .tactions > *":{marginRight:"10px"},"& .tprogress":{borderRadius:"4px",display:"flex",alignItems:"center"},"& .tprogress > div":{backgroundColor:"#E6E9ED",marginRight:"5px",flex:1,borderRadius:"2px"},"& .tprogress > span":{width:"50px",textAlign:"center",opacity:.7},"& .tprogress.bgsuccess .MuiLinearProgress-bar":{backgroundColor:t.palette.success.light},"& .tprogress.bginfo .MuiLinearProgress-bar":{backgroundColor:t.palette.info.light},"& .tprogress.bgwarning .MuiLinearProgress-bar":{backgroundColor:t.palette.warning.light},"& .tprogress.bgerror .MuiLinearProgress-bar":{backgroundColor:t.palette.error.light},"& .testimate":{display:"flex",alignItems:"center",justifyContent:"center",maxWidth:"120px",marginTop:"11px",height:"25px"},"& .tdue":{borderRadius:"4px"},"& .testimate.bgwarning":{backgroundColor:t.palette.warning.light,color:"white",borderRadius:"15px"},"& .testimate svg":{marginRight:"5px",height:"15px"},"& div.rdg-header-row > div.rdg-cell:nth-child(6)":{textAlign:"center"},"& div.rdg-row span.tcode":{color:"white",backgroundColor:"#697D92",marginRight:"10px",padding:"0 5px",fontSize:"smaller"},"& div.rdg-row span.ttask > svg":{verticalAlign:"middle",marginRight:"5px",color:"#CDD3DB"},"& div.rdg-row > div.rdg-cell:nth-child(2)":{marginLeft:`-${Vn}px`,zIndex:1},"& div.rdg-row div.trow":{textOverflow:"inherit",overflow:"inherit"},"& div.rdg-row span.ttask":{paddingLeft:"100px"},"& div.rdg-row span.tstage":{paddingLeft:"65px",display:"block"},"& div.rdg-row svg.tdragger":{position:"fixed",top:"12px",color:"#CDD3DB",cursor:"pointer"},"& div.rdg-row span.tmembers":{display:"flex",alignItems:"center"},"& div.rdg-row span.tmembers svg":{color:"#CDD3DB"},"& div.rdg-row span.tmembers strong":{marginLeft:"10px",marginRight:"5px"},"& div.rdg-group-row > div.rdg-cell:nth-child(2) button":{marginRight:"10px"}}}));function Bn({customSortKey:t,descending:s}){const[n,a]=m.useState({keys:new Set,mapping:null,tmp:null,minDate:null,maxDate:null}),r=m.useCallback(ht((o,{minDate:c,maxDate:l,mapping:i})=>{a(u=>JSON.stringify([u.tmp,c,l])===JSON.stringify([o,c,l])?u:{...u,keys:new Set(o),tmp:o,maxDate:l&&new Date(l),minDate:c&&new Date(c),mapping:i})},500),[]);return{grouper:m.useCallback((o,c)=>{const l=[],i={};let u,f;console.log(">>TaskGrid/useTreeGridDataGrouper::","data",o);for(const g of o){const p=g[c];l.push(p),i[p]=i[p]||[],i[p].push(g),(!u||g.start<u)&&(u=g.start),(!f||g.due>f)&&(f=g.due)}if(r(l,{minDate:u,maxDate:f,mapping:i}),t){const g={};Object.keys(i).forEach(T=>{var b;const S=i[T];if(T==="<NO-GROUP>")g[0]=S;else{const h=(S&&S[0]?(b=S[0].stage)==null?void 0:b.sortOrder:0)+1;g[`${h.toString()}`]=S}});const p={};return s?Object.keys(g).sort().forEach((T,S)=>{p[S]=g[T]}):Object.keys(g).sort().reverse().forEach((T,S)=>{p[S]=g[T]}),p}return i},[r,t,s]),state:n}}const Wn=K({root:{display:"flex",alignItems:"center","& > *":{display:"inline-flex"},"& > span":{textTransform:"uppercase",opacity:.6,marginRight:"5px"},"& svg":{opacity:.4},"& svg:hover":{backgroundColor:"lightgray",cursor:"pointer"}}});function pt(t){const{column:s,sortDirection:n}=t,a=Wn();let r;return n==="DESC"?r=ws:n==="ASC"?r=Cs:r=Is,e.jsxs("div",{className:a.root,children:[e.jsx("span",{children:s.name}),!t.disabledSort&&e.jsx(F,{title:"Sort",children:e.jsx("div",{children:e.jsx(r,{onClick:()=>t.onSort(!1)})})},n),t.onFilterClick&&e.jsx(F,{title:"Filter",children:e.jsx(Te,{badgeContent:t.filterCount,color:"secondary",children:e.jsx($t,{onClick:t.onFilterClick})})})]})}function qn(t){const s=m.useRef({}),n=m.useRef(null),[a,r]=m.useState({groupKeys:new Set,groupMapping:null,sortColumns:t.initialSortColumns||null});s.current.formatStageName=t.formatStageName,s.current.formatTaskName=t.formatTaskName;const{grouper:d,state:{mapping:o}}=Bn({customSortKey:t.customSortKey,descending:t.grouperSortDirection==="desc"});a.groupMapping=o;const c=m.useMemo(()=>t.columns.map(l=>({...l,headerRenderer:l.headerRenderer||function(i){return e.jsx(pt,{...i,disabledSort:!l.sortable})}})),[t.columns]);return console.log({props:t.data}),e.jsxs(ut,{backend:gt,children:[e.jsx("span",{className:"mb-tree-grid-loader",children:t.loading&&e.jsx(Je,{variant:"indeterminate"})}),e.jsx(vs,{ref:n,columns:c,rows:t.data,rowKeyGetter:l=>l.id,rowHeight:50,groupBy:t.grouperField?[t.grouperField]:void 0,rowGrouper:d,expandedGroupIds:t.expandedGroupIds,className:`${t.className||""} mb-tree-grid fill-grid rdg-light`,rowRenderer:t.rowRenderer,sortColumns:a.sortColumns,onSortColumnsChange:l=>{t.onSortChange&&t.onSortChange(l),r(i=>({...i,sortColumns:l}))}})]})}const Yn=m.createContext({}),ae=Yn,Qn=t=>{const s=ce({key:"ElasticSearchSprintTasksCount",index:"task",body:{size:0,query:{bool:{must:[{term:{"taskSprintId.keyword":t}}]}},aggs:{per_stage:{terms:{field:"taskSprintId.keyword",size:999}}}}});return[D.useMemo(()=>{var a,r,d,o;return((o=(d=(r=(a=s==null?void 0:s.result)==null?void 0:a.aggregations)==null?void 0:r.per_stage)==null?void 0:d.buckets[0])==null?void 0:o.doc_count)||0},[s==null?void 0:s.result]),s]};function Be(t){var l,i;const[s,n]=m.useState({hovered:!1}),a=m.useContext(ae),r=t.type==="TASK"&&s.hovered,[,d]=dt({type:t.type,canDrag:()=>r,item:{record:t.row,type:t.type},collect:u=>({isDragging:u.isDragging()}),end:(u,f)=>{var p,T,S,b;const g=f.getDropResult();if(console.log(">>task/TaskGrid::","item,dropResult",u,g),u.type==="TASK"){const v=(p=u==null?void 0:u.record)==null?void 0:p.id,h=((T=g==null?void 0:g.record)==null?void 0:T.taskSprintId)||((S=g==null?void 0:g.record)==null?void 0:S.groupId);console.log(">>TaskGrid/TaskDraggableTitle::","newStageId",h),v&&h&&((b=a.actions)==null||b.moveTaskToStage(v,h))}}});let o;t.groupKey?o=e.jsx(Zn,{...t,groupKey:t.groupKey}):o=e.jsx("span",{className:"ttask",children:t.row._isEmptyPlaceholder?e.jsx(Xe,{label:"EMPTY",size:"small"}):e.jsxs(e.Fragment,{children:[e.jsx(lt,{}),t.row.code&&e.jsxs("span",{className:"tcode",children:["#",t.row.code]}),e.jsx(hs,{to:`/project/${t.row.projectId||"_"}/stage/${t.row.taskSprintId||"_"}/tasks/${t.row.id}`,children:t.row.title||"-"})]})});const c=m.useCallback(u=>()=>{n(f=>({...f,hovered:u}))},[]);return e.jsxs("div",{className:"trow",ref:(l=t.row)!=null&&l._isEmptyPlaceholder?void 0:d,onMouseEnter:c(!0),onMouseLeave:c(!1),children:[!((i=t.row)!=null&&i._isEmptyPlaceholder)&&r&&e.jsx(F,{title:"Move",children:e.jsx(Os,{className:"tdragger"})}),o]})}function Zn(t){var T,S;const s=m.useRef(null),n=m.useContext(ae),a=(T=n.state)==null?void 0:T.expandedStageIds.has(t.groupKey),o=(((t==null?void 0:t.childRows)||[])[0]||{}).stage||{},c=o.name||"<NO-GROUP>",l=o.id,i=(S=n.state)==null?void 0:S.tasks,u=D.useMemo(()=>i.filter(b=>l===void 0?b.taskSprintId===null:b.taskSprintId===l).filter(b=>!b._isEmptyPlaceholder),[i,l]),[f]=Qn(l),[{isOver:g},p]=be({accept:"TASK",canDrop:()=>!0,drop:()=>({record:{groupId:l,groupKey:t.groupKey}}),collect:b=>({isOver:b.isOver(),canDrop:b.canDrop()})});return m.useEffect(()=>{if(!s.current)return;const b=s.current.closest(".rdg-row");b&&(g?b.classList.add("dropping"):b.classList.remove("dropping"))},[g]),e.jsxs("span",{ref:p,className:"tstage",children:[e.jsx(B,{ref:s,size:"small",onClick:()=>{var v;const b=new Set((v=n.state)==null?void 0:v.expandedStageIds);a?b.delete(t.groupKey):b.add(t.groupKey),n.setState&&n.setState(h=>({...h,expandedStageIds:b}))},children:a?e.jsx(Kt,{}):e.jsx(Vt,{})}),c||"",u!=null&&u.length?e.jsx(k,{component:"span",bgcolor:"#E6E9ED",color:"#37516D",fontWeight:"normal",fontSize:"10px",pl:"5px",pr:"5px",ml:"5px",borderRadius:"5px",children:e.jsxs(e.Fragment,{children:[e.jsx("span",{children:u==null?void 0:u.length}),!!f&&e.jsxs("span",{children:[" / ",f]})]})}):""]})}function Jn(t){const[{isOver:s},n]=be({accept:"TASK",canDrop:()=>!0,drop:()=>({record:t.row}),collect:r=>({isOver:r.isOver(),canDrop:r.canDrop()})}),a={...t,ref:n,className:s?"dropping":void 0};return e.jsx(Ts,{...a})}function We({progress:t=0,status:s=null}){let n="tprogress";return t>99&&(n+=" bgsuccess"),s==="COMPLETE"?n+=" bgsuccess":t>50?n+=" bginfo":n+=" bgwarning",console.log("progress",t),e.jsxs("div",{className:n,children:[e.jsx(Je,{value:s==="COMPLETE"?100:t,variant:"determinate"}),e.jsxs("span",{children:[s==="COMPLETE"?100:t??0,"%"]})]})}function Xn(t){return e.jsx(se,{...t,width:"28",height:"25",viewBox:"0 0 28 25",paths:["M18.2954 2.47202L27.052 17.4415C27.9633 18.9819 27.983 20.8915 27.1036 22.4504C26.2231 24.0111 24.5775 24.9803 22.7654 24.9979L5.21809 24.9979C3.42467 24.9833 1.77587 24.0111 0.895312 22.449C0.015481 20.8882 0.0360305 18.9743 0.944373 17.447L9.70429 2.47209C10.5943 0.939945 12.2335 -0.00207109 14.0057 3.41932e-06C15.7777 0.00207771 17.4162 0.947998 18.2954 2.47202ZM11.8641 3.73113L3.09769 18.7171C2.64292 19.4818 2.63264 20.4399 3.07314 21.2214C3.51412 22.0037 4.34 22.4906 5.22826 22.4979L22.7532 22.498C23.6609 22.4891 24.4852 22.0037 24.9261 21.2221C25.3664 20.4416 25.3566 19.4856 24.8972 18.7091L16.1336 3.72778C15.697 2.97092 14.8831 2.50103 14.0027 2.5C13.1223 2.49897 12.3081 2.96692 11.8641 3.73113ZM14.0005 19.9979C13.3099 19.9979 12.7501 19.4383 12.7501 18.7479C12.7501 18.0576 13.3099 17.4979 14.0005 17.4979C14.6911 17.4979 15.2509 18.0576 15.2509 18.7479C15.2509 19.4383 14.6911 19.9979 14.0005 19.9979ZM12.7538 7.49793H15.2546V16.2479H12.7538V7.49793Z"]})}function ea({task:t}){let s="estimate";return t.estimatedEffort||(s+="bgwarning"),e.jsxs("div",{className:s,style:{display:"flex",alignItems:"center",justifyContent:"flex-start"},children:[!t.estimatedEffort&&e.jsx(k,{sx:{pt:"8px",pr:"8px"},children:e.jsx(Xn,{})}),t.taskDuration||"0"," / ",t.estimatedEffort," hr"]})}function ta(t){const s=t.dueDate||"";return e.jsx("span",{className:"tdue",children:s?q(new Date(s),"LLL dd, yyyy"):""})}const me={"not started":0,"in-progress":50,completed:100},sa=t=>{var n;const s=me==null?void 0:me[(n=t.toLowerCase())==null?void 0:n.trim()];return console.log({getProgressByStatus:t,progress:s}),s};function qe(t){var i,u;const s=G("TASK_STATUS_PROGRESS"),[n]=ne(["kwTaskStatusList"]),a=(t.status||"").toUpperCase(),r=D.useMemo(()=>{var f;return(f=n==null?void 0:n.kwTaskStatusList)==null?void 0:f.map(g=>{var p;return{value:(p=g==null?void 0:g.toLowerCase())==null?void 0:p.trim(),label:g}})},[n==null?void 0:n.kwTaskStatusList]),{data:d}=pe({queryKey:["TASK_STATUS_Q",n],queryFn:async()=>{const f=await et({index:"task",body:{size:0,aggs:{distinct_status:{terms:{field:"status.keyword"}}}}});return[{value:"OPEN",text:"OPEN"},...A(f,"result.aggregations.distinct_status.buckets",[]).map(p=>{var T,S;return{value:(S=(T=p.key)==null?void 0:T.toLowerCase())==null?void 0:S.trim(),label:p.key}})]},enabled:!s}),o=async f=>{const g=s?sa(f)??void 0:void 0;await t.updateTask({variables:{input:{id:t.taskId,status:f,progress:g}}}),await t.tasksQ.refetch(),await t.enqueueSnackbar("Updated Successfully.",{variant:"success"})},c=s?r:d,l=f=>{var p;let g;if(s.value){const T=(p=f==null?void 0:f.toLowerCase())==null?void 0:p.trim();T==="incomplete"||T==="in-progress"?g="twarning":T==="completed"?g="tsuccess":(T==="not started"||T==="idle")&&(g="terror")}return g};return e.jsx(k,{sx:{paddingTop:.75},children:t.taskId?e.jsx(e.Fragment,{children:e.jsx(Ut,{defaultValue:((i=a==null?void 0:a.toLowerCase())==null?void 0:i.trim())==="idle"?"not started":(u=a==null?void 0:a.toLowerCase())==null?void 0:u.trim(),className:l(a),sx:{width:"100%"},onChange:(f,g)=>{o(g.props.value),console.log("so",g)},children:c==null?void 0:c.map((f,g)=>e.jsx(Bt,{value:f.value,children:f.label},g))})}):e.jsx("span",{className:l(a),children:ft(a)})})}function na(t){const s=m.useRef({}),[n,a]=de({tgStatus:z}),r=ce({key:"TASK_STATUS_Q",index:"task",body:{size:0,aggs:{distinct_status:{terms:{field:"status.keyword"}}}}}),d=[{value:"OPEN",text:"OPEN"},...A(r,"result.aggregations.distinct_status.buckets",[]).map(c=>({value:c.key,text:c.key}))],o=m.useCallback(c=>{const l=c.currentTarget.value;a({tgStatus:l})},[a]);return e.jsxs(e.Fragment,{children:[e.jsx(pt,{...t,filterCount:Object.keys(Ls(n)).length,onFilterClick:c=>{s.current.open(c.target)}}),e.jsx(W,{ref:s,variant:"popover",anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},children:e.jsx(k,{width:"300px",p:2,children:e.jsx(le,{fullWidth:!0,value:n.tgStatus,variant:"slim-filter",options:d,label:"Filter Status",onChange:o})})})]})}function Ye(t){return e.jsx(se,{...t,width:"24px",height:"24px",viewBox:"2 0 24 24",paths:["M14 2H6C4.9 2 4 2.9 4 4V20C4 20.41 4.12 20.8 4.34 21.12C4.41 21.23 4.5 21.33 4.59 21.41C4.95 21.78 5.45 22 6 22H13.53C13 21.42 12.61 20.75 12.35 20H6V4H13V9H18V12C18.7 12 19.37 12.12 20 12.34V8L14 2M18 23L23 18.5L20 15.8L18 14V17H14V20H18V23Z"]})}const aa=t=>{const s=je(Wt,{...t});return[D.useMemo(()=>{var r,d;return((d=(r=s.data)==null?void 0:r.result)==null?void 0:d.items)||[]},[s.data]),s]},ue=K(t=>({root:{width:"200px"},delete:{color:t.palette.error.dark,"& .MuiListItemIcon-root":{color:"inherit"}},moveTaskRoot:{width:"300px",maxHeight:"400px"},moveProjectRoot:{width:"300px",padding:"10px"}}));function ra({popperContext:t,refetch:s,projectStatus:n}){var i;const[a,r]=m.useState({mode:0}),[,d]=de({tTaskId:z}),o=G("TASK_EDITABLE_ON_PROJECT_COMPLETE").on,c=(i=t.state)==null?void 0:i.taskId,l=ue();return a.mode===0?e.jsxs(Se,{className:l.root,children:[e.jsxs(X,{disabled:n==="COMPLETED"&&!o,button:!0,onClick:()=>{d({tTaskId:c}),t.close()},children:[e.jsx(te,{children:e.jsx(Es,{})}),e.jsx(ee,{primary:"Edit"})]}),e.jsxs(X,{button:!0,onClick:()=>{r(u=>({...u,mode:1})),t.open(t.anchorEl)},children:[e.jsx(te,{children:e.jsx(Ye,{})}),e.jsx(ee,{primary:"Move"})]}),e.jsxs(X,{button:!0,onClick:()=>{r(u=>({...u,mode:2})),t.open(t.anchorEl)},children:[e.jsx(te,{children:e.jsx(Ye,{})}),e.jsx(ee,{primary:"Move Project"})]}),e.jsx(oa,{taskId:c,popperContext:t})]}):a.mode===1?e.jsx(ia,{taskId:c,popperContext:t}):a.mode===2?e.jsx(la,{taskId:c,popperContext:t,refetch:s}):null}function oa({taskId:t,popperContext:s}){const n=ue(),{enqueueSnackbar:a}=Y(),[r]=fs();return e.jsxs(X,{button:!0,className:n.delete,onClick:async()=>{await r({id:t,__typename:"Task"}),a("Task has been removed",{variant:"success"}),s.close()},children:[e.jsx(te,{children:e.jsx(Ps,{})}),e.jsx(ee,{primary:"Delete"})]})}function ia({taskId:t,popperContext:s}){var r;const n=ue(),a=m.useContext(ae);return e.jsx(Se,{className:n.moveTaskRoot,subheader:e.jsx(tt,{component:"div",children:"Select Stage:"}),children:(((r=a.state)==null?void 0:r.stages)||[]).map(d=>e.jsxs(X,{button:!0,onClick:async()=>{var o;await((o=a.actions)==null?void 0:o.moveTaskToStage(t,d.id)),s.close()},children:[e.jsx(te,{children:e.jsx(bs,{})}),e.jsx(ee,{primary:d.name})]},d.id))})}function la({taskId:t,popperContext:s,refetch:n}){var T,S,b,v;const a=ue(),r=Ms({defaultValues:{id:t}});_s(r.control);const{enqueueSnackbar:d}=Y(),[o]=st(nt`
      mutation ($input: UpdateTaskInput!) {
        updateTask(input: $input) {
          id
          taskSprintId
        }
      }
    `,{onCompleted:()=>{d("Task has been moved",{variant:"success"}),setTimeout(()=>{n()},1e3)},onError:()=>{d("Failed to move task",{variant:"error"})}}),[c]=aa({}),l=r.getValues(),i=D.useMemo(()=>l.projectId,[l.projectId]),u=m.useMemo(()=>{if(i){const h={bool:{must:[]}},y={};if(i)y["sprintProjectId.keyword"]=i;else return null;return h.bool.must.push({term:y}),h}},[i]),f=ce({index:"sprint",body:{size:99,sort:[],query:$.isFunction(u)?u({}):u}}),g=As({control:r.control,name:"projectId"}),p=D.useMemo(()=>{var h,y,C;return(C=(y=(h=f.result)==null?void 0:h.hits)==null?void 0:y.hits)==null?void 0:C.filter(E=>{var N;return E!=null&&E._source.sprintProjectId&&((N=E==null?void 0:E._source)==null?void 0:N.sprintProjectId)===g?E:null})},[(S=(T=f.result)==null?void 0:T.hits)==null?void 0:S.hits,g]);return e.jsx(Se,{className:a.moveProjectRoot,subheader:e.jsx(tt,{component:"div",children:"Move Task:"}),children:e.jsxs("form",{onSubmit:r.handleSubmit(async h=>{try{await o({variables:{input:{id:h==null?void 0:h.id,projectId:h==null?void 0:h.projectId,taskSprintId:h==null?void 0:h.taskSprintId}}}),await s.close()}catch(y){console.error(y.message)}},h=>{console.log(">>TaskPopoverMenu::","err",h)}),children:[e.jsx(k,{gridColumn:"span 2",children:e.jsx($e,{control:r.control,name:"projectId",textFieldProps:{label:"Project",placeholder:"Select Project"},options:((b=c||[])==null?void 0:b.map(h=>({value:h==null?void 0:h.id,label:h==null?void 0:h.name})))||[]})}),e.jsx(k,{gridColumn:"span 2",children:e.jsx($e,{control:r.control,name:"taskSprintId",textFieldProps:{label:"Stage",placeholder:"Select Stage"},options:((v=$.sortBy(p,["name"])||[])==null?void 0:v.map(h=>{var y,C;return{value:(y=h==null?void 0:h._source)==null?void 0:y.id,label:(C=h==null?void 0:h._source)==null?void 0:C.name}}))||[]})}),e.jsx(qt,{sx:{mt:2,mb:2}}),e.jsxs(k,{sx:{display:"flex",justifyContent:"flex-end",gap:2},children:[e.jsx(U,{variant:"outlined",onClick:()=>s.close(),children:"Cancel"}),e.jsx(U,{variant:"contained",type:"submit",children:"Move Task"})]})]})})}function ca(){const{enqueueSnackbar:t}=Y(),[s]=st(Yt`
      mutation($input: UpdateTaskInput!) {
        updateTask(input: $input) {
          id
          taskSprintId
        }
      }
    `,{onCompleted:()=>{t("Task has been moved",{variant:"success"})},onError:()=>{t("Failed to move task",{variant:"error"})}});return{moveTaskToStage:D.useCallback(async(a,r)=>{await s({variables:{input:{id:a,taskSprintId:r}}})},[s])}}const da=K(()=>({filters:{display:"flex",alignItems:"center",flexWrap:"wrap","& > *":{marginRight:5},marginBottom:2}}));function ua(){const t=m.useContext(ae),[s,n]=m.useState([]),a=da(),[r,d]=de({status:z,assigneeId:z,types:z}),o=G("HIDE_TYPE").value;console.log("isHiddenType",o);const c=m.useCallback((l,i,u)=>{const f=s==null?void 0:s.filter(g=>{var p;return!l&&!i&&!u?(console.log("check",s),!0):!!((!l||l===g.type)&&(!i||i===g.status)&&(!u||(p=g==null?void 0:g.userAssignments)!=null&&p.items.some(T=>{var S;return((S=T==null?void 0:T.user)==null?void 0:S.id)===u})))});t.setState(g=>({...g,tasks:f}))},[s,t]);return m.useEffect(()=>{!(s!=null&&s.length)&&t.state.tasks.length&&(console.log("initial filter - IN USEEFFECT 1"),n(t.state.tasks))},[s,t.state.tasks]),m.useEffect(()=>{if((r.types||r.status||r.assigneeId)&&(s!=null&&s.length)){const l=s.filter(i=>{var u;return!r.types&&!r.status&&!r.assigneeId?!0:!!((!r.types||r.types===i.type)&&(!r.status||r.status===i.status)&&(!r.assigneeId||(u=i==null?void 0:i.userAssignments)!=null&&u.items.some(f=>{var g;return((g=f==null?void 0:f.user)==null?void 0:g.id)===r.assigneeId})))});t.setState(i=>{const u=ze(i.tasks);console.log(">>TaskGridFilters/index::","oldTashHash",u);const f=ze(l);return console.log(">>TaskGridFilters/index::","newTashHash",f),u===f?i:{...i,tasks:l}})}},[s,t.state.tasks,t.setState,r]),e.jsxs("div",{className:a.filters,children:[e.jsx(fe,{containerProps:{minHeight:"0",padding:1,width:250},children:e.jsx(an,{value:r.assigneeId,onChange:l=>{d({assigneeId:l}),c(r.types,r.status,l)}})}),e.jsx(fe,{containerProps:{minHeight:"0",padding:1,width:200},children:e.jsx(nn,{label:"Status",value:r.status,onChange:l=>{d({status:l}),c(r.types,l,r.assigneeId)}})}),!o&&e.jsx(fe,{containerProps:{minHeight:"0",padding:1,width:200},children:e.jsx(rn,{value:r.types,onChange:l=>{d({types:l}),c(l,r.status,r.assigneeId)}})})]})}function ga(t){return e.jsx(se,{...t,width:"18px",height:"12px",viewBox:"0 0 18 12",paths:["M17.3334 10.1667V11.8333H0.666748V10.1667H17.3334ZM17.3334 5.16666V6.83332H0.666748V5.16666H17.3334ZM17.3334 0.166656V1.83332H0.666748V0.166656H17.3334Z"]})}function ha({tasks:t}){console.log({tasks:t});const s=n=>t==null?void 0:t.reduce((a,r)=>parseFloat(a||0)+parseFloat((r==null?void 0:r[n])||0),0);return e.jsx(k,{sx:{paddingLeft:1.5},children:e.jsxs(k,{children:[s("taskDuration")," / ",s("estimatedEffort")," hr"]})})}const fa="EMPTY",ma=async t=>{var d,o,c,l;const{dateRange:s,taskIds:n}=t,a=await et({index:"interval",body:{size:0,query:{bool:{must:[{exists:{field:"durationMs"}}],filter:$.compact([(oe(s==null?void 0:s.start)||oe(s==null?void 0:s.end))&&{range:{when:{gte:q(s==null?void 0:s.start,"yyyy-MM-dd"),lte:q(s==null?void 0:s.end,"yyyy-MM-dd")}}},(oe(s==null?void 0:s.start)||oe(s==null?void 0:s.end))&&{exists:{field:"when"}},((d=$.compact(n))==null?void 0:d.length)&&{terms:{"taskId.keyword":$.compact(n)}}])}},aggs:{byUser:{terms:{field:"userId.keyword",size:1e4},aggs:{byDay:{date_histogram:{field:"startedAt",interval:"day"},aggs:{byProject:{terms:{field:"forProjectId.keyword",size:1e4,missing:fa},aggs:{byTask:{terms:{field:"taskId.keyword",size:1e4},aggs:{totalDuration:{sum:{script:{source:"doc['durationMs'].value / (1000 * 60 * 60)",lang:"painless"}}}}},totalDuration:{sum:{script:{source:"doc['durationMs'].value / (1000 * 60 * 60)",lang:"painless"}}}}},totalDuration:{sum:{script:{source:"doc['durationMs'].value / (1000 * 60 * 60)",lang:"painless"}}}}},totalDuration:{sum:{script:{source:"doc['durationMs'].value / (1000 * 60 * 60)",lang:"painless"}}}}}}}});return(l=(c=(o=a==null?void 0:a.aggregations)==null?void 0:o.byUser)==null?void 0:c.buckets)==null?void 0:l.flatMap(i=>{var g;const u=i.key;return(g=i.byDay.buckets)==null?void 0:g.flatMap(p=>{var S,b;const T=p.key;return(b=(S=p==null?void 0:p.byProject)==null?void 0:S.buckets)==null?void 0:b.flatMap(v=>{var y,C;const h=v==null?void 0:v.key;return(C=(y=v==null?void 0:v.byTask)==null?void 0:y.buckets)==null?void 0:C.map(E=>{var O,L,H,_;const N=E==null?void 0:E.key;return{userId:u,day:T,projectId:h,date:q(new Date(T),"yyyy-MM-dd"),taskId:N,userTotalDuration:((O=i.totalDuration)==null?void 0:O.value)??0,dayTotalDuration:((L=p.totalDuration)==null?void 0:L.value)??0,projectTotalDuration:((H=v.totalDuration)==null?void 0:H.value)??0,taskTotalDuration:((_=E.totalDuration)==null?void 0:_.value)??0}})})})})},xa=e.jsx(Xt,{sx:{width:18,height:18}});function pa(t){const{assignments:s,handleOnDeleteAssign:n,handleOnSaveAssign:a,onOptionSelected:r,taskId:d}=t,{data:o,isLoading:c}=pe({queryKey:["TASK_INTERVALS",d],queryFn:async()=>await ma({taskIds:[d],dateRange:{start:void 0,end:void 0}}),enabled:!!d}),[l,i]=m.useState(),[u,f]=m.useState(()=>Qe(s,o));m.useEffect(()=>f(()=>Qe(s,o)),[s,o]);const g=(v,h,y)=>{let C=h;h&&typeof h=="object"&&"value"in h?C=h.value:Array.isArray(h)&&(C=h.map(E=>typeof E=="string"?E:E.value)),y==="removeOption"&&f(h),y==="selectOption"&&(f(h),r(C))},T=ht(v=>{if(!v){i(void 0);return}i(v)},1e3),{data:S}=pe({queryKey:["TASK_ASSIGNEES",{searchText:l}],queryFn:async()=>await Bs({searchText:l})}),b=D.useMemo(()=>{var y;const v=$.keyBy(o,"userId");return!S||Qt(S==null?void 0:S.items)?[]:ke((y=S.items||[])==null?void 0:y.map(C=>{var E,N;return{photo:C==null?void 0:C.profilePhoto,label:C==null?void 0:C.fullname,value:C==null?void 0:C.id,id:C==null?void 0:C.id,taskTotalHours:((N=v==null?void 0:v[(E=C==null?void 0:C.id)==null?void 0:E.toLowerCase()])==null?void 0:N.userTotalDuration)||0}}),[C=>{var E;return(E=C.label)==null?void 0:E.toLocaleLowerCase()}],["asc"])},[S,o]);return e.jsxs(k,{children:[e.jsxs(R,{variant:"subtitle1",mb:1,sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:["Add/Edit Assignee ",c&&e.jsx(Zt,{size:"20px"})]}),e.jsxs(k,{sx:{display:"flex",flexDirection:"row",columnGap:.5},children:[e.jsx(B,{size:"small",onClick:()=>a(),sx:{width:48,borderRadius:"5px",backgroundColor:"success.light",color:"white","&:hover":{backgroundColor:"success.main"}},children:e.jsx(ot,{})}),e.jsx(Jt,{multiple:!0,disableCloseOnSelect:!0,disableClearable:!0,options:b??[],filterOptions:v=>$.differenceBy(v,u,"value"),getOptionLabel:v=>(v==null?void 0:v.label)??(v==null?void 0:v.value),value:u,sx:{"& > .MuiInputBase-root":{height:40}},renderTags:(v,h)=>v.map((y,C)=>{const E=h({index:C});return e.jsx(F,{title:y==null?void 0:y.label,children:D.createElement(Xe,{...E,sx:{"& .MuiChip-deleteIcon":{visibility:y!=null&&y.taskTotalHours?"hidden":"visible",paddingX:0}},key:C,avatar:e.jsx(Us,{alt:y==null?void 0:y.label,s3Key:y==null?void 0:y.photo,size:"small",sx:{mr:y!=null&&y.taskTotalHours?"-40px!important":"-14px!important"}}),deleteIcon:xa,onDelete:N=>{E.onDelete(N),n(y.value)}})},C+(y==null?void 0:y.value))}),renderInput:v=>e.jsx(at,{...v,sx:{"& .MuiInputBase-root":{minWidth:300,"& .MuiChip-root":{mt:"-4px"},"& .MuiInputBase-input":{mt:"-10px"}}}}),renderOption:(v,h)=>e.jsx("li",{...v,children:h==null?void 0:h.label}),onChange:g,onInputChange:(v,h)=>T(h)})]})]})}const Qe=(t,s=[])=>{const n=$.keyBy(s,"userId");return Object.values(t).map(a=>{var r,d,o,c;return{id:a==null?void 0:a.userId,value:a==null?void 0:a.userId,label:(r=a==null?void 0:a.user)==null?void 0:r.fullname,photo:(d=a==null?void 0:a.user)==null?void 0:d.profilePhoto,taskTotalHours:((c=n==null?void 0:n[(o=a==null?void 0:a.userId)==null?void 0:o.toLowerCase()])==null?void 0:c.userTotalDuration)||0}})},xe="stageName",ja="mb-task-list-switch-btn";function ya({projectId:t,opportunityId:s}){var Ae,_e,Ne;const{data:n}=D.useContext(Fs)||{data:{}},a=m.useRef({mapping:{stage:{},task:{}}});console.log({projectDetails:n});const r=m.useRef({}),d=m.useRef({}),o=m.useRef({}),c=m.useRef({}),l=m.useRef({}),[i,u]=m.useState({projectId:t,opportunityId:s,stages:[],tasks:[],expandedStageIds:new Set([]),assignments:[]}),[f,g]=de({searchText:z,tgAssignee:z,tgStatus:z,tTaskId:z,tgType:z,tTaskEditId:z}),[p,T]=m.useState("listView");m.useEffect(()=>{f.tTaskId?d.current.open():d.current.close()},[f.tTaskId]),console.log(">>TaskGrid/index::","qParams",f);const{projectId:S=t,opportunityId:b=s}=i,{data:v,refetch:h}=je(nt`
      query ($projectId: ID!) {
        getProject(id: $projectId) {
          id
          name
          status
        }
      }
    `,{variables:{projectId:S}}),y={status:"IDLE"};S?y.projectId=S:b&&(y.opportunityId=b);const C=Un(),E=D.useMemo(()=>JSON.stringify({...S&&{projectId:{eq:S}},...b&&{opportunityId:{eq:b}}}),[b,S]),N=D.useMemo(()=>({...S&&{sprintProjectId:{eq:S}},...b&&{opportunityId:{eq:b}}}),[b,S]),O=je(rs,{variables:{taskFilter:E,sprintFilter:N},notifyOnNetworkStatusChange:!0,fetchPolicy:"network-only",nextFetchPolicy:"cache-first"});Ss({...O,listPath:"list",maxLength:9999});const L=D.useMemo(()=>{var w,I;return((I=(w=O==null?void 0:O.data)==null?void 0:w.stages)==null?void 0:I.items)||[]},[(_e=(Ae=O==null?void 0:O.data)==null?void 0:Ae.stages)==null?void 0:_e.items]),H=D.useMemo(()=>{var I;const j=(I=L==null?void 0:L.map)==null?void 0:I.call(L,x=>[`${x.name}@stage_key@${x.id}`,x]);return Object.fromEntries(j)},[L]),_=D.useMemo(()=>{var P;console.log(">>TaskGrid/index::","mapping");const{tasks:j,mapping:w,nonEmptyStageKeys:I}=$n({filter:f,stages:L,tasks:A(O,"data.list.items",[]),metadata:A(O,"data.list.metadata","{}"),mapping:a.current.mapping});return a.current.mapping=w,console.log(">>TaskGrid/index::","self.current.mapping",a.current.mapping),console.log(">>TaskGrid/index::","stages,stageKeys",L,I),console.log({normalizedStages:H,stages:L,tasks:j,mapping:w,nonEmptyStageKeys:I}),{mappedTasks:((P=j==null?void 0:j.map)==null?void 0:P.call(j,M=>({...M,stage:H[M.stageName]})))||[],tasks:j,mapping:w,nonEmptyStageKeys:I}},[H,f,L,O]);D.useEffect(()=>{const j=L&&L.map((w,I)=>I.toString());j.push(L.length.toString()),u(w=>({...w,tasks:_==null?void 0:_.mappedTasks,stages:L,expandedStageIds:new Set(j)}))},[O,f,H,_==null?void 0:_.mappedTasks,_==null?void 0:_.nonEmptyStageKeys,L]);const jt=ca(),{enqueueSnackbar:re}=Y(),[Q]=ve(),ge=(Ne=v==null?void 0:v.getProject)==null?void 0:Ne.status,yt=m.useMemo(()=>{const j="action@@";function w(x){const P=x.target.closest("button");if(!P)return;const M=P.getAttribute("name").replace(j,"");r.current.open(x.target,{taskId:M})}function I(x){o.current.open(x.target,"assignee")}return[{key:xe,name:"",width:10,resizable:!1,groupFormatter:()=>e.jsx("span",{})},{key:"title",name:"Stage / Task",width:400,resizable:!0,sortable:!0,formatter(x){return e.jsx(Be,{...x,type:"TASK"})},groupFormatter(x){return A(x,`childRows.0.${xe}`)?e.jsx(Be,{...x,type:"STAGE"}):null}},{key:"assignee",name:"Who",width:150,resizable:!1,sortable:!1,formatter(x){return e.jsxs(k,{sx:{display:"flex",justifyContent:"flex-start",height:50,padding:1},children:[ge!=="COMPLETED"?e.jsx(k,{onClick:P=>{I(P),g({tTaskEditId:x.row.id})},sx:{"& svg":{color:"grey !important",cursor:"pointer"}},children:e.jsx(ms,{})}):"",e.jsx(Kn,{tasks:[x.row]})]})}},{key:"due",name:"Due Date",width:150,sortable:!1,resizable:!1,formatter(x){return x.row._isEmptyPlaceholder?e.jsx(m.Fragment,{}):e.jsx(k,{children:e.jsxs(k,{sx:{cursor:"pointer",display:"flex",alignItems:"center",pt:x.row.due?"0px":"12px"},onClick:P=>{he(x.row.due),c.current.open(P.currentTarget),g({tTaskEditId:x.row.id}),console.log({rprops:x.row})},children:[e.jsx(k,{color:"lightgrey",component:xs,mr:1}),e.jsx(ta,{dueDate:x.row.due})]})})}},{key:"status",name:"Status",width:200,sortable:!0,resizable:!1,formatter(x){return x.row._isEmptyPlaceholder?e.jsx(m.Fragment,{}):e.jsx("div",{style:{position:"relative",top:"-8px"},children:e.jsx(qe,{status:x.row.status,taskId:x.row.id,tasksQ:O,enqueueSnackbar:re,updateTask:Q})})},groupFormatter(x){const P=x.childRows.some(Z=>!["Complete","COMPLETE","completed"].includes(Z.status));let M="COMPLETED";return P&&(M="INCOMPLETE"),e.jsx(qe,{status:M})},headerRenderer(x){return e.jsx(na,{...x})}},{key:"invoice",name:"INV",width:200,sortable:!1,resizable:!1,formatter(x){return x.row._isEmptyPlaceholder?e.jsx(m.Fragment,{}):e.jsx(Ys,{id:x.row.id,iconOnly:!0})}},{key:"progress",name:"Progress",sortable:!0,resizable:!1,formatter(x){return x.row._isEmptyPlaceholder?e.jsx(m.Fragment,{}):e.jsx(We,{progress:bt?x.row.actualProgress:x.row.progress})},groupFormatter(x){const P=x.childRows.some(Z=>{var J,Re;return!["Complete","COMPLETE","completed"].includes((Re=(J=Z.status)==null?void 0:J.toLowerCase())==null?void 0:Re.trim())});let M="completed";return P&&(M="incomplete"),e.jsx(We,{progress:P?0:100,status:M})}},{key:"taskDuration",name:"ACT / EST",width:150,sortable:!0,resizable:!1,formatter(x){return x.row._isEmptyPlaceholder?e.jsx(m.Fragment,{}):e.jsx(k,{sx:{cursor:"pointer"},onClick:P=>{l.current.open(P.currentTarget),Pe(x.row.estimatedEffort),g({tTaskEditId:x.row.id})},children:e.jsx(ea,{task:x.row})})},groupFormatter(x){return e.jsx(ha,{tasks:x==null?void 0:x.childRows})}},{key:"id",name:"Action",width:150,resizable:!1,formatter(x){return e.jsxs("div",{className:"tactions",children:[e.jsx(on,{task:x.row}),e.jsx(cn,{task:x.row,taskId:x.row.id,projectId:x.row.projectId}),e.jsx(B,{size:"small",name:`${j}${x.row.id}`,onClick:w,children:e.jsx(zs,{})})]})}}].filter(Boolean)},[ge]),kt=m.useCallback(j=>({accept:"CARD_ENTRY",collect:w=>{var I,x;return{isOver:!!w.isOver(),canDrop:!!w.canDrop&&((x=(I=w.getItem())==null?void 0:I.item)==null?void 0:x.status)!==j}},drop:async({item:w})=>{if(!w.status||w.status!==j)try{await Q({variables:{input:{id:w.id,status:j}}})}catch(I){console.error("cardDropOptions-drop",I)}}}),[Q]),Ie=ps({form:ys}),St=m.useCallback(j=>({type:"CARD_ENTRY",item:{item:{...j},type:"CARD_ENTRY"},collect:w=>({isDragging:w.isDragging()})}),[]);console.log(">>TaskGrid/index::","state.tasks",i.tasks);const vt=G("NEW_TASK_FORM").on,Tt=G("TASK_DUE_DATE_FORMAT").value,bt=G("TASK_STATUS_PROGRESS"),[Ee]=os({filter:{taskId:{eq:f.tTaskEditId||""},archived:{ne:!0}}}),De=Vs(),wt=j=>{u(w=>{const I=(w==null?void 0:w.assignments)||{};return A(w,`assignments.${j}.id`)?I[j]={...I[j],archived:!0}:I[j]=void 0,a.current.saved=!1,{...w,assignments:I}})},Ct=j=>{!j||!(j!=null&&j.length)||u(w=>{const I=w.assignments||{};return j.map(x=>{if(I[x])return w;I[x]={userId:x}}),a.current.saved=!1,{...w,assignments:I}})},It=j=>{De.setState(w=>({...w,assignments:j}))};a.current.onChange=It,m.useEffect(()=>{var j;(j=a.current)==null||j.onChange(i.assignments)},[i.assignments]),m.useEffect(()=>{const j=Ee;if(!j.length)return u(I=>({...I,assignments:[]}));if(a.current.saved)return;const w=es(j,"userId");u(I=>({...I,assignments:w}))},[Ee]);const[Oe,he]=m.useState(Date.now()),Et=m.useCallback(j=>{he(j)},[]),[Le,Pe]=m.useState(0),Dt=j=>{Pe(j.target.value)},Me=ts("(min-width: 750px)"),Ot=G("LIST_KANBAN_VIEW").value;return e.jsx(ae.Provider,{value:{state:i,setState:u,actions:jt},children:e.jsxs("div",{className:C.root,children:[e.jsx(Lt,{children:"Tasks"}),e.jsxs(k,{display:"flex",justifyContent:"space-between",children:[e.jsx(k,{width:"350px",mb:1,mt:1,children:e.jsx(ss,{placeholder:"Search task or code (#)...",value:f.searchText,onChange:j=>{const w=j.target.value;g({searchText:w})}})}),e.jsxs(k,{display:"flex",alignItems:"center",children:[Me&&e.jsx(U,{loading:O.loading,variant:"contained",onClick:async()=>{await O.refetch(),await h()},children:"Refetch Data"}),e.jsx(k,{mr:1}),Me&&(n==null?void 0:n.status)!=="COMPLETED"&&e.jsx(U,{color:"primary",variant:"contained",startIcon:e.jsx(lt,{}),onClick:()=>{if(vt&&n){const j={project:{value:n==null?void 0:n.id,disabled:!0,readonly:!0,data:{text:n==null?void 0:n.name}}},w={opportunity:{value:b,disabled:!0,readonly:!0,data:{text:"This opportunity"}}};Ie.initializeForm(n?j:w,!0,{title:"ADD TASK",submitButtonText:"Create Task",action:"CREATE"})}else d.current.open()},children:"Create New Task"}),e.jsx(k,{mr:1}),!Ot&&e.jsxs(Ws,{className:C.toggle,size:"small",value:p,exclusive:!0,onChange:(j,w)=>{try{localStorage.setItem(ja,w)}catch{console.log("Something went wrong saving to localstorage.")}T(w)},children:[e.jsx(Ke,{value:"listView",size:"small",children:e.jsx(ga,{fontSize:"small"})}),e.jsx(Ke,{value:"cardView",size:"small",children:e.jsx(ns,{fontSize:"small"})})]})]})]}),e.jsx(ua,{}),e.jsx(k,{mb:1}),p==="cardView"?e.jsx(Hn,{data:i.tasks,cardDropOptions:kt,cardDragOptions:St}):e.jsx("div",{className:C.grid,children:e.jsx(qn,{loading:O.loading,columns:yt,data:i.tasks.sort(as("due",!0,!0)),grouperField:xe,expandedGroupIds:i.expandedStageIds,formatStageName:j=>{const w=A(i,["stageMapping",j.groupKey,"name"]);return console.log(">>task/TaskGrid::","v",w,i),w},rowRenderer:Jn,customSortKey:"startDate",grouperSortDirection:"desc",onSortChange:j=>{const w=["stageName"],I=["asc"];for(const M of j)w.push(M.columnKey),I.push(M.direction.toLowerCase());const x=w[0],P=ke(i.tasks,w.map(M=>Z=>{const J=Z[M]||"";switch(x){case"progress":case"taskDuration":return Number(J);default:return J}}),I);u(M=>({...M,tasks:P}))}})}),e.jsx(W,{ref:o,variant:"popover",anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},children:j=>(console.log({taskId:f,popperContext:j,state:i}),e.jsx(k,{p:2,children:e.jsx(pa,{taskId:f==null?void 0:f.tTaskEditId,assignments:i.assignments,onOptionSelected:Ct,handleOnDeleteAssign:wt,handleOnSaveAssign:async()=>{await De.save(f.tTaskEditId),await o.current.close(),await O.refetch(),re("Updated Successfully.",{variant:"success"}),g({tTaskEditId:null})}})}))}),e.jsx(W,{ref:c,variant:"popover",anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},children:()=>e.jsx(k,{children:e.jsx(it,{autoOk:!0,variant:"static",value:Oe,format:Tt,onChange:Et,onClear:()=>he(null),onAccept:async()=>{await Q({variables:{input:{id:f.tTaskEditId,due:Oe}}}),await c.current.close(),await g({tTaskEditId:""}),await O.refetch(),await re("Updated Successfully.",{variant:"success"})}})})}),e.jsx(W,{ref:l,variant:"popover",anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},children:()=>e.jsxs(k,{sx:{padding:1.5,display:"flex",alignItems:"center"},children:[e.jsx(at,{label:"Estimate",value:Le,onChange:Dt,margin:"dense",variant:"outlined",fullWidth:!0}),e.jsx(k,{sx:{position:"relative",marginLeft:1},children:e.jsx(B,{size:"small",sx:{backgroundColor:"success.light",color:"white","&:hover":{backgroundColor:"success.main"}},onClick:async j=>{j.stopPropagation(),await Q({variables:{input:{id:f.tTaskEditId,estimatedEffort:Le}}}),await l.current.close(),await g({tTaskEditId:""}),await O.refetch(),await re("Updated Successfully.",{variant:"success"})},children:e.jsx(ot,{})})})]})}),e.jsx(W,{ref:r,variant:"popover",anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},children:j=>e.jsx(ra,{popperContext:j,refetch:O.refetch,projectStatus:ge})}),e.jsx(js,{form:Ie,callback:()=>{O.refetch()}}),e.jsx(W,{variant:"dialog",ref:d,dialogProps:{},onClose:()=>{g({tTaskId:void 0})},children:e.jsx(Hs,{initialValues:y,id:f.tTaskId,onCancel:()=>{g({tTaskId:void 0})},readOnly:!1,onSubmit:async({id:j})=>{d.current.close(),console.log(">>task/Tasks::","id",j),console.log(">>task/Tasks::","refetching"),f.tTaskId||O.refetch()}})})]})})}const Ja=Object.freeze(Object.defineProperty({__proto__:null,default:ya},Symbol.toStringTag,{value:"Module"}));export{qs as A,on as G,Mn as K,ga as L,nn as T,Qs as a,qe as b,cn as c,rn as d,Hn as e,Ce as f,In as g,Zs as h,sn as i,en as j,Ys as k,ya as l,Ja as m,Cn as u};
