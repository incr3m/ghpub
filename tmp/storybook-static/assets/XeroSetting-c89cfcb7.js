import{j as e}from"./TransitionGroupContext-9d36972e.js";import{R as x}from"./index-f1f749bf.js";import{S as F}from"./Play-87fed129.js";import{S as $}from"./index-611aed03.js";import{a as q,x as j,X as G}from"./index-8edd7abf.js";import{au as O,av as E,L as k,a8 as z,ag as M,at as P,o as Q,a3 as B,a9 as H,B as l,bF as J,g as A,bG as W,p as L,aP as V,G as U,q as K,N as Y,Q as b}from"./papaparse.min-b66e70e7.js";import{b as Z}from"./index-bcfaa842.js";import{B as h}from"./Button-352c3435.js";import"./assertThisInitialized-ad1db8e7.js";import"./_commonjsHelpers-042e6b4d.js";import"./react-router-19e5b27c.js";import"./index-4d501b15.js";import"./tiny-invariant-dd7d57d2.js";import"./iframe-ed7f5a3f.js";import"../sb-preview/runtime.js";import"./filter-f99df4e5.js";import"./LocalizationProvider-a287304f.js";import"./_baseForOwn-9b89c4b6.js";import"./react-router-dom-60ea8218.js";import"./index-96c5f47c.js";import"./debounce-213cd46f.js";import"./uniq-0d482d7b.js";import"./_arrayIncludes-2cfb33ae.js";import"./cloneDeep-91467704.js";import"./isPlainObject-07477f89.js";import"./isNativeReflectConstruct-05c29d01.js";var X={},ee=E;Object.defineProperty(X,"__esModule",{value:!0});var w=X.default=void 0,te=ee(O()),ne=e;w=X.default=(0,te.default)((0,ne.jsx)("path",{d:"M19 9h-4V3H9v6H5l7 7zM5 18v2h14v-2z"}),"GetApp");function R(){return x.useContext(q)}const N="xero__";function oe(){const[r,c]=x.useState({opened:!1}),o=R();return console.log(">>IntegrationSetting/XeroContactsImporter::","ctx",o),e.jsxs(k,{text:"Contacts",children:[o.isConnected&&e.jsx(h,{variant:"outlined",size:"small",endIcon:e.jsx(w,{}),onClick:()=>{c(i=>({...i,opened:!0}))},children:"Import Xero Contacts"}),e.jsxs(z,{open:r.opened,onClose:()=>{c(i=>({...i,opened:!1}))},children:[e.jsx(M,{children:"Import Contacts"}),e.jsx(ae,{onDone:()=>{c(i=>({...i,opened:!1}))}})]})]})}function ae(r){const[c,o]=x.useState({loading:!1}),{globalState:{authUser:i}}=P(),p=Q(),{enqueueSnackbar:g}=Z();async function I(t){for(const s of J(t,24)){let a="";t.forEach((n,y)=>{const m=N+n.ContactID;a+=`
      x_${y}: getCompany(id:${JSON.stringify(m)}){id,integrations}`});const d=await p.query({query:A`{${a}}`});console.log(">>IntegrationSetting/XeroContactsImporter::","companiesQ",d);const f=d.data||{},u=[];if(s.forEach((n,y)=>{const m=f[`x_${y}`];let T=!1;const _={code:"xero",contactID:n.ContactID,contact:{emailAddress:n.EmailAddress,contactID:n.ContactID,name:n.Name}},D=((m==null?void 0:m.integrations)||[]).map(v=>{let C=JSON.parse(v);return C.code==="xero"&&(T=!0,C={...C,..._}),C});T||D.push(_),u.push({id:N+n.ContactID,name:n.Name,accountManagerId:i.id,integrations:D.map(v=>JSON.stringify(v)),__typename:"Company",__op:m?"update":"create"})}),console.log(">>IntegrationSetting/XeroContactsImporter::","input",u),u.length>0){const n=W(...u);await p.mutate({mutation:A`
          mutation (
            ${n==null?void 0:n.args}
          ){
            ${n==null?void 0:n.body}
          }
          `,variables:{...n==null?void 0:n.vars}})}}}async function S(){o(d=>({...d,loading:!0}));let t=!0,s=0,a=0;do{const d=++s,f=await j({index:"accountingApi",type:"getContacts",body:({tenantId:n})=>({args:[n,null,null,null,null,d]})});console.log(">>IntegrationSetting/XeroContactsImporter::","contacts",f);const u=f.Contacts||[];await I(u),a+=u.length,t=u.length>0}while(t);g(`Successfully imported ${a} contacts`,{variant:"success"}),o(d=>({...d,loading:!1})),r.onDone&&r.onDone()}return c.loading?e.jsx(B,{}):e.jsxs(H,{children:[e.jsxs(l,{component:"p",whiteSpace:"pre",children:["This will import ",e.jsx("strong",{children:"all your contacts in Xero"}),". Do you want to proceed?"]}),e.jsxs(l,{style:{display:"flex",flexFlow:"row-reverse",columnGap:"10px",paddingBottom:"10px"},children:[e.jsx(h,{variant:"contained",color:"primary",onClick:S,children:"Proceed"}),e.jsx(h,{variant:"outlined",children:"Cancel"})]})]})}function se(){const[r,c]=x.useState({loading:!1,searchText:""}),o=R(),{values:i,setFieldValue:p}=L(),g=(i==null?void 0:i.accounts)||[];console.log(">>IntegrationSetting/XeroSetting::","ctx",o,i);const I=x.useCallback(async()=>{c(a=>({...a,loading:!0}));const[t,s]=await Promise.all([j({index:"accountingApi",type:"getAccounts",body:({tenantId:a})=>({args:[a]})}),j({index:"accountingApi",type:"getTaxRates",body:({tenantId:a})=>({args:[a]})})]);console.log(">>IntegrationSetting/XeroSetting::","acctData",t,s),t!=null&&t.Accounts&&(p("accounts",V(t==null?void 0:t.Accounts,"Code")),p("taxRates",s==null?void 0:s.TaxRates),c(a=>({...a,loading:!1})))},[p]);console.log(">>IntegrationSetting/XeroSetting::","state",r);const S=(o==null?void 0:o.tenants)&&(o==null?void 0:o.tenants.length)>0;return e.jsxs(e.Fragment,{children:[e.jsxs(l,{maxWidth:"400px",children:[o.initializing?e.jsx(B,{}):e.jsxs(l,{display:"flex",alignItems:"center",children:[e.jsx(l,{width:"300px",mr:1,children:e.jsx(U,{fullWidth:!0,label:"Organisation",value:o.selectedTenantId,readOnly:!0,onChange:t=>{const s=t.currentTarget.value;o.setTenantId(s)},options:o.tenants.map(t=>({value:t.tenantId,text:t.tenantName}))})}),!S&&e.jsx(h,{size:"small",variant:"contained",color:"primary",onClick:()=>{j({index:"getTenants"})},children:"Connect"})]}),e.jsx(l,{mt:2,width:"300px",children:e.jsx(F,{name:"defaultAcctCode",label:"Default Account Code",options:g.map(t=>({label:`${t.Name} [${t.Code}]`,value:t.Code}))})})]}),e.jsx(oe,{}),e.jsx(k,{mt:1,text:e.jsxs(l,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[e.jsxs("span",{children:["Account Codes",e.jsx(l,{ml:1,component:"span",children:o.isConnected&&e.jsx(h,{variant:"outlined",size:"small",disabled:r.loading,endIcon:e.jsx(w,{}),onClick:I,children:"Get Accounts"})})]}),g.length>0&&e.jsx(K,{name:"code",placeholder:"Search...",onChange:t=>{const s=t.target.value;c(a=>({...a,searchText:s}))},margin:"dense",variant:"outlined",fullWidth:!0})]}),children:e.jsx(l,{height:"450px",overflow:"auto",children:e.jsxs(Y,{data:g.filter(t=>{var s,a;return r.searchText?t.Code===r.searchText||((s=t.Name)==null?void 0:s.includes(r.searchText))||((a=t.Description)==null?void 0:a.includes(r.searchText)):!0}),children:[e.jsx(b,{dataId:"Code",width:"150px"}),e.jsx(b,{dataId:"Name",width:"300px"}),e.jsx(b,{dataId:"Description"})]})})})]})}function ke(){return e.jsx(G,{children:e.jsx($,{withHeader:!1,code:"integration-xero-setting",module:"core",children:e.jsx(se,{})})})}export{ke as default};
