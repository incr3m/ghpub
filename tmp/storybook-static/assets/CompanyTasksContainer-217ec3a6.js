import{j as s}from"./TransitionGroupContext-9d36972e.js";import{R as te,r as l}from"./index-f1f749bf.js";import{K as se,u as E,cc as re,cd as ae,f as G,ce as oe,m as ne,bo as ie,X as N,B as C,i as ce,aq as T,z as y,D as le,cf as ue,T as de,v as me,w as I}from"./papaparse.min-b66e70e7.js";import{L as P,V as pe,a as ge}from"./ExpenseView-2f5d1473.js";import{P as he}from"./ProjectLink-987015ba.js";import{a as je,b as xe,c as fe,G as be,T as Te,d as Ce,e as ke}from"./index-9d3afdfc.js";import{K as Se,N as ye,T as Pe}from"./Play-87fed129.js";import{n as Me,q as ve,r as Ie}from"./pick-dba65392.js";import{E as Ee}from"./SortUpIcon-3aecf5f0.js";import{b as Le,u as K}from"./index-bcfaa842.js";import{T as Ae}from"./TaskStatusPrompt-5fa87980.js";import{B as w}from"./Button-352c3435.js";import{L as _e}from"./LoadingButton-f7387eca.js";import"./assertThisInitialized-ad1db8e7.js";import"./_commonjsHelpers-042e6b4d.js";import"./_arrayIncludes-2cfb33ae.js";import"./_baseForOwn-9b89c4b6.js";import"./index-96c5f47c.js";import"./isPlainObject-07477f89.js";import"./debounce-213cd46f.js";import"./iframe-ed7f5a3f.js";import"../sb-preview/runtime.js";import"./index-4d501b15.js";import"./TableRow-00aadd87.js";import"./filter-f99df4e5.js";import"./LocalizationProvider-a287304f.js";import"./TableHead-dd1583ce.js";import"./Save-b67fa0ac.js";import"./MenuOptions-0bc3bb51.js";import"./index-79afbab1.js";import"./TaskAssignees-858ea3c9.js";import"./Check-78df5e8e.js";import"./Skeleton-cd6f071e.js";import"./useFetchMore-be228481.js";import"./bundle-053bdffd.js";import"./MilestoneIcon-61fb6e69.js";import"./DragIndicator-582939ba.js";import"./capitalize-c31f38e2.js";import"./Trash-822e65ce.js";import"./index.esm-bf21a293.js";import"./index-f70ce446.js";import"./index-5d349c56.js";import"./TaskForm-863cdb73.js";import"./SelectEsModelInput-d580a9f7.js";import"./useIncludeFieldNames-35a180a9.js";import"./RepeatFields-8275ed19.js";import"./useBeforeSave-e049f6dd.js";import"./Alert-fd9a067a.js";import"./useTaskAssignees-9f1fd5d3.js";import"./Add-be7f5660.js";import"./EstimateEditorPopover-b8debf9a.js";import"./AssigneeEditorPopover-2b4e6473.js";import"./isNativeReflectConstruct-05c29d01.js";import"./searchUsers-04324aeb.js";import"./ToggleButtonGroup-93d9af56.js";import"./react-router-19e5b27c.js";import"./tiny-invariant-dd7d57d2.js";import"./react-router-dom-60ea8218.js";import"./uniq-0d482d7b.js";import"./cloneDeep-91467704.js";import"./index-61adb48a.js";import"./useGetProjectSummaryFields-0ab32aca.js";import"./Link-c687dc07.js";import"./index-147ad7aa.js";function De({value:t,onChange:a,label:n,icon:d}){const c=te.useCallback(e=>{const r=e.currentTarget.value;a(r)},[a]);return s.jsx(se,{value:t,shrinkLabel:!0,variant:"default",label:n,model:"Project",fullWidth:!0,onChange:c,icon:d})}const He=t=>{const a=E(re,{...t});return[l.useMemo(()=>{var c,e;return((e=(c=a.data)==null?void 0:c.result)==null?void 0:e.items)||[]},[a.data]),a]},Re=t=>{const a=E(ae,{variables:{id:t}});return[l.useMemo(()=>{var c,e,r;return((r=(e=(c=a.data)==null?void 0:c.company)==null?void 0:e.projects)==null?void 0:r.items)??[]},[a.data]),a]},ze=(t,{must:a=[]}={})=>{const n=G({key:"ElasticSearchProjectsTasksCount",index:"task",skip:!t.length,cached:!0,body:{size:0,query:{bool:{must:[{bool:{should:t.map(c=>({term:{"projectId.keyword":c.id}}))}},...a].filter(Boolean),must_not:{term:{archived:!0}}}}}});return[l.useMemo(()=>{var c,e;return((e=(c=n==null?void 0:n.result)==null?void 0:c.hits)==null?void 0:e.total)||0},[n.result]),n]},Ve=t=>{const a=G({key:"ElasticSearchTasksTotalDurations",index:"interval",cached:!0,body:{size:0,query:{bool:{must:[{bool:{should:t.map(d=>({term:{"taskId.keyword":d.id}}))}}]}},aggs:{per_task:{terms:{field:"taskId.keyword",size:t.length},aggs:{sum_all_duration:{sum:{field:"durationMs"}}}}}}});return[l.useMemo(()=>{var e,r,u;const d=((u=(r=(e=a.result)==null?void 0:e.aggregations)==null?void 0:r.per_task)==null?void 0:u.buckets)||[];return Object.fromEntries(d.filter(Boolean).map(i=>{var x;const m=((x=i.sum_all_duration)==null?void 0:x.value)||0,p=Number(m/1e3/60/60).toFixed(2);return[i.key,p]}))||{}},[a.result]),a]},We=t=>{const a=E(oe,{variables:{id:t},fetchPolicy:"cache-first"});return[l.useMemo(()=>{var d,c,e;return((e=(c=(d=a==null?void 0:a.data)==null?void 0:d.result)==null?void 0:c.userAssignments)==null?void 0:e.items)??[]},[a.data]),a]},qe=({id:t,...a})=>{const[n]=We(t);return s.jsx(je,{users:n,...a})},B=({progress:t})=>{const a=l.useMemo(()=>t>100?Me:ve,[t]),n=t>100?100:t;return s.jsx(Ie,{variant:"determinate",value:n,size:100,barColor:a})},Be=ne(t=>({root:{height:"40px",marginTop:"5px",borderColor:t.palette.primary.light,borderWidth:"2px !important",color:t.palette.primary.main,"&.MuiButton-outlined:hover":{backgroundColor:t.palette.primary.light},"& svg":{marginLeft:"5px"}}})),O=({id:t,status:a,onStatusChange:n})=>{const d=Be(),c=ie(),[e]=Se(t,{fetchPolicy:"network-only",skip:!t}),{enqueueSnackbar:r}=Le(),[u,{loading:i}]=ye({variables:{input:{id:t,status:a}},onCompleted:()=>{r(`Task status set to ${a}.`,{variant:"info"}),n==null||n(e)},onError:h=>{console.log(h),r(`Failed to set status to ${a} on task.`,{variant:"error"})}}),m=l.useCallback(async()=>{!t||!await c({options:{width:"400px"},content:f=>s.jsx(Ae,{promptContext:f,task:e,status:a})})||await u()},[t,u,c,a,e]),p=l.useMemo(()=>!t||i,[t,i]),x=l.useMemo(()=>`Set task status as "${a}"`,[a]);return s.jsx(N,{title:x,children:s.jsx(w,{className:d.root,variant:"outlined",disabled:p,onClick:m,children:a})})},Oe=({tasks:t,tasksDurations:a,...n})=>{const d=K("TASK_STATUS_PROGRESS"),c=l.useMemo(()=>[{Header:"Title",accessor:"title",Cell:({row:e})=>{var r;return s.jsx(C,{sx:!((r=e.original)!=null&&r.estimatedEffort)&&{borderLeft:"4px solid #ec64a6"},pl:2,children:s.jsx(Pe,{id:e.original.id})})}},{Header:"Project",accessor:"projectId",Cell:({value:e})=>s.jsx(he,{id:e}),disableSortBy:!0},{Header:"Assignees",id:"assignees",Cell:({row:e,iconOnly:r})=>{var u;return s.jsx(qe,{id:(u=e.original)==null?void 0:u.id,iconOnly:r})},disableSortBy:!0},{Header:"Type",accessor:"type"},{Header:"Status",accessor:"status",Cell:({value:e})=>s.jsx(xe,{status:e})},{Header:"Start Date",accessor:"start",Cell:P},{Header:"Do Date",accessor:"do",Cell:P},{Header:"Due Date",accessor:"due",Cell:P},{Header:"Invoice Date",accessor:"invoiceSetting",Cell:({value:e})=>(e==null?void 0:e.invoiceDate)&&s.jsx(P,{value:e==null?void 0:e.invoiceDate})},{Header:"Progress",accessor:"progress",Cell:({value:e,row:r,tasksDurations:u})=>{var m;if(d)return s.jsx(B,{progress:(r==null?void 0:r.progress)||0});const i=u!=null&&u[r.original.id]?(u==null?void 0:u[r.original.id])/(((m=r.original)==null?void 0:m.estimatedEffort)||1)*100:e;return s.jsx(B,{progress:i})},disableSortBy:!0},{Header:"Priority",accessor:"priority",Cell:({row:e})=>{var r;return s.jsx(C,{children:((r=e.original)==null?void 0:r.priority)||""})}},{Header:"Actual / Estimate",id:"velocity",Cell:({row:e,tasksDurations:r})=>{var u;return s.jsxs(C,{children:[(r==null?void 0:r[e.original.id])||0," / ",(u=e.original)==null?void 0:u.estimatedEffort," hr"]})},disableSortBy:!0},{Header:"Actions",id:"actions",Cell:({row:e,onEdit:r,onStatusChange:u})=>{var i,m,p,x,h,f;return s.jsxs(C,{children:[s.jsx(fe,{task:e.original,taskId:(i=e.original)==null?void 0:i.id,projectId:(m=e.original)==null?void 0:m.projectId}),typeof r=="function"&&s.jsx(N,{title:"Edit",children:s.jsx(ce,{size:"small",onClick:()=>r==null?void 0:r(e.original),children:s.jsx(Ee,{})})}),s.jsx(be,{task:e.original}),((p=e.original)==null?void 0:p.status)==="COMPLETE"&&s.jsx(O,{id:(x=e.original)==null?void 0:x.id,status:"IDLE",onStatusChange:u}),((h=e.original)==null?void 0:h.status)!=="COMPLETE"&&s.jsx(O,{id:(f=e.original)==null?void 0:f.id,status:"COMPLETE",onStatusChange:u})]})},disableSortBy:!0}],[]);return s.jsx(pe,{stickyHeader:!0,data:t,columns:c,tasksDurations:a,...n})},Ge=({tasks:t,tableRef:a,initialState:n,searchValue:d="",onSearch:c,onFilter:e,filters:r,refetchData:u,...i})=>{const[m,p]=l.useState("list"),x=l.useCallback(()=>{var b;const j=(n==null?void 0:n.pageIndex)+1;(t==null?void 0:t.length)>=i.totalCount||(b=i.onPageChange)==null||b.call(i,j)},[n==null?void 0:n.pageIndex,i,t==null?void 0:t.length]),h=l.useMemo(()=>m==="kanban",[m]),f=l.useMemo(()=>m==="list",[m]),M=K("LIST_KANBAN_VIEW").value;return s.jsxs(C,{children:[s.jsxs(T,{mb:2,container:!0,spacing:2,alignItems:"center",justifyContent:"space-between",children:[s.jsxs(T,{item:!0,sx:{display:"flex",flexDirection:"row",justifyContent:"flex-start",columnGap:2},children:[s.jsx(y,{minWidth:300,children:s.jsx(le,{placeholder:"Search task by title or code",value:d,onChange:j=>{c==null||c(j.target.value)}})}),s.jsx(y,{minWidth:200,children:s.jsx(Te,{value:r==null?void 0:r.status,label:"Status",onChange:j=>{e==null||e(j,"status")}})}),s.jsx(y,{minWidth:200,children:s.jsx(De,{value:r.projectId,onChange:j=>{e==null||e(j,"projectId")},label:"Project"})}),s.jsx(y,{minWidth:200,children:s.jsx(Ce,{value:r.type,onChange:j=>{e==null||e(j,"type")}})})]}),s.jsxs(T,{spacing:2,item:!0,container:!0,justifyContent:"flex-end",children:[s.jsx(T,{item:!0,children:s.jsx(w,{variant:"contained",onClick:u,disabled:i==null?void 0:i.loading,children:"Refetch Data"})}),s.jsx(T,{item:!0,children:!M&&s.jsx(ue,{value:m,onChange:(j,b)=>p(b)})})]})]}),h&&s.jsxs(C,{children:[s.jsxs(T,{container:!0,spacing:2,justifyContent:"space-between",alignItems:"center",children:[s.jsx(T,{item:!0,children:s.jsx(C,{children:s.jsxs(de,{variant:"h6",style:{fontSize:"16px",fontWeight:"bold"},children:["Tasks Shown ( ",(t==null?void 0:t.length)||0," / ",i.totalCount," )"]})})}),s.jsx(T,{item:!0,children:s.jsx(_e,{variant:"contained",disabled:(t==null?void 0:t.length)>=i.totalCount,loading:i.loading,onClick:x,children:"Show More"})})]}),s.jsx(ke,{data:t})]}),f&&s.jsx(Oe,{tasks:t,hasPagination:!0,hasFilter:!0,hasSort:!0,tableRef:a,initialState:n,...i})]})},Zt=({companyId:t})=>{var z,V,W,q;const a=l.useRef(),[n,{loading:d}]=Re(t),[c,e]=l.useState({pageSize:10,pageIndex:0,sortBy:[{id:"updatedAt",desc:!1}]}),[r,u]=l.useState(""),[i,m]=l.useState(""),[p,x]=me({status:I,projectId:I,type:I}),h=l.useMemo(()=>r==null?void 0:r.startsWith("#"),[r]);ge(()=>{m(r),e(o=>({...o,pageIndex:0}))},500,[r]);const f=l.useMemo(()=>{if(!i)return[];if(h)return[{code:{eq:i.replace("#","")}}];const o={matchPhrasePrefix:`*${i}*`};return[{title:o},{description:o},{code:o}]},[h,i]),M=l.useMemo(()=>{if(i)return{or:f}},[f,i]),j=l.useMemo(()=>n.map(o=>({projectId:{eq:o.id}})),[n]),b=l.useMemo(()=>p?Object.entries(p).filter(([,o])=>!!o):[],[p]),L=l.useMemo(()=>b.map(([o,g])=>({[o]:{eq:g}})),[b]),A=l.useMemo(()=>[{bool:{must:b.map(([o,g])=>({term:{[`${o}.keyword`]:g}}))}}],[b]);console.log({qParams:p,queryParamsFilter:L,elasticSearchParamsFilter:A});const[_,{fetchMore:D,loading:U,refetch:k}]=He({variables:{filter:{or:[...j],and:[{archived:{ne:!0}},M,...L].filter(Boolean)},limit:c.pageSize,skip:!n.length||!t,sort:{field:(V=(z=c.sortBy)==null?void 0:z[0])==null?void 0:V.id,direction:(q=(W=c.sortBy)==null?void 0:W[0])!=null&&q.desc?"desc":"asc"}},notifyOnNetworkStatusChange:!0}),Q=l.useMemo(()=>{if(!i)return[];const o=h?i.replace("#",""):i;return[{bool:{should:(h?["code"]:["title","code","description"]).map(S=>({match_phrase_prefix:{[S]:o}}))}}]},[h,i]),[H,{loading:$,refetch:v}]=ze(n,{must:[...A,...Q]});console.log({companyTasksCount:H});const[F]=Ve(_),X=U||d||$,J=l.useCallback(async o=>{e(g=>({...g,pageIndex:o})),D({variables:{from:o*c.pageSize}})},[D,c.pageSize]),Y=l.useCallback(o=>{e(g=>({...g,pageSize:o}))},[]),Z=l.useCallback(async o=>{var g,S;e(ee=>({...ee,sortBy:o})),k({sort:(o==null?void 0:o.length)&&{field:(g=o==null?void 0:o[0])==null?void 0:g.id,direction:(S=o==null?void 0:o[0])!=null&&S.desc?"desc":"asc"}})},[k]),R=l.useCallback(()=>{k(),v()},[k,v]);return console.log({tableRef:a}),s.jsx(Ge,{tasks:_,loading:X,onPageChange:J,onPageSizeChange:Y,onSort:Z,totalCount:H,tasksDurations:F,initialState:c,tableRef:a,searchValue:r,onSearch:o=>u(o),filters:p,onFilter:(o,g)=>{x({[g]:o}),a.current.setFilter(g,o),k(),v()},onStatusChange:R,refetch:R,autoResetPage:!0})};export{Zt as CompanyTasksContainer,Zt as default};
