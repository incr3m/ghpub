import{j as u}from"./TransitionGroupContext-9d36972e.js";import{R as c}from"./index-f1f749bf.js";import{bJ as f,bx as x,l as b,b as w,$ as m,bK as C,a8 as I,B as p}from"./papaparse.min-b66e70e7.js";import{j as X}from"./_baseForOwn-9b89c4b6.js";import{A as S,v as T}from"./Play-87fed129.js";import{B as q}from"./Button-352c3435.js";const y="/xero/callback",k=window.origin+y,v={initializing:!1,tenantId:null,isConnected:!1},s=v;async function A(){if(s.isConnected)return;const i=1e3,o=i*200;let n=0;do await w.delay(i),n+=i;while(!s.isConnected&&n<o);if(!s.isConnected)throw Error("Timeout")}async function h({index:i,type:o="",body:n={},requireAuth:t=!0}){t&&!s.initializing&&!s.isConnected&&f.dispatch("xero-auth-expired"),t&&await A();const r={...s,...X(n)?n(s):n};console.log(">>xero/xero::","client",i,r);const l=await x.query({query:b`
      query($index: String!, $type: String!, $body: AWSJSON) {
        xeroQuery(index: $index, type: $type, body: $body)
      }
    `,variables:{index:i,type:o,body:JSON.stringify(r)},fetchPolicy:"network-only"});return console.log(">>xero/xero::","client done",i,l),JSON.parse(l.data.xeroQuery||"{}")}function J(i){const o=c.useRef({});o.current=i,m(async n=>{const t=await h({index:"getTenants",requireAuth:!1});if(console.log(">>xero/useXeroInit::","tenants",t),t.errors){o.current.onError(t.errors);return}t.length&&n()&&o.current.onCompleted(t)},[]),c.useEffect(()=>{const n=S.graphql(T(`
        subscription {
          onUpdateSetting {
            id
            value
          }
        }
      `)).subscribe({next:t=>{var e;console.log(">>xero/useXeroInit::","data",t);const r=(e=t.value.data)==null?void 0:e.onUpdateSetting;if((r==null?void 0:r.id)!=="integration-xero-setting")return;const l=JSON.parse(r.value||"{}");o.current.onSettingsUpdated(l)}});return()=>{n.unsubscribe()}},[])}async function P(i){var t;const n=((t=(await x.query({query:C,variables:{id:i}})).data)==null?void 0:t.result)||null;return n?JSON.parse(n.value):null}const B=c.createContext();let d;function O(i){const o=c.useRef({authenticating:!1}),[n,t]=c.useState({initializing:!0,tenants:[],selectedTenantId:null,showXeroRequiredPrompt:!1,showXeroBlock:!1});J({async onCompleted(e){console.log(">>XeroContainer/index::","tenants",e);const a=await P("integration-xero-setting");console.log(">>XeroContainer/index::","setting",a),t(g=>({...g,initializing:!1,tenants:e,selectedTenantId:a.connectedTenantId})),a.connectedTenantId&&e.length&&(s.tenantId=a.connectedTenantId)},async onSettingsUpdated(e){const a=await h({index:"getTenants",requireAuth:!1});console.log(">>XeroContainer/index::","tenants",a,e),t(g=>({...g,initializing:!1,tenants:a,selectedTenantId:e.connectedTenantId})),e.connectedTenantId&&a.length&&(s.tenantId=e.connectedTenantId),d&&!d.closed&&d.close()},onError(){t(e=>({...e,initializing:!1,tenants:[],selectedTenantId:null}))}});const r={...n};r.clearAuth=c.useCallback(()=>{t(e=>({...e,selectedTenantId:null}))},[]);const l=c.useCallback(async()=>{if(o.current.authenticating)return;o.current.authenticating=!0,t(a=>({...a,showXeroRequiredPrompt:!0}));const e=await h({index:"auth",body:{redirect:k},requireAuth:!1});(e||e.consentUrl)&&(d=window.open(e.consentUrl),d||alert("Please enable popup prompt")),o.current.authenticating=!1,t(a=>({...a,showXeroRequiredPrompt:!1}))},[]);return r.auth=l,r.isConnected=n.tenants&&n.tenants.length>0&&!!n.selectedTenantId,s.initializing=n.initializing,s.isConnected=r.isConnected,c.useEffect(()=>{if(!f)return;const e=()=>{o.current.authenticating||l().then(async()=>{await w.delay(1e3)})};return f.listen("xero-auth-expired",e),()=>{f.remove("xero-auth-expired",e)}},[l]),r.setTenantId=c.useCallback(()=>{},[]),window.location.pathname===y?null:u.jsxs(B.Provider,{value:r,children:[i.children,(n.showXeroRequiredPrompt||n.showXeroBlock)&&u.jsx(I,{open:!0,children:n.showXeroBlock?u.jsxs(p,{p:2,children:["This page require Xero enabled."," ",u.jsx(q,{variant:"outlined",onClick:()=>{window.history.back(),t(e=>({...e,showXeroBlock:!1}))},children:"Go Back"})]}):u.jsx(p,{p:2,children:"Authenticating Xero..."})})]})}export{O as X,B as a,h as x};
