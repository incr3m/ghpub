import{j as e}from"./TransitionGroupContext-9d36972e.js";import{R as f}from"./index-f1f749bf.js";import{u as L,e as G,a as K,F as z,o as W}from"./pick-dba65392.js";import{a as Q,r as U,w as H,t as Y,e as S,S as y}from"./Play-87fed129.js";import{aW as B,ak as R,a2 as M,bx as Z,by as X,u as ee,g as te,B as r,Z as se,m as ie,p as k,aw as re,o as ae,at as ne,l as V,Y as le,ab as oe,A as P,h as g,aC as q,T as I,V as ue,a as de}from"./papaparse.min-b66e70e7.js";import{S as C,C as T}from"./SelectEsModelInput-d580a9f7.js";import{p as _}from"./_arrayIncludes-2cfb33ae.js";import{g as v}from"./_baseForOwn-9b89c4b6.js";import{u as w}from"./useIncludeFieldNames-35a180a9.js";import{R as ce,a as me}from"./RepeatFields-8275ed19.js";import{T as pe}from"./TaskAssignees-858ea3c9.js";import{u as fe}from"./useTaskAssignees-9f1fd5d3.js";import{u as $}from"./index-bcfaa842.js";import"./index-96c5f47c.js";import{u as be}from"./useBeforeSave-e049f6dd.js";function xe(){const[s,n]=f.useState({enabled:!1});return w([ce]),e.jsxs("div",{children:[s.enabled&&e.jsx(B,{mt:1}),e.jsx(R,{checked:s.enabled,onChange:(i,a)=>{n(d=>({...d,enabled:a}))},label:"Repeating Task"}),s.enabled&&e.jsx(me,{triggerKey:"repeatable-task-create",recordType:"Task",dateField:"start"}),s.enabled&&e.jsx(B,{mt:2})]})}function he(){var m,h;const{id:s,isReadOnly:n,data:i}=Q(),a=fe(),d=i==null?void 0:i.projectId,o=$("TASK_EDITABLE_ON_PROJECT_COMPLETE").on,{data:u}=M({queryKey:["GET_PROJECT_DETAILS",{projectId:d}],queryFn:async()=>await Z.query({query:X,variables:{id:d},fetchPolicy:"network-only"})});return L(async function(j){await a.save(j.id)}),e.jsx(pe,{id:s,isCompleted:((h=(m=u==null?void 0:u.data)==null?void 0:m.getProject)==null?void 0:h.status)==="COMPLETED"&&!o,saved:a.isSaved,readOnly:n,onAssignementsChanged:l=>{a.setState(j=>({...j,assignments:l}))}})}function je({projectId:s,fetchPolicy:n,parseData:i}){const a=ee(te`
      query($projectId: ID!) {
        getProject(id: $projectId) {
          id
          name
          color
          trafficLight
          status
          billable
          description
          overallEstimate
          integrations
          basisOfCertification
          attributes
          descriptionOfAspectsCertified
          engineeringFields
          buildingCertifierName
          buildingCertifierReferenceNumber
          developmentalApprovalNumber
        }
      }
    `,{variables:{projectId:s},fetchPolicy:n||"cache-first",nextFetchPolicy:"cache-first"});return f.useMemo(()=>{if(!a)return{};const o=v(a,"data.getProject")||{};return i?i(o):o},[a])}function ye(){const[s,n]=f.useState({showAll:!1});return e.jsxs("div",{children:[e.jsx(r,{mb:1,children:e.jsx(R,{checked:s.showAll,onChange:(i,a)=>{console.log(">>task/TaskForm::","showAll",a),n(d=>({...d,showAll:a}))},label:"Show All Fields"})}),s.showAll&&e.jsxs(e.Fragment,{children:[e.jsx(Ie,{}),e.jsx(r,{mt:2})]})]})}const ge=H(se),Se=ie(s=>({root:{display:"flex",flexWrap:"wrap",overflow:"auto",minHeight:40,"& > *":{margin:s.spacing(.5)}},chips:{display:"flex",flexWrap:"wrap"},chip:{margin:2},chipLabel:{fontSize:14}}));function Ie(){var E,F,N,A;const s=Se(),[n]=le(["kwTaskTypeList","kwTaskStatusList","kwTaskPriorityList"]),{values:i,setFieldValue:a}=k(),[d,o]=f.useState(""),u=je({projectId:i==null?void 0:i.projectId}),[m]=oe("project-setting",{withQueryState:!0}),l=(({descriptionOfAspectsCertified:t,basisOfCertification:c,engineeringFields:p,...x})=>{if(Object.keys(u).length>1||!u)return{...x,descriptionOfAspectsCertified:JSON.parse(t),basisOfCertification:JSON.parse(c),engineeringFields:JSON.parse(p)}})(u),j=(t,c)=>{if(t)return c==null?void 0:c.filter(x=>{var D;return t==null?void 0:t.includes((D=x.id)==null?void 0:D.toUpperCase())})},J=(t,c)=>t&&c?t.find(p=>p.id===c):null,b=(i==null?void 0:i.aspectOfWork)&&J(W,i==null?void 0:i.aspectOfWork)||null;f.useEffect(()=>{b&&a("basisOfCertification",b==null?void 0:b.section3)},[b]),be(t=>{const c={...t};return t!=null&&t.buildingStructureOptions&&(c.buildingStructureOptions=JSON.stringify(c.buildingStructureOptions)),t!=null&&t.basisOfCertification&&(c.basisOfCertification=JSON.stringify(c.basisOfCertification)),t!=null&&t.classBuildingStructure&&(c.classBuildingStructure=JSON.stringify(c.classBuildingStructure)),c});const O=$("SELECTFIELDINPUT_FIELD").value;return e.jsxs(e.Fragment,{children:[e.jsx(T,{fieldName:"description",label:"Description",fullWidth:!0,multiline:!0}),e.jsx(r,{mb:1}),e.jsx(r,{mb:1}),e.jsxs(r,{display:"flex",justifyContent:"space-between",mt:1,children:[e.jsx(S,{type:"date",fullWidth:!0,name:"start",label:"Start Date"}),e.jsx(r,{width:"15px"})]}),e.jsx(r,{mb:1}),e.jsx(S,{type:"date",fullWidth:!0,name:"do",label:"Do Date"}),e.jsxs(r,{display:"flex",justifyContent:"space-between",mt:1,children:[e.jsx(T,{fieldName:"estimatedEffort",label:"Est Effort (hrs)",fullWidth:!0}),e.jsx(r,{ml:1,width:"400px",children:!O&&e.jsx(y,{name:"status",label:"Status",options:n.kwTaskStatusList.map(t=>({value:t,label:t}))})}),O&&e.jsx(r,{ml:1,width:"400px",children:e.jsx(y,{name:"type",label:"Type",options:n.kwTaskTypeList.map(t=>({value:t,label:t})),getTypeValue:t=>o(t)})})]}),e.jsx(r,{mb:1}),O&&e.jsx(y,{name:"status",label:"Status",options:n.kwTaskStatusList.map(t=>({value:t,label:t}))}),e.jsx(r,{mb:1}),e.jsx(y,{name:"priority",label:"Priority",options:(n.kwTaskPriorityList||[]).map(t=>({value:t,label:t}))}),e.jsx(r,{mb:1}),!(i!=null&&i.projectId)&&e.jsxs(e.Fragment,{children:[e.jsx(C,{fullWidth:!0,dataId:"opportunityId",model:"Opportunity",label:"Opportunity"}),e.jsx(r,{mb:1})]}),e.jsx(Oe,{}),e.jsx(r,{mb:2}),d==="INSPECTION"&&e.jsx(e.Fragment,{children:l&&(m==null?void 0:m.engineering)&&e.jsxs(e.Fragment,{children:[e.jsx(y,{name:"aspectOfWork",label:"Aspect of Work",options:(E=j(l==null?void 0:l.descriptionOfAspectsCertified,W))==null?void 0:E.map(t=>({value:t.id,label:t.id}))}),e.jsx(r,{mb:2}),e.jsx(P,{multiple:!0,id:"tags-outlined",options:((F=m==null?void 0:m.buildingStructureOptions)==null?void 0:F.filter(t=>{if(!t.archived)return t}))||[],getOptionLabel:t=>t.text,filterSelectedOptions:!0,onChange:(t,c)=>{const p=[];c.map(x=>{p.push(x.text)}),a("buildingStructureOptions",p)},renderInput:t=>e.jsx(g,{fullWidth:!0,...t,label:"Building/Structure Options"})}),e.jsx(r,{mb:2}),e.jsx(P,{multiple:!0,id:"tags-outlined",options:((N=m==null?void 0:m.classBuildingStructure)==null?void 0:N.filter(t=>{if(!t.archived)return t}))||[],getOptionLabel:t=>t.text,filterSelectedOptions:!0,onChange:(t,c)=>{const p=[];c.map(x=>{p.push(x.text)}),a("classBuildingStructure",p)},renderInput:t=>e.jsx(g,{fullWidth:!0,...t,label:"Class of Building/Structure"})}),e.jsx(r,{mb:2}),(m==null?void 0:m.engineering)&&e.jsxs(e.Fragment,{children:[e.jsxs(q,{className:s.root,children:[e.jsx(r,{mt:2}),e.jsx(I,{style:{fontSize:13,fontWeight:"bold"},children:"Basis of Certification"}),(A=b==null?void 0:b.section3)==null?void 0:A.map((t,c)=>e.jsx(ue,{label:t},`${c}`)),e.jsx(r,{mb:2})]}),e.jsx(r,{mb:2}),e.jsx(q,{children:e.jsxs(r,{p:1,children:[e.jsx(I,{variant:"overline",style:{fontWeight:"bold"},children:"Building Certifier"}),e.jsx(r,{mb:2}),e.jsxs(r,{children:[e.jsx(g,{label:"Building Certifier Name",value:l==null?void 0:l.buildingCertifierName,variant:"outlined",size:"small",disabled:!0,fullWidth:!0,name:"buildingCertifierName"}),e.jsx(r,{mt:2}),e.jsx(g,{label:"Building Certifier Reference Number",value:l==null?void 0:l.buildingCertifierReferenceNumber,variant:"outlined",size:"small",disabled:!0,fullWidth:!0,name:"buildingCertifierReferenceNumber"}),e.jsx(r,{mt:2}),e.jsx(g,{label:"Development Approval Number",value:l==null?void 0:l.developmentalApprovalNumber,variant:"outlined",size:"small",disabled:!0,fullWidth:!0,name:"developmentalApprovalNumber"})]})]})}),e.jsx(r,{mb:2}),e.jsx(S,{fullWidth:!0,name:"descriptionOfTheExtent",label:"Description of the extent of aspect/s certified"}),e.jsx(r,{mb:2}),e.jsx(S,{fullWidth:!0,name:"referenceDocumentation",label:"Reference Documentation"}),e.jsx(r,{mb:2})]})]})})]})}const Te=({project:s,...n})=>{const{data:i}=M({queryKey:["GET_PROJECT_COMPANY_OPTION",s==null?void 0:s.companyId],queryFn:async()=>await de({key:"getCompany",variables:{id:s==null?void 0:s.companyId}}),enabled:!!(s!=null&&s.companyId)}),a=(s==null?void 0:s.status)!=="COMPLETED";return a&&e.jsx("li",{...n,children:e.jsxs(r,{sx:{display:"flex",flexDirection:"column"},children:[e.jsx(r,{children:e.jsx(r,{children:a&&e.jsx(I,{variant:"subtitle1",children:s==null?void 0:s.name})})}),e.jsx(r,{children:e.jsx(r,{sx:{mt:"-9px"},children:a&&e.jsx(I,{variant:"caption",style:{color:"gray",fontSize:"12px"},children:i==null?void 0:i.name})})})]})})};function ke({setState:s}){const{values:n={}}=k();w(["description","start","due","do","estimatedEffort","type","status","priority","milestoneId","projectId","opportunityId","aspectOfWork","buildingStructureOptions","basisOfCertification","descriptionOfTheExtent","referenceDocumentation","classBuildingStructure"]);const i=n==null?void 0:n.projectId,a=K(i);return f.useEffect(()=>{a&&s(d=>({...d,showContact:[Y.simple.key].includes(a)}))},[a]),we(),e.jsxs(r,{m:1,mb:0,style:{width:400},children:[!(n!=null&&n.opportunityId)&&e.jsxs(e.Fragment,{children:[e.jsx(C,{fullWidth:!0,dataId:"projectId",model:"Project",label:"Project",renderOption:(d,o)=>(console.log(o==null?void 0:o._source,"sourcesss here"),console.log(o,typeof o,"tpof"),e.jsx(Te,{...d,project:o==null?void 0:o._source})),custom:!0}),e.jsx(r,{mb:1})]}),e.jsx(Ce,{}),e.jsx(r,{mb:1}),e.jsx(T,{fieldName:"title",label:"Title",fullWidth:!0,required:!0}),e.jsx(r,{mb:1}),e.jsx(T,{fieldName:"jobDetails",label:"Details",fullWidth:!0}),e.jsx(r,{mb:1}),e.jsx(S,{type:"date",fullWidth:!0,name:"due",label:"Due Date"}),e.jsx(r,{mb:1}),e.jsx(he,{}),e.jsx(z,{name:"billable",label:"Billable"}),e.jsx(xe,{}),e.jsx(ye,{})]})}function Ce(){const{values:s={}}=k(),n=s==null?void 0:s.projectId,i=s==null?void 0:s.opportunityId,a=f.useMemo(()=>{if(n||i){const d={bool:{must:[]}},o={};return n&&(o["sprintProjectId.keyword"]=n),i&&(o["opportunityId.keyword"]=i),d.bool.must.push({term:o}),d}},[n,i]);return e.jsx(C,{fullWidth:!0,dataId:"taskSprintId",model:"Sprint",label:"Stage",query:a})}function Oe(){w(["projectId","opportunityId"]);const{values:s={}}=k(),n=s.projectId,i=s.opportunityId,a=f.useMemo(()=>{if(!n&&!i)return;const d={bool:{must:[]}},o={};return n&&(o["milestoneProjectId.keyword"]=n),i&&(o["milestoneOppId.keyword"]=i),d.bool.must.push({term:o}),d},[n,i]);return e.jsx(C,{autoFit:!0,fullWidth:!0,dataId:"milestoneId",model:"Milestone",label:"Milestone",query:a})}function Je({id:s,initialValues:n,...i}={}){const a={..._(n)},o=G().getData();o&&Object.assign(a,o);const[u,m]=f.useState({showContact:!1,repeatData:{}}),h=f.useCallback(async l=>(console.log("data1:",l),l.due&&(l.due=new Date(l.due)),l.start&&(l.start=new Date(l.start)),l.do&&(l.do=new Date(l.do)),console.log(">>task/TaskFormWithSummary::","values",l),l.id?l:_(l)),[]);return e.jsx("div",{children:e.jsx(ge,{name:"Task",initialValues:s?{projectId:a.projectId}:a,title:`${s?"Edit":"Add"} Task`.toUpperCase(),id:s,...i,beforeSave:h,onSubmit:async(...l)=>{if(await U({ids:["SearchTasksStagesGrid","MODEL_SPRINT_TASKS_LIST"]}),i.onSubmit)return i.onSubmit(...l)},withUrls:!!(u!=null&&u.showAll),withTags:!!(u!=null&&u.showAll),children:e.jsx(ke,{setState:m,state:u})})})}function we(){const[s]=re(Ee),n=ae(),{globalState:{authUser:i}}=ne();L(async a=>{console.log(">>task/TaskForm::","task after safe values",a);const d=await n.query({query:V`
        query SearchDurations(
          $filter: SearchableDurationFilterInput
          $sort: SearchableDurationSortInput
        ) {
          searchDurations(filter: $filter, sort: $sort) {
            items {
              id
              recordId
              currentValue
              timestamp
            }
          }
        }
      `,variables:{filter:{recordId:{eq:a.id},fieldName:{eq:"status"},modelName:{eq:"task"}},sort:{field:"timestamp",direction:"desc"}},fetchPolicy:"network-only"}),o=new Date,u=v(d,"data.searchDurations.items[0]");return d&&(u==null?void 0:u.currentValue)!==a.status&&await s({variables:{input:{currentValue:a.status||"NOT_SET",timestamp:Math.round(o.getTime()),fieldName:"status",modelName:"Task",previousDurationTimestamp:u==null?void 0:u.timestamp,previousValue:u==null?void 0:u.currentValue,recordId:a.id}}}),{updatedBy:i.id}})}const Ee=V`
  mutation CreateDuration($input: CreateDurationInput!) {
    createDuration(input: $input) {
      id
      currentValue
      timestamp
      fieldName
      recordId
      previousValue
      previousDurationTimestamp
    }
  }
`;export{Je as T};
