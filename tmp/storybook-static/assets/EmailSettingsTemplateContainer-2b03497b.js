import{j as e}from"./TransitionGroupContext-9d36972e.js";import{r as d}from"./index-f1f749bf.js";import{a as T}from"./index.esm-bf21a293.js";import{u as y,j as S,M as C}from"./SyncEagleDevTool-4c34bdb8.js";import{l as E,b as R}from"./index-bcfaa842.js";import{F as p}from"./index-ce960f89.js";import{B as m,T as b,aa as q,a_ as F,a6 as w}from"./papaparse.min-b66e70e7.js";import{u as N}from"./useMutation-64d5b683.js";import{L as I}from"./LoadingButton-f7387eca.js";import"./assertThisInitialized-ad1db8e7.js";import"./_commonjsHelpers-042e6b4d.js";import"./zod-575fe4a8.js";import"./filter-f99df4e5.js";import"./Button-352c3435.js";import"./LocalizationProvider-a287304f.js";import"./_baseForOwn-9b89c4b6.js";import"./userGroups-edff3f7b.js";import"./index-96c5f47c.js";import"./index-f70ce446.js";import"./searchUsers-04324aeb.js";import"./find-8750f979.js";import"./index-18188c67.js";import"./index-61adb48a.js";import"./_arrayIncludes-2cfb33ae.js";import"./Play-87fed129.js";import"./react-router-19e5b27c.js";import"./index-4d501b15.js";import"./tiny-invariant-dd7d57d2.js";import"./iframe-ed7f5a3f.js";import"../sb-preview/runtime.js";import"./react-router-dom-60ea8218.js";import"./debounce-213cd46f.js";import"./uniq-0d482d7b.js";import"./cloneDeep-91467704.js";import"./useFetchMore-be228481.js";import"./useTagSearch-f4fcfbe9.js";import"./Skeleton-cd6f071e.js";import"./isNativeReflectConstruct-05c29d01.js";import"./isPlainObject-07477f89.js";const L=({value:t,form:h})=>{const s=d.useMemo(()=>{var u;if(typeof t!="string"&&!t)return;console.log({value:t});const n=/\{\{(?<field>[^}]+)\}\}/gm,g=[...(u=t==null?void 0:t.matchAll)==null?void 0:u.call(t,n)],i=E.uniq(g.map(x=>{var a,l,r;return(r=(l=(a=x.groups)==null?void 0:a.field)==null?void 0:l.trim)==null?void 0:r.call(l)}));return console.log({value:t,uniqueResults:i}),i},[t]);return s!=null&&s.length?e.jsx(e.Fragment,{children:s==null?void 0:s.map(n=>e.jsx(m,{gridColumn:"span 6",children:e.jsx(p,{control:h.control,name:n,label:E.startCase(n),rules:{required:!0},placeholder:`Enter ${E.startCase(n)}`})},n))}):e.jsx(m,{children:"No Fields Parsed on template"})},B="settings/email/templates",Ee=()=>{const t=T(),h=T(),s=d.useRef(),{enqueueSnackbar:n}=R(),[g,i]=d.useState(),{setTemplateId:u,templateQuery:{isFetching:x}}=y({onSuccess:({html:r,fields:o})=>{Object.entries(o).map(([c,j])=>t.setValue(c,j)),s.current.getInstance().setHtml(r),i(r),t.setValue("templateName",label)}}),a=N(async({result:r,fields:o})=>{const c=(o==null?void 0:o.templateName)||window.prompt("What is the name of the new template?");if(!c)return;const j=`${B}/${c}.html`;console.log({fields:o});const f=await w.put(j,r.html,{metadata:{params:JSON.stringify({fields:o})}});return i(()=>r.html),f},{onSuccess:()=>{n("Template saved",{variant:"success"}),q.refetchQueries({queryKey:F.settingEmailTemplate.all})},onError:r=>{console.log(r),n("Template failed to save",{variant:"error"})}}),l=d.useCallback(r=>{console.log({fields:r});const c={html:s.current.getInstance().getHtml()};a.mutate({result:c,fields:r})},[a]);return console.log({loading:a==null?void 0:a.isLoading}),e.jsxs(m,{pb:2,children:[e.jsxs(m,{children:[x&&e.jsx(m,{children:"Loading... Template"}),e.jsx(m,{mb:2,children:e.jsx(S,{form:h,onOptionSelected:(r,o)=>u(o==null?void 0:o.id)})}),e.jsx(C,{title:"Email Template Editor (changes below will reflect after removing focus on this editor)",editorRef:s,onChange:()=>{var o;const r=(o=s.current)==null?void 0:o.getInstance().getHtml();console.log("EDITOR",{result:r}),i(r)}})]}),e.jsx(m,{mt:2,children:e.jsxs("form",{onSubmit:t.handleSubmit(r=>{l(r)}),children:[e.jsx(b,{style:{fontSize:20,fontWeight:600},children:"Email Default Fields"}),e.jsx(p,{control:t.control,name:"templateName",label:"Template Name (will be saved as a duplicate template when changed)",rules:{required:!0},placeholder:"Enter Template Name"}),e.jsx(p,{control:t.control,name:"emailSubject",label:"Email Subject",rules:{required:!0},placeholder:"Enter Subject"}),e.jsx(p,{control:t.control,name:"emailTos",label:"Email Recipients separated by commas",rules:{required:!0},placeholder:"Enter Recipients separated by commas"}),e.jsx(p,{control:t.control,name:"emailCcs",label:"Email CC Recipients separated by commas",rules:{required:!0},placeholder:"Enter CC Recipients separated by commas"}),e.jsx(p,{control:t.control,name:"emailBccs",label:"Email BCC Recipients separated by commas",rules:{required:!0},placeholder:"Enter BCC Recipients separated by commas"}),e.jsx(m,{mt:2}),e.jsx(b,{style:{fontSize:20,fontWeight:600},children:"Email Template Fields"}),e.jsxs(b,{variant:"caption",children:["Example: ","{{ name }}"," must be inside double curly brackets"]}),e.jsx(L,{value:g,form:t}),e.jsx(m,{mt:2,display:"flex",justifyContent:"flex-end",children:e.jsx(I,{type:"submit",size:"large",variant:"contained",color:"primary",loading:a==null?void 0:a.isLoading,children:"Save"})})]})})]})};export{Ee as EmailSettingsTemplateContainer,Ee as default};
