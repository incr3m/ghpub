import{j as e}from"./TransitionGroupContext-9d36972e.js";import{R as x}from"./index-f1f749bf.js";import{m as E,aW as W,ak as se,L as ce,Z as de,au as T,av as O,ai as le,aj as ue,ch as me,P as ve,B as w,ah as Ie,bx as fe,g as D,k as N,o as Z,C as pe,a1 as $,b as ee,ab as ye,X as R,i as _,a4 as xe,V as he,as as ge,u as te,aP as je,W as Ce,aM as be,cH as we,a3 as Se}from"./papaparse.min-b66e70e7.js";import{s as J,D as Be}from"./bundle-053bdffd.js";import{e as U,w as Pe,X as ke,j as Re}from"./Play-87fed129.js";import{j as $e,F as Ne,H as Fe}from"./pick-dba65392.js";import{f as z,b as _e,w as b,q as Le}from"./index-bcfaa842.js";import{S as Ee}from"./SelectEsModelInput-d580a9f7.js";import{u as Te}from"./useIncludeFieldNames-35a180a9.js";import{R as Oe,a as De}from"./RepeatFields-8275ed19.js";import{a as X}from"./Save-b67fa0ac.js";import{d as Ae}from"./ExpandMore-79a3c159.js";import{d as ze}from"./ExpandLess-3302d2ff.js";import{x as Me,X as qe}from"./index-8edd7abf.js";import{g as Qe}from"./_baseForOwn-9b89c4b6.js";import{B as L}from"./Button-352c3435.js";import{d as Ve}from"./Error-a5d563f0.js";import{u as He}from"./react-router-19e5b27c.js";import"./assertThisInitialized-ad1db8e7.js";import"./_commonjsHelpers-042e6b4d.js";import"./_arrayIncludes-2cfb33ae.js";import"./index-96c5f47c.js";import"./isPlainObject-07477f89.js";import"./debounce-213cd46f.js";import"./iframe-ed7f5a3f.js";import"../sb-preview/runtime.js";import"./index-4d501b15.js";import"./filter-f99df4e5.js";import"./LocalizationProvider-a287304f.js";import"./react-router-dom-60ea8218.js";import"./tiny-invariant-dd7d57d2.js";import"./uniq-0d482d7b.js";import"./cloneDeep-91467704.js";import"./index-61adb48a.js";import"./useGetProjectSummaryFields-0ab32aca.js";import"./Link-c687dc07.js";import"./index-147ad7aa.js";import"./Add-be7f5660.js";import"./isNativeReflectConstruct-05c29d01.js";import"./useBeforeSave-e049f6dd.js";import"./capitalize-c31f38e2.js";import"./Alert-fd9a067a.js";const Ge=E(r=>({rdg:{"--border-color":`${r.palette.grey[200]} !important`,"& .rdg-header-row":{backgroundColor:r.palette.grey[100]},"& .rdg-cell":{color:r.palette.text.primary},"& .rdg-actions":{width:"100%",justifyItems:"center",display:"flex",alignItems:"center",height:"100%"},"& .MuiChip-label":{color:"white"}},rdgAllowCopy:{"-webkit-user-select":"text !important","-webkit-touch-callout":"default !important","-moz-user-select":"text !important","-ms-user-select":"text !important","user-select":"text !important"}})),Ke=Ge;function We(){const[r,i]=x.useState({enabled:!1});return Te([Oe]),e.jsxs("div",{children:[r.enabled&&e.jsx(W,{mt:1}),e.jsx(se,{checked:r.enabled,onChange:(a,l)=>{i(c=>({...c,enabled:l}))},label:"Repeating Invoice"}),r.enabled&&e.jsx(De,{triggerKey:"repeatable-invoice-create",recordType:"Invoice",dateField:"start"}),r.enabled&&e.jsx(W,{mt:2})]})}const Je=Pe(de);function Ue(r){return e.jsxs(Je,{name:"invoice",title:"Invoice",secondary:!0,...r,initialValues:r.initialValues,id:r.id,readOnly:!!r.id,beforeSave:i=>{const a={...i};return i.date&&(a.date=new Date(i.date)),a},children:[e.jsx(U,{name:"name"}),e.jsx(U,{type:"date",name:"date",label:"Date",format:i=>i&&z(new Date(i),"MMM dd, yyyy")}),e.jsx(Ee,{autoFit:!0,dataId:"invoiceCompanyId",model:"Company",label:"Company",fullWidth:!0,readOnly:!0,renderReadonly:i=>e.jsx(ce,{paddingLeft:"12px",text:"Company",children:e.jsx($e,{company:i==null?void 0:i._source})})}),e.jsx(Ne,{name:"hasPaid",label:"Has Paid?"}),e.jsx(We,{})]})}var q={},Xe=O;Object.defineProperty(q,"__esModule",{value:!0});var ne=q.default=void 0,Ye=Xe(T()),Ze=e;ne=q.default=(0,Ye.default)((0,Ze.jsx)("path",{d:"M12 6c3.79 0 7.17 2.13 8.82 5.5C19.17 14.87 15.79 17 12 17s-7.17-2.13-8.82-5.5C4.83 8.13 8.21 6 12 6m0-2C7 4 2.73 7.11 1 11.5 2.73 15.89 7 19 12 19s9.27-3.11 11-7.5C21.27 7.11 17 4 12 4m0 5c1.38 0 2.5 1.12 2.5 2.5S13.38 14 12 14s-2.5-1.12-2.5-2.5S10.62 9 12 9m0-2c-2.48 0-4.5 2.02-4.5 4.5S9.52 16 12 16s4.5-2.02 4.5-4.5S14.48 7 12 7"}),"VisibilityOutlined");const A=E({root:{appearance:"none",boxSizing:"border-box",width:"100%",height:"100%",padding:"0px 6px 0 6px",border:"2px solid #ccc",verticalAlign:"top",color:"var(--color)",backgroundColor:"var(--background-color)",fontFamily:"inherit",fontSize:"var(--font-size)","&:focus":{borderColor:"var(--selection-color)",outline:"none"},"&::placeholder":{color:"#999",opacity:"1"}}});function Q(r){r==null||r.focus(),r==null||r.select()}function et({row:r,column:i,onRowChange:a,onClose:l}){const d=`rdg-text-editor ${A().root}`,f=r[i.key];return e.jsx("input",{className:d,ref:Q,value:f||"",onChange:v=>a({...r,[i.key]:v.target.value}),onBlur:()=>l(!0)})}function tt({row:r,column:i,onRowChange:a,onClose:l}){const d=`rdg-text-editor ${A().root}`,f=r[i.key];return e.jsx("input",{className:d,ref:Q,type:"date",value:f||"",onChange:v=>a({...r,[i.key]:v.target.value}),onBlur:()=>l(!0)})}function Y({row:r,column:i,onRowChange:a,onClose:l}){const d=`rdg-text-editor ${A().root}`,f=r[i.key];return e.jsx("input",{className:d,ref:Q,type:"number",value:f||"",onChange:v=>{const n=v.target.value;a({...r,[i.key]:n?Number(n):null})},onBlur:()=>l(!0)})}function nt({row:r,onRowChange:i}){const[a,l]=x.useState({opened:!1,searchText:""}),c=x.useRef(null),f=`rdg-text-editor ${A().root}`,v=x.useContext(K);x.useEffect(()=>{var o,t;c.current&&((o=c.current)==null||o.focus(),(t=c.current)==null||t.select(),l(s=>({...s,opened:!0})))},[]),console.log(">>InvoiceList/AcctCodeEditor::","ctx.state",v.state);const n=[];for(const o in v.state.accountCodes){const t=v.state.accountCodes[o];a.searchText&&!(t.Code===a.searchText||t.Name.toLocaleLowerCase().includes(a.searchText.toLocaleLowerCase()))||n.push(e.jsx(le,{button:!0,selected:r.acct===t.Code,onClick:()=>{const s={...r,acct:t.Code};i(s),l(m=>({...m,opened:!1,searchText:`${t.Code} - ${t.Name}`}))},children:e.jsx(ue,{primary:`${t.Code} - ${t.Name}`})},t.Code))}return e.jsxs(e.Fragment,{children:[e.jsx("input",{className:f,ref:c,value:a.searchText||"",onChange:o=>{const t=o.target.value;l(s=>({...s,searchText:t}))}}),e.jsx(me,{open:a.opened,anchorEl:c.current,children:e.jsx(ve,{children:e.jsx(w,{width:"300px",maxHeight:"300px",overflow:"auto",children:e.jsx(Ie,{children:n})})})})]})}var V={},ot=O;Object.defineProperty(V,"__esModule",{value:!0});var oe=V.default=void 0,it=ot(T()),rt=e;oe=V.default=(0,it.default)((0,rt.jsx)("path",{d:"M14 10H3v2h11zm0-4H3v2h11zm4 8v-4h-2v4h-4v2h4v4h2v-4h4v-2zM3 16h7v-2H3z"}),"PlaylistAddOutlined");var H={},at=O;Object.defineProperty(H,"__esModule",{value:!0});var ie=H.default=void 0,st=at(T()),ct=e;ie=H.default=(0,st.default)((0,ct.jsx)("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7zm2 16H5V5h11.17L19 7.83zm-7-7c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3M6 6h9v4H6z"}),"SaveOutlined");var G={},dt=O;Object.defineProperty(G,"__esModule",{value:!0});var re=G.default=void 0,lt=dt(T()),ut=e;re=G.default=(0,lt.default)((0,ut.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"ClearOutlined");async function mt(r){var l;const i=await fe.query({query:D`
    {
      record: get${r.model}(id:${JSON.stringify(r.modelId)}){
        id
        integrations
      }
    }
  `,fetchPolicy:"network-only"});console.log(">>libs/integration::","recordQ",i);const a=(l=Qe(i,"data.record.integrations",[]))==null?void 0:l.map(c=>JSON.parse(c));return a?N(a,"code"):null}const vt=D`
  mutation($input: UpdateInvoiceInput!) {
    updateInvoice(input: $input) {
      id
      name
      type
      description
      completed
      invoiceProjectId
      invoiceOpportunityId
      refId
      refNum
      date
      amount
      tax
      qty
      acct
      precedence
      hasPaid
      items
      createdAt
    }
  }
`;async function It(r,i,a){var f;const l=encodeURI(`${window.location.origin.replace("localhost:3000","dev-env")}/invoices/${r.id}`),c=JSON.parse(r.items||"[]"),d=await Me({index:"accountingApi",type:"updateOrCreateInvoices",body:({tenantId:v})=>({args:[v,{invoices:[{...r.refId&&{invoiceID:r.refId},type:"ACCREC",contact:{contactID:i},date:r.date,reference:a,url:l,lineItems:c.map(n=>({description:n.description,quantity:n.qty,unitAmount:n.amount,taxAmount:n.tax,...n.acct&&{accountCode:n.acct}}))}]}]})});if(console.log(">>InvoiceList/InvoiceFooter::","resData",d),d!=null&&d.errors){let v=d==null?void 0:d.errors.Message;throw d.errors.Elements.forEach(n=>{var o;(o=n.ValidationErrors)==null||o.forEach(({Message:t})=>v+=`. ${t}`)}),new Error(v)}return(f=d==null?void 0:d.Invoices)==null?void 0:f[0]}const M=(r,i)=>r.mutate({mutation:vt,variables:{input:{id:i.id,...i}}});function ft(r){const{state:i,setState:a}=x.useContext(K),l=Z(),{enqueueSnackbar:c}=_e();async function d(t){const s=i.invoiceById[t];if(!s)return;const m=new Date,u={id:`${s.id}@${m.getTime()}`,date:m.toISOString(),acct:i.defaultAccountCode,invParentId:t,createdAt:m.toISOString()},y=i.lineItemsById[`${s.id}@footer`];a(h=>({...h,lineItemsById:$({...h.lineItemsById,[u.id]:u},[y.id]),modifiedInvoiceIds:{...h.modifiedInvoiceIds,[t]:!0}})),await ee.delay(500),a(h=>({...h,lineItemsById:{...h.lineItemsById,[y.id]:y}}))}async function f(t){a(s=>({...s,invoiceById:{...s.invoiceById},modifiedInvoiceIds:$(s.modifiedInvoiceIds,[t])}))}function v(t){const s=[];for(const m in i.lineItemsById){const u=i.lineItemsById[m];u.invParentId!==t||u.isFooter||s.push(u)}return s}async function n(t){var h;const s=i.invoiceById[t];if(!s)return;a(C=>({...C,saving:!0}));const m=v(t),y=(h=(await M(l,{id:s.id,items:JSON.stringify(m)})).data)==null?void 0:h.updateInvoice;a(C=>{const I={...s,items:y.items,refId:y.refId,refNum:y.refNum};return{...C,invoiceById:{...C.invoiceById,[t]:I},modifiedInvoiceIds:$(C.modifiedInvoiceIds,[t])}}),a(C=>({...C,saving:!1}))}const o=i.invoiceById[r.invoiceId];return e.jsxs(w,{display:"flex",height:"100%",justifyContent:"space-between",children:[e.jsx("div",{children:e.jsx(L,{size:"small",variant:"outlined",disabled:i.saving,endIcon:e.jsx(oe,{}),onClick:()=>{d(r.invoiceId)},children:"Add Line Item"})}),e.jsx(w,{display:"flex",alignItems:"center",children:i.modifiedInvoiceIds[r.invoiceId]?e.jsxs(e.Fragment,{children:[i.saving&&e.jsx(w,{p:1,mt:1,display:"inline",children:e.jsx(pe,{size:20})}),e.jsx(L,{size:"small",variant:"outlined",disabled:i.saving,endIcon:e.jsx(re,{}),onClick:()=>{f(r.invoiceId)},children:"Reset"}),e.jsx(w,{component:"span",ml:1}),e.jsx(L,{size:"small",variant:"contained",disabled:i.saving,endIcon:e.jsx(ie,{}),onClick:()=>{n(r.invoiceId)},children:"Save"})]}):i.defaultAccountCode?e.jsxs(L,{size:"small",variant:"outlined",disabled:i.saving,endIcon:e.jsx(ke,{}),onClick:async()=>{var s,m;let t=i.invoiceById[r.invoiceId];if(t){a(u=>({...u,saving:!0}));try{if(!t.invoiceCompanyId)throw new Error("Invoice should have a company");const u=await mt({model:"Company",modelId:t.invoiceCompanyId});console.log(">>InvoiceList/InvoiceFooter::","companyIntegrations",u);const y=(s=u==null?void 0:u.xero)==null?void 0:s.contactID;if(!y)throw new Error("Invoice company does not have associated xero contact");const h=await It(t,y,i.defaultInvoiceReference);if(h){const{InvoiceID:C,InvoiceNumber:I}=h;(t.refId!==C||t.refNum!==I)&&(t=(m=(await M(l,{id:t.id,refId:C,refNum:I})).data)==null?void 0:m.updateInvoice,a(g=>{if(!t)return g;const S={...t,items:t.items,refId:t.refId,refNum:t.refNum};return{...g,invoiceById:{...g.invoiceById,[t.id]:S}}}))}}catch(u){const{message:y}=u;c(y,{variant:"error"})}finally{a(u=>({...u,saving:!1}))}}},children:[o!=null&&o.refId?"Update":"Generate"," Xero Invoice"]}):null})]})}const pt=E(r=>({grid:{"& .algn-right":{textAlign:"right"}},invName:{display:"flex",alignItems:"center",justifyContent:"space-between","& > span":{textOverflow:"ellipsis",overflow:"hidden"}},chipGreen:{backgroundColor:r.palette.success.main},chipBlue:{backgroundColor:r.palette.info.main},hasPaidCell:{display:"inline-flex",paddingTop:"5px"},summary:{height:"100px",padding:"10px",textAlign:"right","& > div":{height:"25px",lineHeight:1},"& > div > span":{minWidth:"200px",display:"inline-block"}}}));function yt(r){const{state:i,setState:a}=r,l=Z(),c=pt(),d=ye("integration-xero-setting"),[f]=Re({opts:{forceDelete:!0}});x.useEffect(()=>{d&&a(n=>({...n,defaultAccountCode:d.defaultAcctCode,accountCodes:N(d.accounts,"Code"),taxRates:N(d.taxRates,"TaxType")}))},[a,d]),console.log(">>InvoiceList/useInvoiceGrid::","state",i.taxRates);async function v(n){a(o=>({...o,lineItemsById:$(o.lineItemsById,[n.id]),modifiedInvoiceIds:{...o.modifiedInvoiceIds,[n.invParentId]:!0}}))}return{columns:[{key:"invParentId",name:"Name",resizable:!0,colSpan:n=>{if(n.type==="SUMMARY")return 3;if(n.type==="ROW"&&n.row.isFooter)return 5},groupFormatter:n=>{const o=n.groupKey,t=i.invoiceById[o],s=i.expandedInvoices.has(o);return e.jsxs("div",{className:c.invName,children:[e.jsx("span",{children:t==null?void 0:t.name}),e.jsx(R,{title:s?"Shrink":"Expand",children:e.jsx(_,{size:"small",onClick:()=>{a(m=>(s?m.expandedInvoices.delete(o):m.expandedInvoices.add(o),{...m,expandedInvoices:new Set(m.expandedInvoices)}))},children:s?e.jsx(ze,{}):e.jsx(Ae,{})})})]})}},{key:"date",name:"Date",width:170,resizable:!0,editable:!0,editor:tt,colSpan:n=>{if(n.type==="ROW"&&n.row.isFooter)return 10},groupFormatter:n=>{const o=i.invoiceById[n.groupKey];return e.jsx("span",{children:(o==null?void 0:o.date)&&z(new Date(o.date),"MMM dd, yyyy")})},formatter:n=>{const{isFooter:o,date:t,invParentId:s}=n.row;return o?e.jsx(ft,{invoiceId:s}):e.jsx("span",{children:t&&z(new Date(t),"MMM dd, yyyy")})}},{key:"description",name:"Description",resizable:!0,editable:!0,editor:et,groupFormatter:n=>{const o=i.invoiceById[n.groupKey];return e.jsx("span",{children:o==null?void 0:o.description})},formatter:n=>e.jsx("span",{children:n.row.description})},{key:"acct",name:"Acct",resizable:!0,editable:!0,editor:nt,formatter:n=>{const o=i.accountCodes[n.row.acct],t=o?`${o.Code} - ${o.Name}`:"";return e.jsx("span",{children:t})}},{key:"qty",name:"Qty",width:50,resizable:!1,editable:!0,editor:Y,formatter:n=>e.jsx("span",{children:n.row.qty}),groupFormatter:n=>e.jsx("span",{children:J(n.childRows,o=>Number(o.qty||0))||""})},{key:"amount",name:"Unit Price",resizable:!1,editable:!0,editor:Y,formatter:n=>e.jsx("div",{className:"algn-right",children:b.numberFormatter(n.row.amount).toCurrency()}),colSpan:n=>{if(n.type==="SUMMARY")return 5},summaryFormatter:n=>e.jsxs("div",{className:c.summary,children:[e.jsxs("div",{children:[e.jsx("label",{children:"Subtotal"}),e.jsx("span",{children:b.numberFormatter(n.row.totals.subTotal).toCurrency()})]}),e.jsxs("div",{children:[e.jsx("label",{children:"TOTAL GST"}),e.jsx("span",{children:b.numberFormatter(n.row.totals.gst).toCurrency()})]}),e.jsx(xe,{}),e.jsxs(w,{mt:1,fontSize:"larger",fontWeight:"bolder",children:[e.jsx("label",{children:"TOTAL AUD"}),e.jsx("span",{children:b.numberFormatter(n.row.totals.total).toCurrency()})]})]})},{key:"tax",name:"GST",width:50,resizable:!0,formatter:n=>e.jsx("div",{className:"algn-right",children:b.numberFormatter(n.row.tax).toCurrency()}),groupFormatter:n=>e.jsx("div",{className:"algn-right",children:b.numberFormatter(J(n.childRows,o=>Number(o.tax||0))).toCurrency()})},{key:"total",name:"Amount",resizable:!1,formatter:n=>{let o;return n.row.amount&&(o=(n.row.amount||0)*(n.row.qty||1)),e.jsx("div",{className:"algn-right",children:b.numberFormatter(o).toCurrency()})},groupFormatter:n=>{let o=0;for(const t of n.childRows)if(t.amount){const s=t.amount*(t.qty||1);o+=s}return e.jsx("div",{className:"algn-right",children:o?b.numberFormatter(o).toCurrency():""})}},{key:"refId",name:"Invoice Created",width:140,resizable:!1,groupFormatter:n=>{const o=n.groupKey,t=i.invoiceById[o];return e.jsx("span",{children:(t==null?void 0:t.refNum)&&e.jsx(he,{color:"secondary",size:"small",label:t.refNum,onClick:()=>{window.open(`https://invoicing.xero.com/view/${t.refId}`,"_blank")}})})}},{key:"hasPaid",name:"Paid",width:50,resizable:!0,groupFormatter:n=>{const o=i.invoiceById[n.groupKey],t=!!(o!=null&&o.hasPaid);let s=0;if(t){const m=JSON.parse(o.payments||"[]");console.log(">>InvoiceList/useInvoiceGrid::","payments",m),s=m.reduce((u,y)=>u+=y.amount||0,0)}return e.jsx("span",{className:c.hasPaidCell,children:e.jsx(R,{title:s>0?`Paid amount: ${b.numberFormatter(s).toCurrency()}`:"Set as paid",children:e.jsx(ge,{size:"small",checked:t,onChange:(m,u)=>{M(l,{id:o==null?void 0:o.id,hasPaid:u})}})})})}},{key:"id",name:" ",width:60,resizable:!1,groupFormatter:n=>{const o=n.groupKey;return e.jsxs("div",{className:"rdg-actions",children:[e.jsx(R,{title:"View Details",placement:"left",children:e.jsx(_,{size:"small",onClick:async()=>{a(t=>({...t,selectInvoiceId:o}))},children:e.jsx(ne,{})})}),e.jsx(R,{title:"Delete",placement:"left",children:e.jsx(_,{size:"small",onClick:async()=>{const t=i.invoiceById[o];t&&(a(s=>({...s,invoiceById:$(s.invoiceById,[t.id])})),await f(t))},children:e.jsx(X,{})})})]})},formatter:n=>e.jsx(w,{className:"rdg-actions",children:e.jsx(R,{title:"Delete",placement:"left",children:e.jsx(_,{size:"small",onClick:()=>{v(n.row)},children:e.jsx(X,{})})})})}]}}const K=x.createContext({}),xt=D`
  query INV_LIST_Q($filter: SearchableInvoiceFilterInput) {
    searchInvoices(filter: $filter) {
      items {
        id
        name
        type
        description
        completed
        invoiceProjectId
        invoiceOpportunityId
        invoiceCompanyId
        invoiceContactId
        refId
        refNum
        date
        amount
        tax
        qty
        acct
        precedence
        payments
        hasPaid
        completed
        items
        createdAt
      }
    }
  }
`,ht=E({grid:{"& .algn-right":{textAlign:"right"}}});function gt(r){var h,C;const[i,a]=x.useState({saving:!1,searchTxt:null,selectInvoiceId:null,expandedInvoices:new Set([]),lineItemsById:{},invoiceById:{},accountCodes:{},taxRates:{},modifiedInvoiceIds:{}}),l=x.useRef(null),c={state:i,setState:a};c.state.defaultInvoiceReference=r.defaultInvoiceReference;const d=ht(),f=Ke(),{columns:v}=yt(c),n={};r.opportunityId&&(n.invoiceOpportunityId={eq:r.opportunityId}),r.projectId&&(n.invoiceProjectId={eq:r.projectId});const o=te(xt,{variables:{filter:n},fetchPolicy:"network-only",nextFetchPolicy:"cache-first"});console.log(">>InvoiceList/InvoiceList::","invQ",o);const t=x.useMemo(()=>{var I;return((I=o.data)==null?void 0:I.searchInvoices.items)||[]},[o]);x.useEffect(()=>{a(I=>({...I,invoiceById:N(t,"id")})),r.onData&&r.onData(t)},[t]),x.useEffect(()=>{const I={};for(const j in i.invoiceById){const g=i.invoiceById[j];if(!g)continue;const S=JSON.parse(g.items||"[]");S.push({id:`${g.id}@footer`,isFooter:!0}),S.forEach((P,p)=>{P.id||(P.id=`${g.id}@${p}`),P.invParentId=g.id}),Object.assign(I,N(S,"id"))}a(j=>({...j,lineItemsById:I}))},[i.invoiceById]),x.useEffect(()=>{l.current&&(i.selectInvoiceId?l.current.open():l.current.close())},[i.selectInvoiceId]);const s=x.useMemo(()=>{let I=0,j=0,g=0;for(const P in i.lineItemsById){const p=i.lineItemsById[P];if(p.amount){const{qty:B=1,tax:k=0,amount:F=0}=p;I+=F*B,j+=k,g+=F*B+k}}return[{id:"total_0",invoiceNo:"#",totals:{subTotal:I,gst:j,total:g}}]},[i.lineItemsById]),m=(I,j)=>{const g={},S={},P=j.indexes.map(p=>{const B=I[p];return S[B.invParentId]=!0,B});for(const p of P)if(g[p.id]=p,p.acct){const B=i.accountCodes[p.acct],k=i.taxRates[B==null?void 0:B.TaxType],F=(k==null?void 0:k.EffectiveRate)||0;if(p.amount){const ae=p.amount*(p.qty||1);p.tax=ae*(F/100)}}a(p=>({...p,lineItemsById:{...p.lineItemsById,...g},modifiedInvoiceIds:{...p.modifiedInvoiceIds,...S}}))};let u=[];const y=(h=i.searchTxt)==null?void 0:h.toLowerCase();for(const I in i.lineItemsById){const j=i.lineItemsById[I];y&&!((C=j.description)!=null&&C.toLowerCase().includes(y))||u.push(j)}return u=je(u,"invParentId"),console.log(">>InvoiceList/InvoiceList::","lineItems",u),e.jsxs(K.Provider,{value:c,children:[e.jsx(Ce,{variant:"dialog",ref:l,onClose:()=>{a(I=>({...I,selectInvoiceId:null}))},dialogProps:{maxWidth:"sm",fullWidth:!0},children:e.jsx(Ue,{id:i.selectInvoiceId,initialValues:{date:new Date().toISOString(),invoiceOpportunityId:r.opportunityId,invoiceProjectId:r.projectId,invoiceCompanyId:r.companyId},onSubmit:async()=>{await ee.delay(500),o.refetch()},onCancel:()=>{console.log(">>InvoiceList/InvoiceList::","closing"),l.current.close()}})}),e.jsx(be,{createLabel:"Invoice",onSearch:I=>{a(j=>({...j,searchTxt:I}))},onNewClicked:()=>{l.current.open()}}),e.jsx(w,{mt:2}),e.jsx(qe,{children:e.jsx(w,{children:e.jsx(Be,{rows:u,rowKeyGetter:jt,rowHeight:50,style:{minHeight:"500px"},groupBy:["invParentId"],rowGrouper:we,onRowsChange:m,expandedGroupIds:i.expandedInvoices,className:`${d.grid} ${f.rdg} ${f.rdgAllowCopy} mb-tree-grid fill-grid rdg-light`,summaryRowHeight:100,summaryRows:s,columns:v})})})]})}function jt(r){return r.id}function un(){var f,v;const[r,i]=x.useState({invoices:[]}),{projectId:a}=He(),c=(f=te(D`
      query PROJECT_INFO($id: ID!) {
        getProject(id: $id) {
          id
          name
          type
          color
          billable
          companyId
          company {
            id
            name
          }
          estimatedValue
          closeDate
          startDateEst
          endDateEst
          startDateActual
          endDateActual
        }
      }
    `,{variables:{id:a},skip:!a}).data)==null?void 0:f.getProject;console.log(">>project/ProjectInvoices::","projectId",a,c);const d=Le();return console.log(">>project/ProjectInvoices::","statexx",r),c?e.jsxs(e.Fragment,{children:[e.jsx(w,{mb:2,children:e.jsx(Fe,{items:r.invoices,itemLengthFormat:!1,fields:[{name:"total",label:"Total (Ex GST)",format:n=>{let o,t;return[null,void 0].includes(c.estimatedValue)?(o=d.palette.warning.main,t="Project estimated value is not set"):n<c.estimatedValue?(o=d.palette.warning.main,t="Less than Project estimate value"):n>c.estimatedValue&&(o=d.palette.warning.main,t="More than Project estimate value"),e.jsxs(w,{component:"span",display:"inline-flex",children:[b.numberFormatter(n).toCurrency(),t&&e.jsx(R,{title:t,children:e.jsx(w,{component:Ve,color:o})})]})}},{name:"received",format:n=>b.numberFormatter(n).toCurrency()},{name:"received",label:"Total Remaining",format:n=>{const o=(c.estimatedValue||0)-n;return o<0?null:b.numberFormatter(o).toCurrency()}}]})}),e.jsx(gt,{projectId:a,companyId:c.companyId,defaultInvoiceReference:`${c==null?void 0:c.name} ${(v=c==null?void 0:c.company)==null?void 0:v.name}`,onData:n=>{const o=[];for(const t of n){let s=0;JSON.parse(t.items||"[]").forEach(m=>{s+=(m.amount||0)*(m.qty||1)}),o.push({id:t.id,hasPaid:!!t.hasPaid,received:t.hasPaid?s:0,total:s})}console.log(">>project/ProjectInvoices::","totals",o),i(t=>({...t,invoices:o}))}})]}):e.jsx(Se,{})}export{un as default};
