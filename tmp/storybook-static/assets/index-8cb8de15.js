import{j as c}from"./TransitionGroupContext-9d36972e.js";import{R as y}from"./index-f1f749bf.js";import{u as M}from"./useAmChart-48bd185b.js";import{d as X,e as z}from"./index-bcfaa842.js";import{at as H,v as N,o as $,g as q,aP as G,B as _,z as E,aQ as J,K as Q,P as W,m as Y,aR as L,w as C}from"./papaparse.min-b66e70e7.js";import{g as P}from"./_baseForOwn-9b89c4b6.js";import{d as K}from"./debounce-213cd46f.js";import"./assertThisInitialized-ad1db8e7.js";import"./_commonjsHelpers-042e6b4d.js";import"./index-96c5f47c.js";import"./isNativeReflectConstruct-05c29d01.js";import"./_arrayIncludes-2cfb33ae.js";import"./Button-352c3435.js";import"./isPlainObject-07477f89.js";import"./iframe-ed7f5a3f.js";import"../sb-preview/runtime.js";import"./index-4d501b15.js";let S;function U(n){const{globalState:{appLoading:m},updateGlobalState:s}=H();S=m;const g=y.useRef({updateLoading:K(function(e){!!S!=!!e&&s({appLoading:e})},500)});y.useEffect(()=>()=>{S&&s({appLoading:!1})},[]),y.useEffect(()=>{g.current.updateLoading(n)},[n])}const V=Y({chart:{height:"500px",marginTop:"30px","& .evt-tooltip":{padding:"10px",fontSize:"larger"},"& .evt-tooltip h4":{padding:"0px",lineHeight:1},"& .evt-tooltip-date":{marginTop:"10px",fontSize:"smaller"}}});function A(n){if(!n)return;let m="";const s=n.split("T");m+=s[0];const g=s[1].split(":");let e=`${g[0]}:${g[1]}`;return e==="00:00"&&(e="08:00"),`${m} ${e}`}function fe(n){const[m,s]=y.useState({loading:!1}),g=V(),[e,T]=N({startDate:L,endDate:L,view:C,rType:C,rId:C}),w=y.useMemo(()=>({startDate:(e==null?void 0:e.startDate)||X(new Date),endDate:(e==null?void 0:e.endDate)||z(new Date)}),[e]);n.recordId&&(e.rId=n.recordId),n.recordType&&(e.rType=n.recordType),e.startDate||(e.startDate=w.startDate),e.endDate||(e.endDate=w.endDate);const k=$(),b=M({chartId:"event-timeline-chart",plugin:["am4plugins_timeline","am4plugins_bullets"],boxProps:{width:"100%",height:"100%"}});U(m.loading),y.useEffect(()=>{!b.ready||!e.rId||!e.rType||b.apply(async({am4core:t,am4charts:f,am4plugins_timeline:h,am4plugins_bullets:O})=>{s(o=>({...o,loading:!0}));const I=await k.query({query:q`
            query ($filter: AWSJSON) {
              nestedSearch(type: "reports/EventTimeline", filter: $filter) {
                items {
                  ... on AuditLog {
                    id
                    action
                    message
                    createdAt
                  }
                  ... on Activity {
                    id
                    type
                    subject
                    details
                    status
                    when
                  }
                  ... on Note {
                    id
                    type
                    subject
                    details
                    status
                    when
                  }
                }
              }
            }
          `,variables:{filter:JSON.stringify({rId:e.rId,rType:e.rType,startDate:e.startDate,endDate:e.endDate})},fetchPolicy:"network-only"});console.log(">>EventTimelineReport/index::","res",I);const F=P(I,"data.nestedSearch.items",[]);console.log(">>EventTimelineReport/index::","itewmws",F);const j=G(F,o=>{switch(console.log(">>EventTimelineReport/index::","item",o),o.__typename){case"Activity":case"Note":return o.when;default:return o.createdAt}},"asc");console.log(">>EventTimelineReport/index::","orderedItems",j);const r=t.create(b.id,h.SerpentineChart);r.curveContainer.padding(100,20,50,20),r.levelCount=3,r.yAxisRadius=t.percent(20),r.yAxisInnerRadius=t.percent(2),r.maskBullets=!1,r.dateFormatter.inputDateFormat="yyyy-MM-dd HH:mm",r.dateFormatter.dateFormat="HH",r.data=j.map(o=>{switch(o.__typename){case"Activity":{const d=A(o.when);return console.log(">>EventTimelineReport/index::","start",d),{category:"",start:d,end:d,color:t.color("#15b112"),text:o.subject,icon:"/icons/calendar-check-outline.png",rType:o.__typename}}case"Note":{const d=A(o.when);return{category:"",start:d,end:d,color:t.color("#bd851d"),text:o.subject,icon:"/icons/note-edit-outline.png",rType:o.__typename}}case"AuditLog":{const d=o,R=A(o.createdAt);return{category:"",start:R,end:R,color:t.color("#2ec1c7"),text:d.action,icon:"/icons/pencil-circle-outline.png",rType:o.__typename}}default:return null}}),console.log(">>EventTimelineReport/index::","chart.data",r.data),r.fontSize=10,r.tooltipContainer&&(r.tooltipContainer.fontSize=10);const p=r.yAxes.push(new f.CategoryAxis);p.dataFields.category="category",p.renderer.grid.template.disabled=!0,p.renderer.labels.template.paddingRight=25,p.renderer.minGridDistance=10;const a=r.xAxes.push(new f.DateAxis);a.renderer.minGridDistance=70,a.baseInterval={count:30,timeUnit:"minute"},a.renderer.tooltipLocation=0,a.renderer.line.strokeDasharray="1,4",a.renderer.line.strokeOpacity=.5,a.tooltip&&(a.tooltip.background.fillOpacity=.2,a.tooltip.background.cornerRadius=5,a.tooltip.label.fill=new t.InterfaceColorSet().getFor("alternativeBackground"),a.tooltip.label.paddingTop=7),a.endLocation=0,a.startLocation=-.5;const v=a.renderer.labels.template;v.verticalCenter="middle",v.fillOpacity=.4,v.background.fill=new t.InterfaceColorSet().getFor("background"),v.background.fillOpacity=1,v.padding(7,7,7,7);const i=r.series.push(new h.CurveColumnSeries);i.columns.template.height=t.percent(15),i.dataFields.openDateX="start",i.dataFields.dateX="end",i.dataFields.categoryY="category",i.baseAxis=p,i.columns.template.propertyFields.fill="color",i.columns.template.propertyFields.stroke="color",i.columns.template.strokeOpacity=0,i.columns.template.fillOpacity=.6;const l=i.bullets.push(new O.PinBullet);l.locationX=1,l.propertyFields.stroke="color",l.background.propertyFields.fill="color",l.image=new t.Image,l.image.propertyFields.href="icon",l.image.scale=.5,l.circle.radius=t.percent(100),l.dy=-5,l.tooltipHTML=`
          <div class="evt-tooltip">
            <h4>{rType}</h4>
            <div>{text}</div>
            <div class="evt-tooltip-date">{start.formatDate("dd/MM/yyyy hh:mm")}</div>
          </div>
        `;const u=i.bullets.push(new f.LabelBullet);u.label.propertyFields.text="text",u.disabled=!0,u.propertyFields.disabled="textDisabled",u.label.strokeOpacity=0,u.locationX=1,u.dy=-100,u.label.textAlign="middle",r.scrollbarX=new t.Scrollbar,r.scrollbarX.align="center",r.scrollbarX.width=t.percent(75),r.scrollbarX.opacity=.5;const x=new h.CurveCursor;r.cursor=x,x.xAxis=a,x.yAxis=p,x.lineY.disabled=!0,x.lineX.strokeDasharray="1,4",x.lineX.strokeOpacity=1,a.renderer.tooltipLocation2=0,p.cursorTooltipEnabled=!1;const D=r.createChild(t.Label);D.isMeasured=!1,D.y=t.percent(40),D.x=t.percent(50),D.horizontalCenter="middle",D.fontSize=20,s(o=>({...o,loading:!1}))})},[b,k,e]);const B=y.useCallback(t=>{T({startDate:t==null?void 0:t.startDate,endDate:t==null?void 0:t.endDate})},[T]);return c.jsxs("div",{children:[c.jsx(_,{display:"flex",justifyContent:"space-between",children:c.jsxs(_,{display:"flex",children:[c.jsx(E,{mr:3,width:"450px",children:c.jsx(J,{value:w,label:"Period",onChange:B})}),!(n.recordId&&n.recordType)&&c.jsx(E,{mr:3,width:"450px",children:c.jsx(Q,{model:"Contact,Project,Company",label:"Search Project, Company, Contact...",onChange:(t,f)=>{const h=t.currentTarget.value;console.log(">>EventTimelineReport/index::","pId",h,f),T({rId:h,rType:P(f,"_source.__typename")})},fullWidth:!0})})]})}),c.jsx(W,{className:g.chart,children:b.chart})]})}export{fe as default};
