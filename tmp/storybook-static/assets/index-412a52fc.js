import{j as e}from"./TransitionGroupContext-9d36972e.js";import{R as c}from"./index-f1f749bf.js";import{au as R,av as L,p as O,a6 as P,B as d,a4 as q,ba as M,T as v,X as F,i as E,h as G,m as $,e as A,a1 as D,Z as J,aw as V,g as b,b as H,a8 as K,ag as Q,a9 as W,aV as X,u as Y,o as Z,N as ee,Q as te,O as I,al as ae,c7 as le,ae as ne}from"./papaparse.min-b66e70e7.js";import{J as ie,e as _,w as oe,A as se,v as re}from"./Play-87fed129.js";import{f as de,a as ce}from"./index-bcfaa842.js";import{B as h}from"./Button-352c3435.js";import{g as pe}from"./_baseForOwn-9b89c4b6.js";import{p as ue}from"./_arrayIncludes-2cfb33ae.js";import{d as N}from"./Link-c687dc07.js";import"./assertThisInitialized-ad1db8e7.js";import"./_commonjsHelpers-042e6b4d.js";import"./index-96c5f47c.js";import"./isPlainObject-07477f89.js";import"./debounce-213cd46f.js";import"./iframe-ed7f5a3f.js";import"../sb-preview/runtime.js";import"./index-4d501b15.js";import"./react-router-19e5b27c.js";import"./tiny-invariant-dd7d57d2.js";import"./filter-f99df4e5.js";import"./LocalizationProvider-a287304f.js";import"./react-router-dom-60ea8218.js";import"./uniq-0d482d7b.js";import"./cloneDeep-91467704.js";import"./isNativeReflectConstruct-05c29d01.js";var k={},me=L;Object.defineProperty(k,"__esModule",{value:!0});var T=k.default=void 0,fe=me(R()),xe=e;T=k.default=(0,fe.default)((0,xe.jsx)("path",{d:"m19.77 5.03 1.4 1.4L8.43 19.17l-5.6-5.6 1.4-1.4 4.2 4.2zm0-2.83L8.43 13.54l-4.2-4.2L0 13.57 8.43 22 24 6.43z"}),"DoneOutline");const ge=$(()=>({uploadFieldsRoot:{display:"grid"},uploadFieldsContainerTitle:{fontWeight:"bold"},fileNameContainer:{display:"grid",gridTemplateColumns:"auto auto",alignItems:"center",justifyContent:"space-between"},fileLink:{display:"grid",gridAutoFlow:"column",alignItems:"center",justifyContent:"start",columnGap:5},divider:{marginTop:-15}}));function he({data:t,local:n,fileName:a,onFileNameChange:o,onRemoveClick:r}){const l=ge(),{values:{readOnly:i}={}}=O(),[m,p]=c.useState();return console.log(">>ClientUploads/UploadField::","fileName",a),console.log(">>ClientUploads/UploadField::",`data ${a}`,{data:t,s3Link:m}),c.useEffect(()=>{t!=null&&t.s3Key&&P.get(t.s3Key).then(f=>p(f)).catch(()=>console.error("Something went wrong parsing s3 link"))},[t]),e.jsx(d,{className:l.uploadFieldsRoot,children:n?e.jsx(e.Fragment,{children:e.jsx(G,{label:"Name",variant:"outlined",size:"small",value:a,onChange:o})}):e.jsxs(e.Fragment,{children:[e.jsx(q,{className:l.divider}),e.jsxs(d,{className:l.fileNameContainer,children:[t!=null&&t.s3Key&&m?e.jsxs(M,{href:m,target:"_blank",rel:"noopener",className:l.fileLink,children:[e.jsx(T,{style:{color:"rgb(26,233,112)"}}),e.jsx(v,{children:a})]}):e.jsx(v,{style:{marginLeft:30},children:a}),!i&&e.jsx(F,{title:"Remove file field",placement:"top",children:e.jsx(E,{onClick:r,size:"large",children:e.jsx(ie,{})})})]})]})})}var S={},je=L;Object.defineProperty(S,"__esModule",{value:!0});var B=S.default=void 0,Ce=je(R()),ye=e;B=S.default=(0,Ce.default)((0,ye.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m5 11h-4v4h-2v-4H7v-2h4V7h2v4h4z"}),"AddCircleOutlined");const ve=oe(J),Fe=$({uploadFieldsRoot:{display:"grid",gridRowGap:30,padding:"0px 30px"},uploadFieldsContainerTitle:{fontWeight:"bold"}});function be({files:t,id:n,...a}){const o=Fe(),[r,l]=c.useState([{id:A.v4(),fileName:"",acceptedFileTypes:[],local:!0}]),i=s=>x=>{l(r.map(u=>(u.id===s&&(u.fileName=x.target.value),u)))},m=s=>(...x)=>{l(r.map(u=>(u.id===s&&(u.acceptedFileTypes=x[1]),u)))},p=s=>()=>{l(r.filter(x=>x.id!==s))},f=c.useCallback(s=>{const x=D(s,["updatedBy"]),u=r.map(C=>D(C,["local"]));return console.log(">>ClientUploads/Form::","values",s,r),x.files=JSON.stringify(u),l(u),{...x,clientUploadTokenId:null}},[r]);return c.useEffect(()=>{n&&l(JSON.parse(t))},[t,n]),console.log(">>ClientUploads/Form::","uploadFields",r),console.log(">>ClientUploads/Form::","formId",n),e.jsxs(ve,{name:"clientUpload",title:"Client upload form",withTags:!1,beforeSave:f,id:n,...a,children:[e.jsx(_,{name:"name",label:"Form Name"}),e.jsx(v,{variant:"overline",className:o.uploadFieldsContainerTitle,children:"Files to upload"}),e.jsx(d,{className:o.uploadFieldsRoot,children:r.map(({id:s,...x})=>e.jsx(he,{onFileNameChange:i(s),onAcceptedFileTypesChange:m(s),onRemoveClick:p(s),...x},s))}),e.jsx(_,{name:"dueDate",type:"formik-date",format:s=>s&&de(new Date(s),"MMM dd, yyyy")}),e.jsx(ke,{setUploadFields:l})]})}const ke=({setUploadFields:t})=>{const{values:{readOnly:n}={}}=O();return n?null:e.jsx(h,{variant:"outlined",startIcon:e.jsx(B,{}),onClick:()=>t(a=>[...a,{id:A.v4(),fileName:"",acceptedFileTypes:[],local:!0}]),children:"Add file field"})};function Te({label:t="Generate Link",metadata:n,onCompleted:a,...o}){const[r,l]=c.useState({generating:!1}),[i]=V(b`
      mutation($input: CreatePublicTokenInput!) {
        data: createPublicToken(input: $input) {
          id
          expiry
          metadata
        }
      }
    `,{variables:{input:{metadata:JSON.stringify(n||{}),expiry:ce(new Date,7).getTime()}},onCompleted:async p=>{await a(p.data),l(f=>({...f,generating:!1}))}}),m=c.useCallback(p=>{p.stopPropagation(),l(f=>({...f,generating:!0})),i()},[i]);return e.jsx(e.Fragment,{children:e.jsx(h,{size:"small",variant:"outlined",...o,disabled:r.generating||o.disabled,onClick:m,children:t})})}function Se({text:t}){const n=c.useRef(null),[a,o]=c.useState({showTooltip:!1,openDlg:!1}),r=c.useCallback(async l=>{l.stopPropagation(),n.current.select(),n.current.setSelectionRange(0,99999),document.execCommand("copy"),o(i=>({...i,showTooltip:!0})),await H.delay(3e3),o(i=>({...i,showTooltip:!1}))},[]);return e.jsxs(e.Fragment,{children:[e.jsx(F,{title:"Copy Link",children:e.jsxs(h,{size:"small",variant:"outlined",onClick:l=>{l.stopPropagation(),o(i=>({...i,openDlg:!0}))},children:[e.jsxs("span",{className:"btn-lbl",children:["Copy Link",e.jsx(d,{component:"span",mr:1})]}),e.jsx(N,{})]})}),e.jsxs(K,{open:a.openDlg,onClose:()=>{o(l=>({...l,openDlg:!1}))},children:[e.jsx(Q,{children:"Copy Upload Link"}),e.jsx(W,{style:{fontSize:"larger"},children:e.jsx(F,{open:a.showTooltip,disableFocusListener:!0,disableHoverListener:!0,disableTouchListener:!0,title:"Copied!",children:e.jsxs(h,{size:"small",variant:"outlined",onClick:r,children:[e.jsx(d,{component:"input",ref:n,value:t,readOnly:!0,visibility:"collapsed",mr:1,minWidth:"450px",border:"none",bgcolor:"#f1f1f1"}),"Copy",e.jsx(d,{component:"span",mr:1}),e.jsx(N,{})]})})}),e.jsx(X,{children:e.jsx(h,{size:"small",onClick:l=>{l.stopPropagation(),o(i=>({...i,openDlg:!1}))},children:"Close"})})]})]})}function Ze({companyId:t,targetType:n,targetId:a}){var u,C;const[o,r]=c.useState({editId:null}),[l,i]=c.useState(),m={};t&&(m.companyId={eq:t}),n&&(m.targetType={eq:n}),a&&(m.targetId={eq:a});const p=Y(b`
      query QUERY_CLIENT_UPLOAD_LIST($filter: SearchableClientUploadFilterInput) {
        list: searchClientUploads(
          filter: $filter
          sort: { field: createdAt, direction: desc }
        ) {
          items {
            id
            name
            files
            dueDate
            clientUploadTokenId
          }
        }
      }
    `,{variables:{filter:m},fetchPolicy:"cache-and-network",nextFetchPolicy:"cache-first"}),f=pe(p,"data.list.items",[]),s=Z(),x=c.useCallback(async g=>{if(!g.id)return;const j=JSON.parse(g.metadata||"{}");await s.mutate({mutation:b`
          mutation($input: UpdateClientUploadInput!) {
            updateClientUpload(input: $input) {
              id
              clientUploadTokenId
            }
          }
        `,variables:{input:{id:j.id,clientUploadTokenId:g.id}}})},[s]);return c.useEffect(()=>{const g=se.graphql(re(`
        subscription {
          onUpdateClientUpload {
            clientUploadTokenId
            createdBy
            details
            dueDate
            companyId
            createdAt
            files
          }
        }
      `)).subscribe({next:(...j)=>{console.log(">>Client Upload/index::","data",j),p.refetch()}});return()=>{g.unsubscribe()}},[p]),e.jsxs(e.Fragment,{children:[e.jsxs(d,{display:"flex",justifyContent:"space-between",children:[e.jsx("div",{}),e.jsx(h,{variant:"contained",color:"primary",onClick:()=>i(!0),children:"Create upload form"})]}),e.jsx(d,{mt:2,children:e.jsxs(ee,{loading:p.loading,data:f,onRowActionSelect:console.log,children:[e.jsx(te,{dataId:"name",label:"Form name",width:"200px"}),e.jsx(I,{dataId:"files",label:"Files",render:Ue}),e.jsx(ae,{dataId:"dueDate",label:"Due date",format:"dd/MM/yyyy"}),e.jsx(I,{dataId:"id",label:"Actions",width:"200px",render:function(j,U){const{clientUploadTokenId:y}=U,w=`${window.location.origin}/public/client/upload?_t=${y}`;return e.jsxs(d,{p:1,children:[y&&e.jsx(h,{size:"small",variant:"outlined",onClick:()=>{r(z=>({...z,editId:j})),i(!0)},children:"View"}),e.jsx(d,{mt:1}),!y&&e.jsx(Te,{metadata:U,onCompleted:x}),e.jsx(d,{mt:1}),y&&e.jsxs(e.Fragment,{children:[e.jsx(Se,{text:w}),e.jsx(d,{mt:1}),e.jsxs(h,{size:"small",variant:"outlined",onClick:()=>{window.open(w,"_blank")},children:["Upload",e.jsx(d,{component:"span",mr:1}),e.jsx(le,{})]})]})]})}})]})}),e.jsx(ne,{open:l,onClose:()=>{r(g=>({...g,editId:null})),i(!1)},children:e.jsx(be,{id:o.editId,files:(C=(u=f==null?void 0:f.filter(({id:g})=>o.editId===g))==null?void 0:u[0])==null?void 0:C.files,onCancel:()=>i(!1),onSubmit:()=>{i(!1),p.refetch()},initialValues:ue({companyId:t,targetId:a,targetType:n})})})]})}function Ue(t){const n=JSON.parse(t||"[]");return console.log(">>ClientUploads/index::","files",n),e.jsx(e.Fragment,{children:n.map(a=>{var o;return e.jsxs(d,{size:"small",children:[(o=a==null?void 0:a.data)!=null&&o.s3Key?e.jsx(T,{style:{fontSize:15,color:"rgb(26,233,112)"}}):"-"," ",a.fileName]},a.id)})})}export{Ze as default};
