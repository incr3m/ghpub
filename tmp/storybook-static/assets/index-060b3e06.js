import{j as e}from"./TransitionGroupContext-9d36972e.js";import{R as P,r as j}from"./index-f1f749bf.js";import{d as S}from"./ExpandMore-79a3c159.js";import{F as W,Z as q,u as F,ca as B,g as U,B as u,N as K,Q as v,W as V,V as D,a2 as J,ax as X,A as N,h as M,bn as Y,ar as Z,as as w,cb as L,T as C,m as G}from"./papaparse.min-b66e70e7.js";import{u as ee}from"./ProjectLink-987015ba.js";import{P as se}from"./index-79afbab1.js";import{g as te}from"./_baseForOwn-9b89c4b6.js";import{w as ne,e as I,S as oe,G as re}from"./Play-87fed129.js";import{N as le}from"./SelectEsModelInput-d580a9f7.js";import{w as ie,b as ae}from"./index-bcfaa842.js";import{B as $}from"./Button-352c3435.js";import{S as ce}from"./index-63a3e378.js";import{g as de,p as me,a as ue}from"./filter-f99df4e5.js";import{S as pe}from"./Save-1bca3c1a.js";import{V as xe}from"./ExpenseView-2f5d1473.js";import{a as he,u as je}from"./useUpdateSetting-43faf859.js";import{A as E,h as H,i as _}from"./VewJobDetails.story-c6ae2e88.js";import"./assertThisInitialized-ad1db8e7.js";import"./_commonjsHelpers-042e6b4d.js";import"./_arrayIncludes-2cfb33ae.js";import"./index-96c5f47c.js";import"./isPlainObject-07477f89.js";import"./debounce-213cd46f.js";import"./iframe-ed7f5a3f.js";import"../sb-preview/runtime.js";import"./index-4d501b15.js";import"./pick-dba65392.js";import"./react-router-19e5b27c.js";import"./tiny-invariant-dd7d57d2.js";import"./index-61adb48a.js";import"./useGetProjectSummaryFields-0ab32aca.js";import"./Link-c687dc07.js";import"./react-router-dom-60ea8218.js";import"./useIncludeFieldNames-35a180a9.js";import"./Save-b67fa0ac.js";import"./index-147ad7aa.js";import"./Add-be7f5660.js";import"./uniq-0d482d7b.js";import"./cloneDeep-91467704.js";import"./isNativeReflectConstruct-05c29d01.js";import"./index.esm-bf21a293.js";import"./index-ce960f89.js";import"./index-f70ce446.js";import"./zod-575fe4a8.js";import"./userGroups-edff3f7b.js";import"./LocalizationProvider-a287304f.js";import"./SortUpIcon-3aecf5f0.js";import"./TableRow-00aadd87.js";import"./TableHead-dd1583ce.js";import"./MenuOptions-0bc3bb51.js";import"./index-72884e22.js";import"./index-356e4a49.js";import"./stories-1f769a10.js";import"./SyncEagleDevTool-4c34bdb8.js";import"./searchUsers-04324aeb.js";import"./find-8750f979.js";import"./index-18188c67.js";import"./useFetchMore-be228481.js";import"./useTagSearch-f4fcfbe9.js";import"./Skeleton-cd6f071e.js";import"./uniqBy-baac1626.js";import"./RemoveCircle-617bdac2.js";import"./index-b769406f.js";import"./DragIndicator-582939ba.js";import"./capitalize-c31f38e2.js";import"./isString-2f2f79c0.js";import"./Person-5be09a1e.js";import"./times-069ea398.js";import"./_castFunction-353dfc26.js";import"./TaskForm-863cdb73.js";import"./RepeatFields-8275ed19.js";import"./useBeforeSave-e049f6dd.js";import"./Alert-fd9a067a.js";import"./TaskAssignees-858ea3c9.js";import"./useTaskAssignees-9f1fd5d3.js";import"./github-91d085b0.js";import"./OpportunityLink-b32d0c35.js";import"./index-9d3afdfc.js";import"./Check-78df5e8e.js";import"./bundle-053bdffd.js";import"./MilestoneIcon-61fb6e69.js";import"./Trash-822e65ce.js";import"./index-5d349c56.js";import"./EstimateEditorPopover-b8debf9a.js";import"./AssigneeEditorPopover-2b4e6473.js";import"./ToggleButtonGroup-93d9af56.js";import"./index-71ed01a9.js";import"./index-4d31058a.js";import"./Undo-33c7aa7a.js";import"./camelCase-4e7e8b23.js";import"./AuditLogsNoBreadCrumbs-8da9c0ce.js";import"./MultipleSelectFieldInput-d0cee4a2.js";import"./LocationBeFormBody-c033b2b3.js";import"./reduce-4f6f1985.js";function z(s){return e.jsx(W,{...s,width:"24px",height:"24px",viewBox:"0 0 24 24",paths:["M12 12.75c1.63 0 3.07.39 4.24.9 1.08.48 1.76 1.56 1.76 2.73V18H6v-1.61c0-1.18.68-2.26 1.76-2.73 1.17-.52 2.61-.91 4.24-.91zM4 13c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm1.13 1.1c-.37-.06-.74-.1-1.13-.1-.99 0-1.93.21-2.78.58C.48 14.9 0 15.62 0 16.43V18h4.5v-1.61c0-.83.23-1.61.63-2.29zM20 13c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm4 3.43c0-.81-.48-1.53-1.22-1.85-.85-.37-1.79-.58-2.78-.58-.39 0-.76.04-1.13.1.4.68.63 1.46.63 2.29V18H24v-1.57zM12 6c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3z"]})}const O="role-perms@",fe=ne(q);function ge(){var l,o;const s=F(B,{variables:{module:"sundry",code:{beginsWith:O}},fetchPolicy:"network-only",nextFetchPolicy:"cache-first"});console.log(">>roles/RoleForm::","rolePermsQ",s);const n=(((o=(l=s.data)==null?void 0:l.result)==null?void 0:o.items)||[]).map(i=>({value:i.id,label:i.name}));return console.log(">>roles/RoleForm::","111permissionGroups",n),e.jsxs(e.Fragment,{children:[e.jsx(I,{name:"name",label:"Role Name",fullWidth:!0}),e.jsx(I,{name:"description",fullWidth:!0,multiline:!0}),e.jsx(I,{name:"costPerHour",fullWidth:!0,InputProps:{inputComponent:le}}),e.jsx(oe,{name:"permissionSettingKey",options:n,formatInputText:i=>{var a;return(a=n.find(c=>c.value===i))==null?void 0:a.label}})]})}function be({id:s,...n}){const l={};return e.jsx("div",{children:e.jsx(fe,{name:"role",title:`${s?"Update":"Create"} Role`,initialValues:l,id:s,readOnly:!!s,...n,children:e.jsx(ge,{})})})}function ye({permissionSetting:s}){return e.jsx(D,{label:s==null?void 0:s.name})}function Pe(){const s=P.useRef(null),n=F(U`
      query QUERY_ROLE_LIST {
        list: searchRoles {
          items {
            id
            name
            description
            costPerHour
            permissionSettingKey
            permissionSetting {
              id
              name
            }
          }
        }
      }
    `,{fetchPolicy:"network-only",nextFetchPolicy:"cache-first"});console.log(">>roles/RoleList::","roleQ",n);const l=te(n,"data.list.items",[]);return e.jsxs(e.Fragment,{children:[e.jsxs(u,{display:"flex",justifyContent:"space-between",children:[e.jsx(se,{mb:2,children:"ROLES"}),e.jsx("div",{children:e.jsxs($,{variant:"contained",color:"primary",onClick:()=>{s.current.open(null,{roleId:void 0})},children:[e.jsx(u,{component:z,mr:1})," Create Role"]})})]}),e.jsx(u,{mt:2,children:e.jsxs(K,{loading:n.loading,data:l,onRowClick:({id:o})=>{s.current.open(null,{roleId:o})},children:[e.jsx(v,{dataId:"name",label:"Name"}),e.jsx(v,{dataId:"description",label:"Description"}),e.jsx(v,{dataId:"costPerHour",label:"Cost Per Hour",render:o=>ie.numberFormatter(o).toCurrency()}),e.jsx(v,{dataId:"permissionSetting",label:"Permission Group",render:o=>e.jsx(ye,{permissionSetting:o})})]})}),e.jsx(V,{scroll:"body",variant:"dialog",ref:s,children:({state:o})=>e.jsx(be,{id:o==null?void 0:o.roleId,onCancel:()=>{s.current.close()},onSubmit:()=>{s.current.close(),n.refetch()}})})]})}const Re=P.memo(Pe);function Se(s){const{defaultValue:n,onChange:l}=s,[o,i]=P.useState(n.inclusions||[]),[a,c]=P.useState(n.exclusions||[]),t=J({queryKey:["GET_PERMISSIONS_Q"],queryFn:async()=>await de()});function d(r){i(r.inclusions),c(r.exclusions),l(r)}return t.isLoading?e.jsx(X,{}):e.jsxs(u,{display:"flex",columnGap:1,sx:{"& .MuiAutocomplete-inputRoot":{height:"auto"}},children:[e.jsx(u,{flex:1,children:e.jsx(N,{multiple:!0,value:o,onChange:(r,x)=>{d({inclusions:x,exclusions:a})},options:t.data,renderInput:r=>e.jsx(M,{...r,label:"Inclusions",InputLabelProps:{...r.InputLabelProps,shrink:!0}})})}),e.jsx(u,{flex:1,children:e.jsx(N,{multiple:!0,value:a,onChange:(r,x)=>{d({exclusions:x,inclusions:o})},options:t.data,renderInput:r=>e.jsx(M,{...r,label:"Exclusions",InputLabelProps:{...r.InputLabelProps,shrink:!0}})})})]})}const ve=s=>([n,l])=>{const o=(s==null?void 0:s[n])||{},a=!!Object.keys(o).includes("*");return{module:n,allModels:a,subRows:Object.keys(l).filter(c=>c!=="*").map(c=>{const t=o==null?void 0:o[c],d=Object.keys(t||[]);return{model:c,module:n,allModels:a,all:!!d.includes("*"),create:!!(t!=null&&t.includes("create")),read:!!(t!=null&&t.includes("read")),update:!!(t!=null&&t.includes("update")),delete:!!(t!=null&&t.includes("delete"))}})}},Ce=s=>Object.entries(ue).filter(([n])=>!["admin","editor"].includes(n)).map(ve(s)),ke=({data:s,permissionGroup:n,columns:l,onChange:o,tableProps:i})=>{const[a,c]=P.useState(!0),{inclusions:t,exclusions:d}=P.useMemo(()=>{const r=JSON.parse(n.value||"{}");return{inclusions:Object.keys(r.permissions||{}),exclusions:Object.keys(r.exclusions||{})}},[n.value]);return e.jsxs(u,{children:[e.jsx(Z,{sx:{display:"inline-block",float:"left",marginTop:"-36px"},control:e.jsx(w,{checked:a}),label:"Use simple",onChange:(r,x)=>{c(x)}}),e.jsx(u,{sx:{clear:"both",pt:2},children:a?e.jsx(Se,{defaultValue:{inclusions:t,exclusions:d},onChange:o}):e.jsx(xe,{data:s,columns:l,onCellChange:o,...i})})]})},T=({permissionGroup:s,columns:n,onCreate:l,...o})=>{const{enqueueSnackbar:i}=ae(),[a]=he({onCompleted:()=>{i("Permission group changes saved",{variant:"success"})},onError:m=>{console.log(m),i("Permission group changes failed to save",{variant:"error"})}}),[c]=je({onCompleted:()=>{i("Permissions group created",{variant:"success"})},onError:m=>{console.log(m),i("Permissions group failed to create",{variant:"error"})},update:(m,{data:{result:h}},y)=>{console.log({cache:m,result:h,options:y}),m.modify({fields:{settingByModuleCode:(g=[])=>{const p={__ref:`Setting:${h==null?void 0:h.id}`};console.log({newRef:p,result:h,existing:g});const f={...g};return f.items=[p,...f.items],f}}})}}),t=j.useRef(),d=j.useRef(),r=j.useMemo(()=>!!(s!=null&&s.id),[s.id]);t.current={...s==null?void 0:s.permissions},d.current={name:r&&(s==null?void 0:s.name)||""};const x=j.useMemo(()=>{const{keys:m=[]}=s,h=me(m);return Ce(h)},[s]),b=j.useCallback(m=>{if(m.inclusions){t.current={inclusions:m.inclusions,exclusions:m.exclusions};return}const{row:h,value:y,column:g}=m,{original:p}=h,f=["allModels"].includes(g.id),Q=["all"].includes(g.id),A=[p.module,f?"*":p.model,!f&&(Q?"*":g.id)].filter(Boolean).join(".");t.current[A]=y,console.log({permission:A})},[]);console.log({hasId:r,permissionGroup:s});const k=j.useCallback(()=>{var y,g;if(!d.current.name)return i("Permission Group Name is required",{variant:"error"});let m={};const h={};if(console.log("@apps_main_src_modules_settings_TeamMembers_roles_RolePermissionsMatrix_RolePermissionsTable_tsx::","permissionsRef.current",t.current),t.current&&"inclusions"in t.current){const p=t.current;p.inclusions.forEach(f=>m[f]=!0),p.exclusions.forEach(f=>h[f]=!0)}else m=Object.fromEntries(Object.entries(t.current).filter(([,p])=>!!p));if(!r){const p=`${O}${Y(d.current.name)}`;c({variables:{input:{id:p,code:p,module:"sundry",name:(y=d.current)==null?void 0:y.name,value:JSON.stringify({permissions:m,exclusions:h})}}}),l==null||l(p);return}a({variables:{input:{id:s==null?void 0:s.id,name:(g=d.current)==null?void 0:g.name,value:JSON.stringify({permissions:m,exclusions:h})}}})},[i,r,c,a,l,s.id]);return e.jsxs(u,{children:[e.jsx(u,{mt:1,mb:2,children:e.jsx(M,{fullWidth:!0,label:"Name",size:"small",defaultValue:d.current.name,onChange:m=>d.current.name=m.target.value,required:!0})}),e.jsx(u,{sx:{display:"flex",justifyContent:"flex-end"},children:e.jsxs($,{variant:"contained",color:"primary",size:"small",startIcon:r?e.jsx(pe,{}):e.jsx(re,{}),onClick:k,children:[r?"Save":"Add"," Permission Group"]})}),e.jsx(ke,{data:x,permissionGroup:s,columns:n,onChange:b,tableProps:o})]})},Ie=({getToggleAllRowsExpandedProps:s,isAllRowsExpanded:n})=>e.jsx("span",{...s(),children:n?e.jsx(S,{}):e.jsx(L,{})}),Me=({row:s})=>s.canExpand?e.jsx("span",{...s.getToggleRowExpandedProps({style:{paddingLeft:`${s.depth*2}rem`}}),children:s.isExpanded?e.jsx(S,{}):e.jsx(L,{})}):null,R=({value:s,index:n,id:l,onCellChange:o,row:i,column:a,...c})=>{const[t,d]=j.useState(s),r=x=>{d(x.target.checked),o==null||o({index:n,id:l,initialValue:s,value:x.target.checked,row:i,column:a,...c})};return j.useEffect(()=>{d(s)},[s]),console.log({column:a,row:i,index:n,id:l,initialValue:s}),["all","create","read","update","delete"].includes(a.id)&&i.depth===0||a.id==="allModels"&&i.depth===1?null:e.jsxs(u,{children:[e.jsx(w,{edge:"start",checked:t,tabIndex:-1,disableRipple:!0,onChange:r})," ",s]})};function Ee({rolePermissions:s}){const[n,l]=j.useState(!1),o=t=>(d,r)=>{l(r?t==null?void 0:t.name:!1)},i=j.useMemo(()=>[{id:"expander",Header:Ie,Cell:Me},{Header:"Module",columns:[{Header:"Module",accessor:"module"}]},{Header:"Models",columns:[{Header:"Model",accessor:"model"},{Header:"All Models",accessor:"allModels",Cell:R}]},{Header:"Actions",columns:[{Header:"All",accessor:"all",Cell:R},{Header:"Read",accessor:"read",Cell:R},{Header:"Create",accessor:"create",Cell:R},{Header:"Update",accessor:"update",Cell:R},{Header:"Delete",accessor:"delete",Cell:R}]}],[]),a=j.useMemo(()=>{var d;return s?(((d=s==null?void 0:s.result)==null?void 0:d.items)||[]).map(r=>{const{value:x}=r;if(console.log({permissionGroup:r}),!x)return[];const b=JSON.parse(x),k=Object.keys(b==null?void 0:b.permissions);return{...r,permissions:b==null?void 0:b.permissions,keys:k}}):[]},[s]),c=j.useMemo(()=>({name:"Add New Permission Group Here"}),[]);return e.jsx("div",{children:e.jsx(u,{children:e.jsxs(u,{pt:4,children:[e.jsxs(E,{expanded:n===c.name,onChange:o(c),"aria-controls":`${c.name}-content`,id:`${c.name}-header`,children:[e.jsx(H,{expandIcon:e.jsx(S,{}),children:e.jsx(C,{children:c.name})}),e.jsx(_,{children:n===c.name&&e.jsx(T,{permissionGroup:c,columns:i,onCreate:()=>l(!1)})})]}),a==null?void 0:a.map((t,d)=>{var r;return e.jsxs(E,{expanded:n===t.name,onChange:o(t),"aria-controls":`${t.name}-content`,id:`${t.name}-header`,children:[e.jsx(H,{expandIcon:e.jsx(S,{}),children:e.jsxs(C,{children:[t.name," (",(r=t.keys)==null?void 0:r.length,")"]})}),e.jsx(_,{children:n===t.name&&e.jsx(T,{permissionGroup:t,columns:i})})]},d)})]})})})}const He=j.memo(Ee),_e=()=>{const s=F(B,{variables:{module:"sundry",code:{beginsWith:O}},fetchPolicy:"network-only",nextFetchPolicy:"cache-first"});return e.jsxs("div",{children:[e.jsx(u,{display:"flex",justifyContent:"space-between",children:e.jsx(C,{sx:{fontWeight:"bold",fontSize:"16px"},children:"PERMISSION GROUPS"})}),(s==null?void 0:s.loading)&&e.jsx(u,{style:{width:"100%",display:"grid",justifyContent:"center"},children:e.jsx(ce,{})}),e.jsx(He,{rolePermissions:s.data})]})},Fe=_e;function Oe(){return e.jsxs("div",{children:[e.jsx(Re,{}),e.jsx(u,{mt:4}),e.jsx(Fe,{})]})}const Ae=G({details:{display:"unset",padding:0},roles:{padding:20}});function Pt(){const[s,n]=P.useState({selectedPanel:""}),l=Ae();return ee({paths:[{label:"Settings",link:"/settings"},{label:"Team Members",link:null}]}),e.jsx(u,{maxWidth:"100%",children:e.jsxs(E,{expanded:s.selectedPanel==="roles",onClick:()=>{n(o=>({...o,selectedPanel:"roles"}))},children:[e.jsxs(H,{onClick:()=>n({selectedRoles:"roles"}),expandIcon:e.jsx(S,{}),children:[e.jsx(u,{component:z,mr:1}),e.jsx(C,{children:"Roles"})]}),e.jsx(_,{className:l.details,children:e.jsx("div",{className:l.roles,children:s.selectedPanel==="roles"?e.jsx(Oe,{}):e.jsx("div",{})})})]})})}export{Pt as default};
