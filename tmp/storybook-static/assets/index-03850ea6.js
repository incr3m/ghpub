import{j as t}from"./TransitionGroupContext-9d36972e.js";import{r as K,R as h}from"./index-f1f749bf.js";import{y as Fn,z as _n,B as Vn,Q as Rn,w as Ln,D as Mn}from"./VewJobDetails.story-c6ae2e88.js";import{R as Se}from"./filter-f99df4e5.js";import{S as je,f as rt,w as de,b as Ne,u as $,l as V,q as Pn,aa as kn,N as Nn}from"./index-bcfaa842.js";import{ag as $n,aq as Wn,ar as _t,as as Bn,g as Yt,S as Gt,o as Un,a as Hn,w as zn,e as Yn,a3 as Vt,a4 as Rt,Y as Gn,a2 as Zn,Z as Jn,_ as qn,a9 as Kn,a5 as Qn,b as Xn}from"./Play-87fed129.js";import{B as ne}from"./Button-352c3435.js";import{Y as lt,au as eo,av as to,l as pe,d as ct,J as ue,c_ as Me,p as me,a3 as Lt,az as Zt,A as no,c$ as oo,r as Jt,B as b,aq as le,T as N,aw as Ie,g as qt,V as Kt,d0 as ao,d1 as io,d2 as Mt,ad as Qt,f as so,L as Xt,E as Ae,K as Pe,m as ro,o as en,b as lo,at as tn,Z as co,y as Pt,a4 as kt,ak as uo,d3 as po,x as mo,a2 as nn,a as Nt,v as ho,z as ce,D as $t,aQ as fo,bf as go,a1 as xo,G as Oe,bC as Ke,cn as Co,h as _e,U as yo,aR as Ve,w as te,d4 as Qe,d5 as bo,aC as Xe,bR as p,bw as it,bS as G,d6 as on,d7 as an,bd as Re,b3 as So,e as jo,ae as vo,n as To}from"./papaparse.min-b66e70e7.js";import{C as sn}from"./Cup-50456763.js";import{u as wo}from"./ProjectLink-987015ba.js";import{g as dt,K as Oo,u as Io}from"./index-9d3afdfc.js";import{L as Ao,N as Eo,C as Do,j as rn,u as Fo,p as _o,O as Vo,z as ln}from"./pick-dba65392.js";import{f as cn,u as dn}from"./react-router-19e5b27c.js";import{a as Ro,c as ae}from"./_commonjsHelpers-042e6b4d.js";import{S as un,C as be}from"./SelectEsModelInput-d580a9f7.js";import{_ as Lo}from"./iframe-ed7f5a3f.js";import{g as Mo,s as Po}from"./_baseForOwn-9b89c4b6.js";import{C as ko}from"./SyncEagleDevTool-4c34bdb8.js";import{u as pn}from"./useIncludeFieldNames-35a180a9.js";import{u as No}from"./useTagSearch-f4fcfbe9.js";import{M as Wt}from"./index-864004f3.js";import{M as $o,D as Wo}from"./app_constants-e80240cb.js";import{L as Bo}from"./userGroups-edff3f7b.js";import"./index-96c5f47c.js";import{a as Uo}from"./index.esm-bf21a293.js";import{F as et}from"./index-f70ce446.js";import{p as Ho}from"./_arrayIncludes-2cfb33ae.js";import{u as zo}from"./Person-5be09a1e.js";import{S as ut,A as Yo,u as pt}from"./EstimateEditorPopover-b8debf9a.js";import{O as Go}from"./OpportunityLink-b32d0c35.js";import{s as mt}from"./bundle-053bdffd.js";import{u as Zo}from"./useAmChart-48bd185b.js";import{T as Jo,a as Bt}from"./ToggleButtonGroup-93d9af56.js";import{p as tt}from"./index-18188c67.js";import"./assertThisInitialized-ad1db8e7.js";import"./index-72884e22.js";import"./index-147ad7aa.js";import"./index-356e4a49.js";import"./stories-1f769a10.js";import"./index-63a3e378.js";import"./index-ce960f89.js";import"./zod-575fe4a8.js";import"./Add-be7f5660.js";import"./ExpandMore-79a3c159.js";import"./react-router-dom-60ea8218.js";import"./tiny-invariant-dd7d57d2.js";import"./uniqBy-baac1626.js";import"./uniq-0d482d7b.js";import"./searchUsers-04324aeb.js";import"./RemoveCircle-617bdac2.js";import"./debounce-213cd46f.js";import"./index-b769406f.js";import"./DragIndicator-582939ba.js";import"./useFetchMore-be228481.js";import"./TableRow-00aadd87.js";import"./TableHead-dd1583ce.js";import"./capitalize-c31f38e2.js";import"./isString-2f2f79c0.js";import"./find-8750f979.js";import"./LocalizationProvider-a287304f.js";import"./Save-b67fa0ac.js";import"./Skeleton-cd6f071e.js";import"./times-069ea398.js";import"./_castFunction-353dfc26.js";import"./TaskForm-863cdb73.js";import"./RepeatFields-8275ed19.js";import"./useBeforeSave-e049f6dd.js";import"./Alert-fd9a067a.js";import"./TaskAssignees-858ea3c9.js";import"./useTaskAssignees-9f1fd5d3.js";import"./github-91d085b0.js";import"./SortUpIcon-3aecf5f0.js";import"./index-79afbab1.js";import"./isPlainObject-07477f89.js";import"./index-71ed01a9.js";import"./index-4d31058a.js";import"./Undo-33c7aa7a.js";import"./camelCase-4e7e8b23.js";import"../sb-preview/runtime.js";import"./index-4d501b15.js";import"./cloneDeep-91467704.js";import"./index-61adb48a.js";import"./useGetProjectSummaryFields-0ab32aca.js";import"./Link-c687dc07.js";import"./isNativeReflectConstruct-05c29d01.js";import"./AuditLogsNoBreadCrumbs-8da9c0ce.js";import"./ExpenseView-2f5d1473.js";import"./MenuOptions-0bc3bb51.js";import"./MultipleSelectFieldInput-d0cee4a2.js";import"./Trash-822e65ce.js";import"./LocationBeFormBody-c033b2b3.js";import"./reduce-4f6f1985.js";import"./Check-78df5e8e.js";import"./MilestoneIcon-61fb6e69.js";import"./index-5d349c56.js";import"./AssigneeEditorPopover-2b4e6473.js";const qo={50:"#eceff1",100:"#cfd8dc",200:"#b0bec5",300:"#90a4ae",400:"#78909c",500:"#607d8b",600:"#546e7a",700:"#455a64",800:"#37474f",900:"#263238",A100:"#cfd8dc",A200:"#b0bec5",A400:"#78909c",A700:"#455a64"},nt=qo,Ko=e=>{const[o]=lt(["kwLostReason"]);return t.jsx($n,{...e,options:o.kwLostReason.sort().map(n=>({label:n,value:n}))})};var ht={},Qo=to;Object.defineProperty(ht,"__esModule",{value:!0});var mn=ht.default=void 0,Xo=Qo(eo()),ea=t;mn=ht.default=(0,Xo.default)((0,ea.jsx)("path",{d:"M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5M12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5m0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"}),"Visibility");const ta=["lost","won"],hn=["FIXED_COST","TIME_AND_MATERIALS"],fn=["Fee Percentage","Fixed Fee","Free Text"],ot={green:"#1AE970",amber:"#FF9F4B",red:"#FB4189"},gn={lead:"#12C7FA",contacted:"#FF9F4B",qualified:"#fda0c4",proposed:"#FB4189",validated:"#ffc493",won:"#1AE970",lost:"#e3e3e3"};var $e={};const na=Ro(Fn);var Le={},Ut;function oa(){if(Ut)return Le;Ut=1;var e=ae&&ae.__read||function(a,i){var d=typeof Symbol=="function"&&a[Symbol.iterator];if(!d)return a;var l=d.call(a),s,u=[],T;try{for(;(i===void 0||i-- >0)&&!(s=l.next()).done;)u.push(s.value)}catch(w){T={error:w}}finally{try{s&&!s.done&&(d=l.return)&&d.call(l)}finally{if(T)throw T.error}}return u};Object.defineProperty(Le,"__esModule",{value:!0});var o=K;function n(a){var i=e(o.useState(void 0),2),d=i[0],l=i[1],s=o.useRef(a);return o.useEffect(function(){if(a){s.current=a;var u=a.subscribe(l);return function(){u.unsubscribe()}}},[a]),[d,s.current?s.current.send:function(){}]}return Le.useActor=n,Le}var ke=ae&&ae.__assign||function(){return ke=Object.assign||function(e){for(var o,n=1,a=arguments.length;n<a;n++){o=arguments[n];for(var i in o)Object.prototype.hasOwnProperty.call(o,i)&&(e[i]=o[i])}return e},ke.apply(this,arguments)},aa=ae&&ae.__rest||function(e,o){var n={};for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&o.indexOf(a)<0&&(n[a]=e[a]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,a=Object.getOwnPropertySymbols(e);i<a.length;i++)o.indexOf(a[i])<0&&Object.prototype.propertyIsEnumerable.call(e,a[i])&&(n[a[i]]=e[a[i]]);return n},xn=ae&&ae.__read||function(e,o){var n=typeof Symbol=="function"&&e[Symbol.iterator];if(!n)return e;var a=n.call(e),i,d=[],l;try{for(;(o===void 0||o-- >0)&&!(i=a.next()).done;)d.push(i.value)}catch(s){l={error:s}}finally{try{i&&!i.done&&(n=a.return)&&n.call(a)}finally{if(l)throw l.error}}return d};Object.defineProperty($e,"__esModule",{value:!0});var oe=K,Ht=na,ia={immediate:!1};function sa(e,o){o===void 0&&(o=ia);var n=o.context,a=o.guards,i=o.actions,d=o.activities,l=o.services,s=o.delays,u=o.immediate,T=o.state,w=aa(o,["context","guards","actions","activities","services","delays","immediate","state"]),C={context:n,guards:a,actions:i,activities:d,services:l,delays:s},m=oe.useRef(null);m.current===null&&(m.current=e.withConfig(C,ke(ke({},e.context),n)));var f=oe.useRef(null);f.current===null&&(f.current=Ht.interpret(m.current,w).onTransition(function(k){k.changed&&P(k)}));var g=f.current;oe.useEffect(function(){Object.assign(g.machine.options.actions,i)},[i]),oe.useEffect(function(){Object.assign(g.machine.options.services,l)},[l]);var O=T?Ht.State.create(T):g.initialState,r=xn(oe.useState(function(){return O}),2),F=r[0],P=r[1];return u&&g.start(),oe.useEffect(function(){return g.start(T?O:void 0),function(){g.stop()}},[]),[F,g.send,g]}var ra=$e.useMachine=sa;function la(e){var o=xn(oe.useState(e.state),2),n=o[0],a=o[1];return oe.useEffect(function(){a(e.state);var i=function(l){l.changed&&a(l)},d=e.subscribe(i);return function(){d.unsubscribe()}},[e]),[n,e.send,e]}$e.useService=la;var ca=oa();$e.useActor=ca.useActor;const da=(e,o,n)=>pe`
    query Search${e}s($sort: Searchable${e}SortInput, $filter: Searchable${e}FilterInput) {
      search${e}s(sort: $sort, filter: $filter, limit: ${n}) {
        total
        items{
          id
          ${o.join(`
`)}
        }
      }
    }
  `,ua=(e,o)=>pe`
    query zGet${e}($id: ID!) {
      get${e}(id: $id) {
          id
          ${o.join(`
`)}
      }
    }
  `;function pa({sort:e={},label:o,name:n,model:a,fieldNames:i=[],filter:d,limit:l=10,fieldsToSearchOn:s=["name"],formatReadOnly:u,...T}){const w=Wn(),{namesRef:C}=h.useContext(ct);C.current.names[n]=void 0;const[m]=h.useState(ue(a).replace(/ /g,"")),[f,{data:g,loading:O,error:r}]=Me(ua(m,i)),[F,{data:P,loading:k,error:v}]=Me(da(m,i,l)),{errors:L,values:{[n]:W,readOnly:y}={},setFieldValue:j}=me(),[S,I]=ra(_n,{actions:{fetchSingleRecord:()=>{f({variables:{id:W}})},fetchRecords:x=>{let U={or:s.map(Z=>{var ie;return{[Z]:{wildcard:`*${((ie=x.searchKey)==null?void 0:ie.toLowerCase())||""}*`}}})};const he={sort:e};if(d&&typeof d=="function"){const Z=d({...U});if(Z)U=Z;else throw`Value return from filter in SelectConnection ${m} is falsey!`}else d&&typeof d=="object"&&(U={...U,...d});F({variables:{filter:U,...he}})},setSelectedInForm:(x,M)=>{j(M.name,M.selectedRecord.id)}},guards:{noSelectedRecord:x=>!x.selectedRecord}});return h.useEffect(()=>{(S.matches({readOnlyMode:"fetching"})||S.matches({autocompleteMode:"fetchingSingle"}))&&!O&&(r?I("ERROR",{error:r}):g&&I("SUCCESS",{data:g==null?void 0:g[`get${m}`],fieldNames:i}))},[S,g,r,O,I,i,m]),h.useEffect(()=>{S.matches({autocompleteMode:"fetching"})&&!k&&(v?I("ERROR",{error:v}):P&&I("SUCCESS",{result:P[`search${m}s`].items}))},[S,I,P,k,v,m]),h.useEffect(()=>{(S.matches({readOnlyMode:"idle"})||S.matches({autocompleteMode:"retrievingId"}))&&W?I("RETRIEVED_ID",{recordId:W,fieldNames:i}):S.matches({autocompleteMode:"retrievingId"})&&!W&&I("NO_RETRIEVED_ID")},[W,I,S,i]),h.useEffect(()=>{y?I("SET_READONLY",{fieldNames:i}):I("SET_AUTOCOMPLETE")},[y,I,i]),S.matches("readOnlyMode")?S.matches({readOnlyMode:"fetching"})?t.jsx(Lt,{}):t.jsx(Zt,{label:o||ue(n),value:u?u(W):S.context.fieldInputValue?T.appendedValue?`${S.context.fieldInputValue} ${T.appendedValue}`:S.context.fieldInputValue:""}):S.matches({autocompleteMode:"fetchingSingle"})?t.jsx(Lt,{}):t.jsx(no,{...T,freeSolo:!0,value:S.context.fieldInputValue,onChange:(x,M)=>{M&&I("SET_SELECTED",{name:n,selectedRecord:M,fieldNames:i})},inputValue:S.context.searchKey,className:w.root,onInputChange:x=>{var M;x&&typeof((M=x==null?void 0:x.target)==null?void 0:M.value)=="string"&&I("EDIT_SEARCH_KEY",{searchKey:Vn(x.target.value)})},options:S.context.options,loading:S.matches({autocompleteMode:"typing"})||S.matches({autocompleteMode:"fetching"}),renderInput:x=>t.jsx(oo,{...x,label:o||m,fullWidth:!0,error:!!(L!=null&&L[n]),helperText:L==null?void 0:L[n]}),getOptionLabel:x=>i.reduce((M,U)=>`${M} ${(x==null?void 0:x[U])||""}`,"")})}function st(e){const o=e.gradient&&!e.gradient.disabled;return t.jsxs(je,{...e,children:[t.jsx("g",{fill:o?"url(#linear)":"inherit",children:t.jsx("path",{d:"M21.546 16.3654L19.005 11.464L16.8338 7.2763L14.0667 1.93955C13.4367 0.72449 12.2903 0 10.9992 0C9.70808 0 8.56166 0.725573 7.93168 1.93955L1.38171 14.5699L0.451306 16.3644C0.144857 16.9556 -0.0058546 17.6022 0.000173907 18.2465C0.00519766 18.8952 0.167966 19.5417 0.488481 20.1287C1.1265 21.3004 2.25986 22 3.51982 22H18.4806C19.7405 22 20.8739 21.3004 21.5119 20.1287C22.1499 18.9569 22.163 17.5491 21.5481 16.3633L21.546 16.3654ZM12.5686 11.9747C12.5686 12.9093 11.8653 13.6674 10.9982 13.6674C10.1311 13.6674 9.42775 12.9093 9.42775 11.9747V7.5C9.42775 6.56542 10.1311 5.80736 10.9982 5.80736C11.8653 5.80736 12.5686 6.56542 12.5686 7.5V11.9747ZM12.5686 17.248C12.5686 17.3033 12.5656 17.3596 12.5606 17.4148C12.5565 17.47 12.5485 17.5253 12.5385 17.5794C12.5274 17.6336 12.5153 17.6877 12.5003 17.7397C12.4852 17.7928 12.4681 17.8447 12.448 17.8967C12.4279 17.9465 12.4058 17.9974 12.3827 18.0462C12.3586 18.096 12.3315 18.1426 12.3033 18.1891C12.2742 18.2346 12.2441 18.2801 12.2119 18.3223C12.1798 18.3646 12.1446 18.4068 12.1074 18.4458C12.0712 18.4848 12.0331 18.5227 11.9929 18.5573C11.9537 18.592 11.9125 18.6255 11.8693 18.6559C11.8271 18.6873 11.7819 18.7154 11.7377 18.7414C11.6925 18.7674 11.6462 18.7912 11.599 18.8118C11.5528 18.8335 11.5036 18.8519 11.4543 18.8681C11.4061 18.8833 11.3559 18.8984 11.3056 18.9093C11.2554 18.9201 11.2041 18.9288 11.1529 18.9331C11.1017 18.9385 11.0494 18.9418 10.9982 18.9418C10.9469 18.9418 10.8947 18.9385 10.8434 18.9331C10.7922 18.9288 10.741 18.9201 10.6907 18.9093C10.6405 18.8984 10.5902 18.8844 10.542 18.8681C10.4928 18.8519 10.4446 18.8335 10.3963 18.8118C10.3501 18.7902 10.3029 18.7674 10.2577 18.7414C10.2115 18.7154 10.1683 18.6873 10.125 18.6559C10.0828 18.6255 10.0406 18.592 10.0015 18.5573C9.96228 18.5227 9.92309 18.4848 9.88692 18.4458C9.85075 18.4057 9.81558 18.3646 9.78343 18.3223C9.75128 18.2801 9.72013 18.2346 9.692 18.1891C9.66286 18.1426 9.63774 18.0949 9.61262 18.0462C9.58851 17.9974 9.56641 17.9476 9.54731 17.8967C9.52722 17.8458 9.51014 17.7928 9.49507 17.7397C9.48 17.6877 9.46694 17.6336 9.45689 17.5794C9.44684 17.5253 9.4388 17.47 9.43378 17.4148C9.42976 17.3596 9.42675 17.3033 9.42675 17.248C9.42675 17.1928 9.42976 17.1365 9.43378 17.0813C9.4388 17.026 9.44684 16.9708 9.45689 16.9167C9.46694 16.8636 9.47899 16.8095 9.49507 16.7564C9.51014 16.7044 9.52722 16.6513 9.54731 16.6004C9.56741 16.5495 9.58851 16.4986 9.61262 16.4499C9.63674 16.4012 9.66286 16.3535 9.692 16.308C9.72013 16.2615 9.75128 16.2171 9.78343 16.1748C9.81558 16.1315 9.85075 16.0893 9.88692 16.0514C9.9241 16.0113 9.96228 15.9745 10.0015 15.9388C10.0406 15.9041 10.0828 15.8716 10.125 15.8402C10.1683 15.8099 10.2125 15.7807 10.2577 15.7547C10.3029 15.7298 10.3491 15.7048 10.3963 15.6843C10.4436 15.6637 10.4928 15.6442 10.542 15.628C10.5902 15.6128 10.6405 15.5987 10.6907 15.5868C10.741 15.576 10.7922 15.5684 10.8434 15.563C10.9459 15.5511 11.0494 15.5511 11.1519 15.563C11.2031 15.5684 11.2544 15.5771 11.3046 15.5868C11.3549 15.5987 11.4051 15.6117 11.4533 15.628C11.5026 15.6442 11.5508 15.6637 11.598 15.6843C11.6452 15.7059 11.6925 15.7298 11.7367 15.7547C11.7819 15.7807 11.8261 15.8099 11.8683 15.8402C11.9115 15.8716 11.9527 15.9041 11.9919 15.9388C12.0321 15.9734 12.0712 16.0113 12.1064 16.0514C12.1436 16.0904 12.1788 16.1315 12.2109 16.1748C12.2431 16.2171 12.2732 16.2615 12.3023 16.308C12.3305 16.3535 12.3566 16.4023 12.3817 16.4499C12.4048 16.4986 12.4279 16.5485 12.447 16.6004C12.4671 16.6503 12.4842 16.7044 12.4993 16.7564C12.5133 16.8095 12.5264 16.8636 12.5375 16.9167C12.5475 16.9708 12.5555 17.026 12.5596 17.0813C12.5646 17.1365 12.5676 17.1928 12.5676 17.248H12.5686Z"})}),e.gradient&&Se(e.gradient)]})}function ma({color:e,title:o,date:n,desc:a}){const[i,d]=h.useState(null),l=w=>{d(w.currentTarget)},s=()=>{d(null)},u=!!i,T=u?"hover-popover":void 0;return t.jsxs(t.Fragment,{children:[t.jsx(ne,{"aria-owns":T,"aria-haspopup":"true",onMouseEnter:l,onMouseLeave:s,sx:{"&:hover":{background:"transparent",cursor:"unset"}},children:t.jsx(st,{sx:{color:e}})}),t.jsx(Jt,{id:T,open:u,anchorEl:i,onClose:s,disableRestoreFocus:!0,anchorOrigin:{vertical:"center",horizontal:"right"},transformOrigin:{vertical:"center",horizontal:"left"},sx:{pointerEvents:"none"},children:t.jsx(b,{width:320,sx:{p:1.875,borderWidth:0,borderTopWidth:10,borderColor:e,borderStyle:"solid",borderRadius:2.5,background:"#FFF","& p":{pl:1.25,mb:0}},children:t.jsxs(le,{container:!0,spacing:.5,children:[t.jsx(le,{item:!0,xs:1,children:t.jsx(st,{fontSize:"small",sx:{color:e}})}),t.jsx(le,{item:!0,xs:11,children:t.jsx(N,{variant:"caption",paragraph:!0,sx:{fontWeight:"bold"},children:o})}),t.jsx(le,{item:!0,xs:1,children:t.jsx(_t,{fontSize:"small",sx:{color:"#CDD3DB"}})}),t.jsx(le,{item:!0,xs:11,children:t.jsx(N,{variant:"caption",paragraph:!0,children:n?rt(new Date(n),"LLLL d y, h:mmaaa"):""})}),a&&t.jsxs(t.Fragment,{children:[t.jsx(le,{item:!0,xs:1,children:t.jsx(_t,{fontSize:"small",sx:{color:"#CDD3DB"}})}),t.jsx(le,{item:!0,xs:11,children:t.jsx(N,{variant:"caption",paragraph:!0,children:a})})]})]})})})]})}function ha(e){const o=e.gradient&&!e.gradient.disabled;return t.jsxs(je,{...e,children:[t.jsx("g",{fill:o?"url(#linear)":"inherit",children:t.jsx("path",{d:"M22 17V19H2V17H22ZM22 11V13H2V11H22ZM22 5V7H2V5H22Z"})}),e.gradient&&Se(e.gradient)]})}function fa(e){const o=e.gradient&&!e.gradient.disabled;return t.jsxs(je,{...e,children:[t.jsx("g",{fill:o?"url(#linear)":"inherit",children:t.jsx("path",{d:"M11 4V20C11 21.1046 10.1046 22 9 22H4C2.89543 22 2 21.1046 2 20V4C2 2.89543 2.89543 2 4 2H9C10.1046 2 11 2.89543 11 4ZM9 4H4V20H9V4ZM22 4V16C22 17.1046 21.1046 18 20 18H15C13.8954 18 13 17.1046 13 16V4C13 2.89543 13.8954 2 15 2H20C21.1046 2 22 2.89543 22 4ZM20 4H15V16H20V4Z"})}),e.gradient&&Se(e.gradient)]})}const ga=pe`
  mutation updateOpportunity($UpdateOpportunityInput: UpdateOpportunityInput!) {
    updateOpportunity(input: $UpdateOpportunityInput) {
      id
      stage
    }
  }
`,xa=pe`
  mutation CreateOppoFromTemplate($options: AWSJSON) {
    processBackground(type: "templates/copy-project-from-opp", options: $options) {
      metadata
    }
  }
`,Cn=pe`
  mutation CreateDuration($input: CreateDurationInput!) {
    createDuration(input: $input) {
      id
      currentValue
      timestamp
      fieldName
      recordId
      previousValue
      previousDurationTimestamp
    }
  }
`,Ca=pe`
  mutation OppoToProject($input: CreateProjectInput!) {
    createProject(input: $input) {
      id
    }
  }
`,yn=pe`
  query SearchDurations(
    $filter: SearchableDurationFilterInput
    $sort: SearchableDurationSortInput
  ) {
    searchDurations(filter: $filter, sort: $sort) {
      items {
        id
        currentValue
        timestamp
        fieldName
        recordId
        previousValue
        previousDurationTimestamp
      }
    }
  }
`,bn=e=>{const[o,n]=Ie(qt(Bn),e);return[o,n]},Sn=({stage:e,estimatedValue:o})=>{const[n]=dt(e),a=K.useMemo(()=>parseFloat(o)*(n==null?void 0:n.rate),[n==null?void 0:n.rate,o]);return[K.useMemo(()=>de.numberFormatter(a).toCurrency(),[a]),a,n]};function ya({data:e}){const o=e.estimatedValue?`$${e.estimatedValue.toLocaleString()}`:"-",[n]=Sn({stage:e.stage,estimatedValue:e.estimatedValue}),a=n||"-";return t.jsxs(t.Fragment,{children:[t.jsxs(b,{display:"flex",justifyContent:"space-between",children:[t.jsx(Kt,{label:ue(e.stage),size:"small",sx:i=>({fontSize:13,height:17,color:i.palette.common.white,borderRadius:1.25,backgroundColor:gn[(e.stage||"").toLowerCase()]})}),t.jsxs(N,{sx:{fontSize:11,color:nt[300],display:"flex","& svg":{height:18}},children:[t.jsx(Ao,{}),e.closeDate&&rt(new Date(e.closeDate),"LLL dd, yyyy")]})]}),t.jsx(ba,{company:e==null?void 0:e.company}),t.jsxs(N,{variant:"h3",sx:{mt:1.875,fontSize:15,display:"flex",alignItems:"center","& svg":{mr:1.25,opacity:.4,height:22}},children:[t.jsx(Eo,{}),t.jsx(Yt,{model:"Opportunity",data:e,children:e.name})]}),t.jsxs(b,{fontSize:12,children:[t.jsx(b,{mt:1,color:nt[300],children:ue(e.sector)}),t.jsxs(b,{mt:1,display:"flex",justifyContent:"space-between",color:nt[300],children:[t.jsxs(b,{children:["Estimated Value",t.jsx(b,{color:"black",children:t.jsx("strong",{children:o})})]}),t.jsxs(b,{children:["Weight Value",t.jsx(b,{color:"black",children:t.jsx("strong",{children:a})})]})]})]})]})}function ba({company:e}){return e?t.jsx(N,{variant:"h3",sx:o=>({mt:1.875,fontSize:15,display:"flex",alignItems:"center","& a":{color:o.palette.primary.dark},"& svg":{mr:1.25,opacity:.4,height:16}}),children:t.jsx(Yt,{model:"Company",data:e,children:ue(e==null?void 0:e.name)})}):null}function Sa({opportunities:e=[]}){const o=cn(),[n]=Ie(Cn),[a]=bn({onCompleted:()=>{d("Opportunity updated",{variant:"success"})},onError:m=>{console.log(m),d("Failed to update opportunity",{variant:"error"})}}),[i]=Me(yn,{fetchPolicy:"network-only"}),{enqueueSnackbar:d}=Ne(),[l]=h.useState({}),s=h.useCallback(m=>{o.push(`/sales/opportunity/${m.id}/`)},[o]),u=h.useCallback((m,f,g)=>{var r;const O=async({currentStage:F,opportunityId:P,previousValue:k,previousDurationTimestamp:v})=>{const L=new Date;await n({variables:{input:{currentValue:F,timestamp:Math.round(L.getTime()),fieldName:"stage",previousValue:k,previousDurationTimestamp:v||new Date().getTime(),modelName:"Opportunity",recordId:P}}}),g==="won"||g==="lost"?(await n({variables:{input:{currentValue:g,timestamp:Math.round(L.getTime()),fieldName:"stage",previousValue:F,previousDurationTimestamp:Math.round(L.getTime()),modelName:"Opportunity",recordId:P}}}),a({variables:{input:{id:P,stage:g,closeDate:new Date}}})):a({variables:{input:{id:P,stage:g}}})};if(m&&f&&g){const F=(r=m==null?void 0:m.searchDurations)==null?void 0:r.items[1];O({currentStage:f!=null&&f.stage?f.stage:"lead",opportunityId:f.id,previousValue:F==null?void 0:F.currentValue,previousDurationTimestamp:F==null?void 0:F.timestamp})}},[n,a]),T=h.useCallback(m=>({type:"CARD_ENTRY",item:{item:{...m},type:"CARD_ENTRY"},collect:f=>({isDragging:f.isDragging()})}),[]),w=h.useCallback(m=>({accept:"CARD_ENTRY",collect:f=>{var g,O;return{isOver:!!f.isOver(),canDrop:!!f.canDrop&&((O=(g=f.getItem())==null?void 0:g.item)==null?void 0:O.stage)!==m}},drop:async f=>{var g,O,r;if(((g=f==null?void 0:f.item)==null?void 0:g.stage)!==m)try{await i({variables:{filter:{recordId:{eq:(O=f==null?void 0:f.item)==null?void 0:O.id}}}}),await u(l,f==null?void 0:f.item,m),await window.localStorage.setItem("latestOppUpdated",(r=f.item)==null?void 0:r.id),await d(`Card moving to ${m}...`,{variant:"info"})}catch{d("Stage update failed",{variant:"error"})}}}),[i,u,l,d]);function C(m){return{key:m,filter:f=>(f.stage||"").toLowerCase()===m.toLowerCase()}}return t.jsx("div",{children:t.jsx(Oo,{data:e,boards:[C("lead"),C("contacted"),C("qualified"),C("proposed"),C("validated")],CardComponent:ya,onCardClick:s,cardDragOptions:T,cardDropOptions:w,type:"sales"})})}const ja=ao().shape({name:io().required(),estimatedValue:Mt().min(0).typeError("Estimated value must be numeric"),confidence:Mt().min(1,"Confidence must be between 1 and 100").max(100,"Confidence must be between 1 and 100").typeError("Confidence must be numeric")});function va(e){const o=e.gradient&&!e.gradient.disabled;return t.jsxs(je,{...e,children:[t.jsx("g",{fill:o?"url(#linear)":"inherit",children:t.jsx("path",{d:"M12 2C10.0605 2.00369 8.16393 2.57131 6.54128 3.63374C4.91862 4.69617 3.63994 6.20754 2.86099 7.98377C2.08204 9.76 1.83643 11.7244 2.15408 13.6378C2.47173 15.5511 3.33893 17.3308 4.65005 18.76C5.58647 19.775 6.72299 20.5851 7.98799 21.1392C9.25298 21.6933 10.619 21.9793 12 21.9793C13.3811 21.9793 14.7471 21.6933 16.0121 21.1392C17.2771 20.5851 18.4136 19.775 19.35 18.76C20.6612 17.3308 21.5284 15.5511 21.846 13.6378C22.1637 11.7244 21.9181 9.76 21.1391 7.98377C20.3602 6.20754 19.0815 4.69617 17.4588 3.63374C15.8362 2.57131 13.9396 2.00369 12 2ZM12 20C9.92851 19.9969 7.93896 19.1903 6.45005 17.75C6.90209 16.6495 7.67108 15.7083 8.6593 15.0459C9.64752 14.3835 10.8104 14.0298 12 14.0298C13.1897 14.0298 14.3526 14.3835 15.3408 15.0459C16.329 15.7083 17.098 16.6495 17.55 17.75C16.0611 19.1903 14.0716 19.9969 12 20ZM10 10C10 9.60444 10.1173 9.21776 10.3371 8.88886C10.5569 8.55996 10.8692 8.30362 11.2347 8.15224C11.6001 8.00087 12.0023 7.96126 12.3902 8.03843C12.7782 8.1156 13.1346 8.30608 13.4143 8.58579C13.694 8.86549 13.8844 9.22186 13.9616 9.60982C14.0388 9.99778 13.9992 10.3999 13.8478 10.7654C13.6964 11.1308 13.4401 11.4432 13.1112 11.6629C12.7823 11.8827 12.3956 12 12 12C11.4696 12 10.9609 11.7893 10.5858 11.4142C10.2108 11.0391 10 10.5304 10 10ZM18.91 16C18.0166 14.4718 16.6415 13.283 15 12.62C15.5092 12.0427 15.841 11.3307 15.9555 10.5694C16.0701 9.80822 15.9625 9.03011 15.6458 8.3285C15.3291 7.62688 14.8166 7.03156 14.17 6.61397C13.5233 6.19637 12.7698 5.97425 12 5.97425C11.2303 5.97425 10.4768 6.19637 9.83014 6.61397C9.18346 7.03156 8.67102 7.62688 8.3543 8.3285C8.03758 9.03011 7.93004 9.80822 8.04458 10.5694C8.15912 11.3307 8.49088 12.0427 9.00005 12.62C7.35865 13.283 5.98352 14.4718 5.09005 16C4.37799 14.7871 4.00177 13.4065 4.00005 12C4.00005 9.87827 4.8429 7.84344 6.34319 6.34315C7.84349 4.84285 9.87832 4 12 4C14.1218 4 16.1566 4.84285 17.6569 6.34315C19.1572 7.84344 20 9.87827 20 12C19.9983 13.4065 19.6221 14.7871 18.91 16Z"})}),e.gradient&&Se(e.gradient)]})}const Ta=h.lazy(()=>Lo(()=>import("./VewJobDetails.story-c6ae2e88.js").then(e=>e.E),["./VewJobDetails.story-c6ae2e88.js","./TransitionGroupContext-9d36972e.js","./index-f1f749bf.js","./_commonjsHelpers-042e6b4d.js","./assertThisInitialized-ad1db8e7.js","./index-72884e22.js","./index-147ad7aa.js","./index-356e4a49.js","./stories-1f769a10.js","./papaparse.min-b66e70e7.js","./_arrayIncludes-2cfb33ae.js","./_baseForOwn-9b89c4b6.js","./index-bcfaa842.js","./index-96c5f47c.js","./isNativeReflectConstruct-05c29d01.js","./Button-352c3435.js","./isPlainObject-07477f89.js","./debounce-213cd46f.js","./iframe-ed7f5a3f.js","./index-4d501b15.js","./papaparse-cdbe7e6d.css","./index-63a3e378.js","./index.esm-bf21a293.js","./index-ce960f89.js","./index-f70ce446.js","./zod-575fe4a8.js","./Add-be7f5660.js","./userGroups-edff3f7b.js","./react-router-19e5b27c.js","./tiny-invariant-dd7d57d2.js","./ProjectLink-987015ba.js","./Play-87fed129.js","./filter-f99df4e5.js","./LocalizationProvider-a287304f.js","./react-router-dom-60ea8218.js","./uniq-0d482d7b.js","./cloneDeep-91467704.js","./pick-dba65392.js","./index-61adb48a.js","./useGetProjectSummaryFields-0ab32aca.js","./SelectEsModelInput-d580a9f7.js","./Link-c687dc07.js","./useIncludeFieldNames-35a180a9.js","./Save-b67fa0ac.js","./SyncEagleDevTool-4c34bdb8.js","./searchUsers-04324aeb.js","./find-8750f979.js","./index-18188c67.js","./useFetchMore-be228481.js","./useTagSearch-f4fcfbe9.js","./Skeleton-cd6f071e.js","./ExpandMore-79a3c159.js","./uniqBy-baac1626.js","./RemoveCircle-617bdac2.js","./index-b769406f.js","./DragIndicator-582939ba.js","./TableRow-00aadd87.js","./TableHead-dd1583ce.js","./capitalize-c31f38e2.js","./isString-2f2f79c0.js","./Person-5be09a1e.js","./times-069ea398.js","./_castFunction-353dfc26.js","./TaskForm-863cdb73.js","./RepeatFields-8275ed19.js","./useBeforeSave-e049f6dd.js","./Alert-fd9a067a.js","./TaskAssignees-858ea3c9.js","./useTaskAssignees-9f1fd5d3.js","./github-91d085b0.js","./SortUpIcon-3aecf5f0.js","./OpportunityLink-b32d0c35.js","./index-9d3afdfc.js","./index-79afbab1.js","./Check-78df5e8e.js","./bundle-053bdffd.js","./MilestoneIcon-61fb6e69.js","./Trash-822e65ce.js","./index-5d349c56.js","./EstimateEditorPopover-b8debf9a.js","./AssigneeEditorPopover-2b4e6473.js","./ToggleButtonGroup-93d9af56.js","./index-0d862032.css","./index-71ed01a9.js","./index-4d31058a.js","./Undo-33c7aa7a.js","./camelCase-4e7e8b23.js","./AuditLogsNoBreadCrumbs-8da9c0ce.js","./ExpenseView-2f5d1473.js","./MenuOptions-0bc3bb51.js","./MultipleSelectFieldInput-d0cee4a2.js","./LocationBeFormBody-c033b2b3.js","./reduce-4f6f1985.js","./VewJobDetails-6c7b73a1.css"],import.meta.url));function wa({withIcon:e}){const{values:{companyId:o,readOnly:n}={},setFieldValue:a}=me(),{id:i}=h.useContext(ct);let d;o&&(d=Qt({},"bool.must.term",{"contactCompanyId.keyword":o}));const l=so({index:"contact",skip:!d,body:{size:5,query:d}}),s=Mo(l,"result.hits.hits");return h.useEffect(()=>{var u;!s||i||s.length===1&&a("opportunityMainContactId",(u=s[0]._source)==null?void 0:u.id)},[i,s,a]),t.jsxs(b,{display:"flex",sx:{"& button svg":{fontSize:30}},children:[t.jsx(un,{autoFit:!0,boxProps:{flex:1},fullWidth:!0,sort:[{"firstName.keyword":{order:"asc"}}],model:"Contact",label:"Main Contact",name:"opportunityMainContactId",query:d,renderReadonly:u=>t.jsx(Xt,{pl:1,text:"Main Contact",children:t.jsx(Do,{contact:u==null?void 0:u._source})})}),!n&&t.jsx(Rn,{label:"Add Contact",icon:e?va:void 0,onSubmit:u=>{a("opportunityMainContactId",u.id)},children:u=>t.jsx(Ta,{...u})})]})}function Oa(){const{values:e,setFieldValue:o}=me(),n=h.useCallback(a=>{console.log(">>OpportunityForm/index::","companyId",a),o("companyId",a)},[o]);return e!=null&&e.readOnly?null:t.jsx(ko,{onSaved:n})}function Ia(){const e="companyId",o=[{"name.keyword":{order:"asc"}}],{values:n,setFieldValue:a}=me(),{namesRef:i,state:d}=h.useContext(ct);i.current.names[e]=void 0;const l={},s=h.useCallback((u,T)=>{a(e,(T==null?void 0:T._id)||null)},[a]);return d.readOnly?t.jsx(Xt,{text:Ae("Company"),children:t.jsx(rn,{id:n==null?void 0:n[e]})}):t.jsx(Pe,{value:n==null?void 0:n[e],sort:o,onChange:s,model:"Company",filter:l,label:`Select ${Ae("Company",{plural:!1})}`,fullWidth:!0,multiple:!0})}function Aa(){return t.jsx(b,{style:{display:"flex"},children:t.jsxs(t.Fragment,{children:[t.jsx(Ia,{}),t.jsx(b,{mr:1}),t.jsx(b,{sx:{"& .MuiButtonBase-root":{px:"8px",py:"2.5px",borderRadius:"4px"},"& .MuiSvgIcon-root":{fontSize:24}},children:t.jsx(Oa,{})})]})})}function Ea({onChange:e}){const o=$("OPPORTUNITY_TO_SALES_JOB").value;console.log({OPPORTUNITY_TO_SALES_JOB:o});const n=K.useMemo(()=>o?fn:hn,[o]);return t.jsx(Gt,{name:"costType",label:o?"Commission Type":"Billing Type",options:n.map(a=>({label:ue(a),value:a})),onPostChange:e})}function Da(){const[e]=lt(["kwProjectSourceList"]),{sources:o}=h.useMemo(()=>({sources:e.kwProjectSourceList.map(n=>({value:n,text:n,label:n}))}),[e.kwProjectSourceList]);return t.jsx(Gt,{name:"source",options:o,addNewOption:!0})}const Fa=ro(e=>({root:{display:"inline-block",alignSelf:"start",minWidth:"250px"},cb:o=>({display:"inline-block",border:`solid 1px ${e.palette.text.secondary}`,alignSelf:"start",borderRadius:"10px",paddingRight:"10px","& > span":{cursor:o.isReadOnly?"default":"pointer"}})}));function _a(e){const o=Fa({isReadOnly:!!e.readOnly});return t.jsx("div",{className:o.root,children:t.jsx(Pe,{model:e.model,label:"Template",variant:"slim",icon:Un,query:Qt({},"bool.must.exists.field","templateSetting"),onChange:(n,a)=>{const i=a==null?void 0:a._source;console.log(">>Templates/ModelTemplateSelector::","source",i),e.onSelect(i)},fullWidth:!0})})}function Va(){const e=h.useRef({}),o=Hn(),{values:n,setValues:a,setFieldValue:i}=o.formik;pn(["template"]);const d=Ne(),l=en();return Fo(async s=>{e.current.selectedProjectTemplateId&&(await l.mutate({mutation:qt`
        mutation CreateOppoFromTemplate($options: AWSJSON) {
          processBackground(
            type: "templates/copy-opp-from-project-template"
            options: $options
          ) {
            metadata
          }
        }
      `,variables:{options:JSON.stringify({oppId:s.id,projectTemplateId:e.current.selectedProjectTemplateId})}}),d.enqueueSnackbar("Please wait for all records to be generated",{variant:"info"}),await lo.delay(2e3))}),t.jsx(_a,{model:"Project",onSelect:s=>{if(console.log(">>OpportunityForm/OpportunityTemplateSelector::","record",s),!s){i("template",null);return}const u=s!=null&&s.estimatedValue?Number(s==null?void 0:s.estimatedValue):void 0;e.current.selectedProjectTemplateId=s==null?void 0:s.id,a({...n||{},name:s==null?void 0:s.name,description:s==null?void 0:s.description,companyId:s==null?void 0:s.companyId,opportunityMainContactId:s==null?void 0:s.projectMainContactId,opportunityOppManagerId:s==null?void 0:s.managerUserId,template:`Project::${s==null?void 0:s.id}`,source:s==null?void 0:s.source,estimatedValue:!u||isNaN(u)?void 0:u})}})}const Ra=zn(co),La=()=>{const{values:{estimatedValue:e,confidence:o}={}}=me(),[n,a]=h.useState("");return h.useEffect(()=>{e&&o&&a(parseFloat(e)*parseFloat(o)/100)},[e,o,a]),t.jsx(Zt,{label:"Weighted Value",value:`$${n}`})},Ma=()=>{const{values:{source:e,companyId:o}={}}=me();pn(["sourceNameId"]);const n=(e||"").toLowerCase()==="referral";return t.jsxs(b,{sx:()=>{if(o&&n)return{display:"flex","& > *":{flex:1},"& > *:first-child":{marginRight:1}}},children:[t.jsx(Da,{}),o&&n&&t.jsx(pa,{model:"contact",name:"sourceNameId",label:"Select Referral Contact",fieldNames:["firstName","lastName"],sort:{field:"firstName",direction:"asc"},fieldsToSearchOn:["firstName","lastName"],limit:100})]})};function Pa(){const e=$("OPPORTUNITY_FORM_MINIMAL").value;return t.jsx(un,{autoFit:!0,query:ln(),sort:[{"fullname.keyword":{order:"asc"}}],model:"User",label:e?"Lead Agent":"Opportunity Manager",name:"opportunityOppManagerId"})}function ka(){const[e,o]=h.useState({withCompany:!0}),{setFieldValue:n}=me(),a=$("OPPORTUNITY_FORM_MINIMAL").value;return t.jsxs(t.Fragment,{children:[t.jsx(Pt,{name:"Opportunity.CreateOpportunityForm.Header"}),t.jsx(be,{fullWidth:!0,fieldName:"name",label:"Opportunity Name",required:!0}),!a&&t.jsx(be,{fullWidth:!0,fieldName:"description",multiline:!0,rows:3,label:"Description"}),t.jsx(Pt,{name:"Opportunity.CreateOpportunityForm.Footer"}),t.jsx(kt,{sx:{mt:1}}),t.jsx(uo,{checked:e.withCompany,label:`With ${Ae("Company",{plural:!1})}`,onChange:()=>{o(i=>({...i,withCompany:!i.withCompany})),n("companyId",null),n("opportunityMainContactId",null)},value:e.withCompany}),t.jsx(po,{in:e.withCompany,unmountOnExit:!0,children:t.jsx("div",{children:t.jsx(Aa,{})})}),t.jsx(wa,{withIcon:!0}),t.jsx(kt,{}),t.jsx(Ma,{}),t.jsxs(b,{sx:{display:"flex","& > *":{flex:1},"& > *:first-child":{marginRight:1}},children:[t.jsx(Vo,{}),t.jsx(Pa,{})]}),t.jsxs(mo,{spacing:2,children:[t.jsxs(b,{display:"flex",columnGap:1,children:[t.jsx(be,{fullWidth:!0,fieldName:"estimatedValue",label:a?"Property Value":void 0}),!a&&t.jsxs(t.Fragment,{children:[t.jsx(be,{fullWidth:!0,fieldName:"estimatedArr",label:"Estimated ARR"}),t.jsx(be,{fullWidth:!0,fieldName:"confidence",label:"Confidence (in %)"})]})]}),!a&&t.jsx(t.Fragment,{children:t.jsxs(b,{sx:{display:"flex","& > *":{flex:1},"& > *:first-child":{marginRight:1}},children:[t.jsx(La,{}),t.jsx(Ea,{})]})})]}),t.jsx(b,{children:t.jsx(Yn,{type:"date",fullWidth:!0,name:"closeDate",label:a?"Pitch Date":"Estimated Close Date"})}),!a&&t.jsx(t.Fragment,{children:t.jsx(b,{children:t.jsx(be,{fullWidth:!0,fieldName:"code",label:"Opportunity Number"})})})]})}const Na=({id:e,...o})=>{const n=new Date,a=String(n.getDate()).padStart(2,"0"),i=String(n.getMonth()+1+2%12).padStart(2,"0"),l=`${n.getFullYear()}-${i}-${a}`,{globalState:{authUser:s}}=tn(),{companyId:u}=dn(),T={closeDate:l,stage:"lead",companyId:u,opportunityOppManagerId:s==null?void 0:s.id},w=$("OPPORTUNITY_TO_SALES_JOB").value,C=h.useCallback(async({closeDate:m,estimatedValue:f,confidence:g,feeValue:O,...r})=>{let F={confidence:g,estimatedValue:f};const P=Object.keys(r).filter(L=>!L.includes("Id")||r[L]),k=_o(r,P);m&&(F={...F,closeDate:new Date(m)});const v={...F,...k};if(v.costType||(v.costType=w?fn[0]:hn[0]),w&&O){const W=typeof v.attributes=="string"?JSON.parse(v.attributes):v.attributes;v.attributes=W||{},v.attributes.feeValue=O,v.attributes.probability=20,v.attributes.commissionType=v.costType,v.costType!=="Free Text"?v.attributes.commission=v.commission:v.attributes.complexCommission=v.commission,v.attributes.commissionType=v.costType,v.attributes.grossFee=O,v.attributes=JSON.stringify(v.attributes),v.estimatedArr=O}return v},[w]);return t.jsx(b,{minWidth:600,width:"100%",children:t.jsxs(Ra,{id:e,validationSchema:ja,name:"opportunity",initialValues:T,title:"Add new opportunity",beforeSave:C,...o,children:[t.jsx(b,{width:"100%",textAlign:"left",children:!w&&t.jsx(t.Fragment,{children:t.jsx(Va,{})})}),t.jsx(ka,{})]})})},$a=Na,Wa=()=>{const{data:e}=nn({queryKey:["LIST_SALES_AGENTS"],queryFn:async()=>{const o=await Nt({key:"searchRoles",variables:{filter:{archived:{ne:!0},name:{eq:Bo.sales}},depthLimit:1}}),a=await Nt({key:"listUsers",variables:{filter:{archived:{ne:!0},...(()=>o!=null&&o.items&&(o!=null&&o.items[0])?{userRoleId:{eq:o==null?void 0:o.items[0].id}}:{})()}},depthLimit:1});return a!=null&&a.items?V.orderBy(a.items.map(i=>({photo:i==null?void 0:i.profilePhoto,label:i==null?void 0:i.fullname.trim(),value:i==null?void 0:i.id,id:i==null?void 0:i.id,fullName:i==null?void 0:i.fullname})),["label"],["asc"]):[]}});return e};function Ba({viewMode:e,isAdmin:o=!0}){const[n,a]=ho({dateStart:Ve,dateEnd:Ve,type:te,locationId:te,searchText:te,confidenceRange:te,stage:te,teamMember:te,companyQuery:te,jobType:te,createdAtStart:Ve,createdAtEnd:Ve,stages:Qe,jobTypes:Qe,teamMembers:Qe}),i=Uo({defaultValues:{stageFilter:[],typeFilter:[]}}),d=Wa(),[l]=lt(["kwOpportunityType","kwSaleStatus","lawddevKwJobType"]),s=$("OPPORTUNITY_TO_SALES_JOB").value,u=$("OPPORTUNITY_LIST_WITH_CREATED_AT_FILTER").value,T=h.useCallback(y=>{a({dateStart:y==null?void 0:y.startDate,dateEnd:y==null?void 0:y.endDate})},[a]),w=h.useMemo(()=>({startDate:n==null?void 0:n.dateStart,endDate:n==null?void 0:n.dateEnd}),[n]),C=y=>{if(!y){a({createdAtStart:void 0,createdAtEnd:void 0});return}const{startDate:j,endDate:S}=y;a({createdAtStart:j,createdAtEnd:S})},{TextFieldClear:m,ClearVisibilityRuleSx:f}=yo(),g=h.useRef(null),O=h.useRef(null),r=$("OPPORTUNITY_STAGE_MULTISELECT").on,F=$("OPPORTUNITY_TYPE_MULTISELECT").on,P=$("OPPORTUNITY_LEAD_AGENT_MULTISELECT").on,k=()=>r?t.jsx(et,{multiple:!0,limitTags:1,disableCloseOnSelect:!0,name:"stageFilter",control:i.control,textFieldProps:{label:"Stage",shrink:!0},options:[{label:"Lead",value:"lead"},{label:"Contacted",value:"contacted"},{label:"Qualified",value:"qualified"},{label:"Proposed",value:"proposed"},{label:"Validated",value:"validated"},{label:"Won",value:"won"}],onOptionSelected:(y,j)=>{const S=(j==null?void 0:j.map(I=>I.value))??void 0;a({stages:S})},sx:{ml:"5px",width:280,"& .MuiAutocomplete-tag":{mt:"5px"}},customRenderInput:t.jsx(_e,{label:"Stage",placeholder:"Select Stage/s",sx:{".MuiOutlinedInput-root .MuiAutocomplete-input":{marginTop:"3px",fontSize:"14px"}}})}):t.jsx(Oe,{fullWidth:!0,variant:"small",value:n==null?void 0:n.stage,label:"Stage",sx:{"& .MuiInputLabel-root":{top:"0px !important"}},icon:Ke,onChange:y=>{const j=y.currentTarget.value;a({stage:j})},options:l.kwSaleStatus}),v=()=>F?t.jsx(et,{multiple:!0,limitTags:1,disableCloseOnSelect:!0,name:"typeFilter",control:i.control,options:l.lawddevKwJobType.map(y=>({label:y,value:y==null?void 0:y.toLowerCase()})),onOptionSelected:(y,j)=>{const S=(j==null?void 0:j.map(I=>I.value))??void 0;a({jobTypes:S})},sx:{ml:"5px",width:280,"& .MuiAutocomplete-tag":{mt:"5px"}},customRenderInput:t.jsx(_e,{label:"Type",placeholder:"Select Type/s",sx:{".MuiOutlinedInput-root .MuiAutocomplete-input":{marginTop:"3px",fontSize:"14px"}}})}):t.jsx(Oe,{fullWidth:!0,variant:"small",value:n==null?void 0:n.jobType,label:"Type",sx:{"& .MuiInputLabel-root":{top:"0px !important"}},icon:Ke,onChange:y=>{const j=y.currentTarget.value;a({jobType:j})},options:l.lawddevKwJobType}),L=()=>P?t.jsx(et,{multiple:!0,limitTags:1,disableCloseOnSelect:!0,name:"leadAgentFilter",control:i.control,textFieldProps:{variant:"standard"},options:d??[],onOptionSelected:(y,j)=>{const S=(j==null?void 0:j.map(I=>{var x,M;return(M=(x=I.id)==null?void 0:x.toLowerCase())==null?void 0:M.replaceAll("_",",")}))??void 0;console.log({selectedAgents:S}),a({teamMembers:S})},sx:{ml:"5px",width:280,"& .MuiAutocomplete-tag":{mt:"5px"}},customRenderInput:t.jsx(_e,{label:"Lead Agent",placeholder:"Select Lead Agent/s",sx:{".MuiOutlinedInput-root .MuiAutocomplete-input":{marginTop:"3px",fontSize:"14px"}}})}):t.jsx(Oe,{fullWidth:!0,variant:"small",value:n==null?void 0:n.teamMember,label:"Lead Agent",sx:{"& .MuiInputLabel-root":{top:"0px !important"}},icon:Wt,onChange:y=>{const j=y.currentTarget.value;a({teamMember:j})},options:d??[]});return{render:t.jsxs(b,{display:"flex",flexFlow:"wrap",justifyContent:"start",children:[t.jsx(ce,{mr:2,width:"300px",mb:2,sx:s&&{"& > div > div > div > div > p":{color:"#184E9A !important"}},children:t.jsx($t,{placeholder:"Search...",textFieldProps:{label:"Opportunity",endAdornment:t.jsx(m,{clearFn:()=>{a({searchText:""}),g.current.value=""}}),sx:f,inputProps:{ref:g}},onChange:y=>{const j=y.target.value;a({searchText:j})},defaultValue:n==null?void 0:n.searchText})}),t.jsx(ce,{mr:2,width:"250px",mb:2,sx:s&&{"& > div > div > div > div > p":{color:"#184E9A !important"}},children:t.jsx($t,{placeholder:"Search...",textFieldProps:{label:Ae("Company"),endAdornment:t.jsx(m,{clearFn:()=>{a({companyQuery:""}),O.current.value=""}}),sx:{...f},inputProps:{ref:O}},onChange:y=>{const j=y.target.value;a({companyQuery:j})},defaultValue:n==null?void 0:n.companyQuery})}),e!=="cardView"&&t.jsx(ce,{mr:2,width:"300px",mb:2,children:k()}),t.jsx(ce,{mr:2,width:"300px",mb:2,children:s?t.jsx(t.Fragment,{children:L()}):t.jsx(Pe,{model:"User",label:"Sales Person",icon:Wt,sort:[{"fullname.keyword":{order:"asc"}}],onChange:y=>{const j=y.currentTarget.value;a({teamMember:j})},query:ln(),fullWidth:!0})}),s&&o&&t.jsx(ce,{mr:2,width:"300px",mb:2,children:v()}),!s&&t.jsx(ce,{mr:2,width:"400px",children:t.jsx(fo,{value:w,label:"Period",onChange:T,iconStyles:{marginTop:"0px"}})}),u&&t.jsx(ce,{mr:2,width:320,children:t.jsx(go,{onChange:C,defaultDateRange:n.createdAtStart&&n.createdAtEnd?{startDate:n.createdAtStart,endDate:n.createdAtEnd}:void 0,variant:"outlined",label:"Date Created",InputLabelProps:{shrink:!0},zIndex:9999,sx:{"& input":{fontSize:14}}})}),!s&&t.jsx($o,{values:xo(n,["dateStart","dateEnd","searchText"]),onApply:y=>{a(y)},children:({filters:y,setFilters:j})=>t.jsxs(t.Fragment,{children:[t.jsx(Oe,{fullWidth:!0,variant:"small",value:y.type,label:"Type",sx:{"& .MuiInputLabel-root":{top:"0px !important"}},icon:Ke,onChange:S=>{const I=S.currentTarget.value;j({type:I})},options:l.kwOpportunityType}),t.jsx(b,{mt:2}),t.jsx(Pe,{model:"Location",label:"Location",icon:Co,value:y.locationId,onChange:S=>{const I=S.currentTarget.value;j({locationId:I})},fullWidth:!0}),t.jsx(b,{mt:2}),t.jsx(_e,{fullWidth:!0,value:y.confidenceRange,id:"outlined-number",label:"Confidence Greater Than",type:"number",InputLabelProps:{shrink:!0},InputProps:{inputProps:{min:0,max:99},endAdornment:t.jsx(m,{clearFn:()=>j({confidenceRange:""})})},onChange:S=>{const I=S.currentTarget.value;j({confidenceRange:I})},sx:{...f,"& input::-webkit-outer-spin-button, input::-webkit-inner-spin-button":{WebkitAppearance:"none",m:0},"& input[type=number]":{MozAppearance:"textfield"}}})]})})]}),filters:{...n,dateRange:w,companyQuery:{searchText:(n==null?void 0:n.companyQuery)??""},stage:{stage:(n==null?void 0:n.stage)??null},teamMember:{teamMember:(n==null?void 0:n.teamMember)??""},jobType:{jobType:(n==null?void 0:n.jobType)??""}}}}const Ua={lostReason:Vt("",{validations:{isRequired:!0},label:"Lost Reason",data:{placeholder:"Select project",type:Rt.Dropdown}}),description:Vt("",{validations:{isRequired:!0},label:"Description",data:{type:Rt.TextField}})},Ha=({form:e,opportunityId:o,moveToStage:n})=>{const{fields:a}=e,{lostReason:i,description:d}=a,{enqueueSnackbar:l}=Ne(),[s,{loading:u}]=bn({onCompleted:()=>{l("Opportunity updated",{variant:"success"})},onError:w=>{console.log(w),l("Failed to update opportunity",{variant:"error"})}}),T=K.useCallback(async w=>{console.log({values:w});const{lostReason:C,description:m,createdBy:f}=w;s({variables:{input:{id:o,comments:JSON.stringify({lostReason:C,description:m,userId:f})}}}).then(()=>{n("lost")}).catch(O=>{console.log("Error, Moving stage to lost",O)})},[s,o,n]);return e.initialized?t.jsx(Gn,{form:e,loading:u,onClose:(w=!1)=>{e.leaveForm(()=>{},w)},onSubmit:T,children:t.jsxs(b,{children:[t.jsx(Ko,{...Zn(i,[])}),t.jsx(Jn,{...qn(d)})]})}):t.jsx("div",{})},za=Ha;function Ya(e){const{opportunityId:o,closeDate:n,...a}=e,i=pt({id:o,fieldName:"closeDate",model:"Opportunity"});return t.jsx(ut,{...a,editor:{label:"Close Date",value:n,async onSave(d){var l;await i.save(d),(l=e.onClose)==null||l.call(e,{},"backdropClick")},renderEditor(d){return t.jsx(Yo,{selector:"input",width:"200px",children:t.jsx(Kn,{label:d.label,value:d.value,format:Wo,onChange:l=>d.onChange({},l)})})}}})}function Ga(e){const{opportunityId:o,estimatedArr:n,...a}=e,i=pt({id:o,fieldName:"estimatedArr",model:"Opportunity"}),d=$("OPPORTUNITY_TO_SALES_JOB").value;return console.log({OPPORTUNITY_TO_SALES_JOB:d}),t.jsx(ut,{...a,editor:{label:d?"Net Fee":"Estimated ARR",value:n,async onSave(l){var s;await i.save(l),(s=e.onClose)==null||s.call(e,{},"backdropClick")}}})}function Za(e){const{opportunityId:o,estimatedValue:n,...a}=e,i=pt({id:o,fieldName:"estimatedValue",model:"Opportunity"});return t.jsx(ut,{...a,editor:{label:"Estimated Value",value:n,async onSave(d){var l;await i.save(d),(l=e.onClose)==null||l.call(e,{},"backdropClick")}}})}function Ja(){const[e,o]=h.useState(null),[n,a]=h.useState(null),[i,d]=h.useState(null),l=(u,T)=>e===u?T:null;function s(){o(null),d(null),a(null)}return{open(u){o(u.fieldName),d(u.data),a(u.anchor)},closeEditors:s,render(){const u=i;return u?t.jsxs(t.Fragment,{children:[l("closeDate",t.jsx(Ya,{opportunityId:u.id,closeDate:u.closeDate,anchorOrigin:{vertical:"bottom",horizontal:"left"},anchorEl:n,open:!0,onClose:s})),l("estimatedArr",t.jsx(Ga,{opportunityId:u.id,estimatedArr:u.estimatedArr||null,anchorOrigin:{vertical:"bottom",horizontal:"left"},anchorEl:n,open:!0,onClose:s})),l("estimatedValue",t.jsx(Za,{opportunityId:u.id,estimatedValue:u.estimatedValue||null,anchorOrigin:{vertical:"bottom",horizontal:"left"},anchorEl:n,open:!0,onClose:s}))]}):null}}}var qa=Po,Ka=bo,Qa=Object.prototype,Xa=Qa.hasOwnProperty,ei=Ka(function(e,o,n){Xa.call(e,n)?++e[n]:qa(e,n,1)}),ti=ei;const ni=ti;function oi(e){const o=e.gradient&&!e.gradient.disabled;return t.jsxs(je,{...e,children:[t.jsx("g",{fill:o?"url(#linear)":"inherit",children:t.jsx("path",{d:"M2.81818 3H21.1818C22.186 3 23 3.89543 23 5V17C23 18.1046 22.186 19 21.1818 19H2.81818C1.81403 19 1 18.1046 1 17V5C1 3.89543 1.81403 3 2.81818 3ZM3 5V17H21V5H3ZM5 15V13H7V15H5ZM8 15V13H11V15H8ZM17 15V13H19V15H17ZM14 15V13H16V15H14ZM5 8H8V11H5V8Z"})}),e.gradient&&Se(e.gradient)]})}function ai(e){const o=e.gradient&&!e.gradient.disabled;return t.jsxs(je,{...e,children:[t.jsx("g",{fill:o?"url(#linear)":"inherit",children:t.jsx("path",{d:"M14.032 15.4462C13.4365 15.7981 12.7418 16 12 16C11.2582 16 10.5635 15.7981 9.96803 15.4462L7.70711 17.7071L6.29289 16.2929L8.55382 14.032C8.20193 13.4365 8 12.7418 8 12C8 11.2582 8.20193 10.5635 8.55382 9.96803L6.29289 7.70711L7.70711 6.29289L9.96803 8.55382C10.5635 8.20193 11.2582 8 12 8C12.7418 8 13.4365 8.20193 14.032 8.55382L16.2929 6.29289L17.7071 7.70711L15.4462 9.96803C15.7981 10.5635 16 11.2582 16 12C16 12.7418 15.7981 13.4365 15.4462 14.032L17.7071 16.2929L16.2929 17.7071L14.032 15.4462ZM20 8H19V6H20V4H4V20H20V18H19V16H20V8ZM5 22H3.81818C2.81403 22 2 21.1046 2 20V4C2 2.89543 2.81403 2 3.81818 2H20.1818C21.186 2 22 2.89543 22 4V20C22 21.1046 21.186 22 20.1818 22H19V23H17V22H7V23H5V22ZM12 14C13.1046 14 14 13.1046 14 12C14 10.8954 13.1046 10 12 10C10.8954 10 10 10.8954 10 12C10 13.1046 10.8954 14 12 14Z"})}),e.gradient&&Se(e.gradient)]})}const ii=e=>de.numberFormatter(mt(e,"estimatedValue")).toRounded(),si=(e,o)=>{const n=e.filter(a=>a.stage!=="lost"&&a.stage!=="won"&&a.stage!=="renewals"&&a.stage!=="opportunity"&&a.stage!=="proposal");return de.numberFormatter(mt(n,a=>{const i=o[a!=null&&a.stage?a.stage.toLowerCase():""];return((a==null?void 0:a.estimatedValue)||0)*((i==null?void 0:i.rate)??0)})).toRounded()},ri=(e,{allowWon:o=!1})=>{const n=l=>o||l!=="won",a=e.filter(l=>n(l.stage)&&l.stage!=="lost"&&l.stage!=="renewals"&&l.stage!=="opportunity"&&l.stage!=="proposal"),i=a==null?void 0:a.map(l=>parseFloat(l==null?void 0:l.grossFee)||0);return de.numberFormatter(mt(i)).toRounded()};function li({opportunities:e,stages:o}){const n=$("DISABLE_ICON_GRADIENT").on,a=$("OPPORTUNITY_TO_SALES_JOB").value,i=$("OPPORTUNITY_ALLOW_WON").value,d=Pn(),l=e==null?void 0:e.length,s=K.useMemo(()=>{if(e)return ii(e)},[e]),u=K.useMemo(()=>{if(!(!e||!o))return si(e,o)},[e,o]),T=K.useMemo(()=>{if(!(!e||!o))return ri(e,{allowWon:i})},[e,o,i]),w=h.useMemo(()=>{if(e.length){const m=ni(e,g=>g.stage);return Object.keys(m).map(g=>({x:g==null?void 0:g.toLowerCase(),y:m[g==null?void 0:g.toLowerCase()],fill:d.palette.oppStageColor[g==null?void 0:g.toLowerCase()]||"black"}))}},[e,d.palette.oppStageColor]),C=Zo({chartId:"total-opp",boxProps:{width:"100%",height:"100%"}});return h.useEffect(()=>{!C.ready||!w||(w==null?void 0:w.length)<1||C.apply(({am4core:m,am4charts:f,am4themes_animated:g})=>{m.ready(function(){m.useTheme(g);const O=m.create("total-opp",f.PieChart);O.data=w;const r=O.series.push(new f.PieSeries);r.dataFields.value="y",r.dataFields.category="x",r.slices.template.stroke=m.color("#fff"),r.slices.template.strokeWidth=2,r.slices.template.strokeOpacity=1,r.slices.template.propertyFields.fill="fill",r.labels.template.disabled=!0,r.hiddenState.properties.opacity=1,r.hiddenState.properties.endAngle=-90,r.hiddenState.properties.startAngle=-90})})},[C,w]),t.jsxs(b,{sx:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gridColumnGap:20},children:[t.jsxs(Xe,{elevation:1,sx:{display:"grid",py:1.25,px:2.5,height:150,alignItems:"center",justifyContent:"stretch",gridTemplateRows:"2fr 5fr",gridTemplateColumns:"repeat(2, 1fr)"},children:[t.jsx(N,{fontWeight:"bold",sx:m=>({fontWeight:"bold",color:m.palette.text.secondary,gridColumn:"1 / span 2",gridRow:"1 / 2"}),children:"TOTAL OPPORTUNITIES"}),t.jsxs(b,{sx:{display:"grid",gridTemplateColumns:"auto auto",gridColumnGap:30,justifyContent:"start",justifySelf:"start",alignItems:"center","& svg":{fontSize:48}},children:[t.jsx(sn,{gradient:{disabled:n}}),t.jsx(N,{fontSize:40,fontWeight:"bold",children:l||"0"})]}),t.jsx(b,{sx:{gridColumn:"2 / 3",gridRow:"1 / span 2",justifySelf:"stretch",padding:1.25},children:C.chart})]}),t.jsxs(Xe,{elevation:1,sx:{display:"grid",py:1.25,px:2.5,height:150,alignItems:"center",justifyContent:"stretch",gridTemplateRows:"2fr 5fr"},children:[t.jsx(N,{fontWeight:"bold",sx:m=>({color:m.palette.text.secondary}),children:a?"TOTAL PROPERTY VALUE":"TOTAL VALUE"}),t.jsxs(b,{sx:{display:"grid",gridTemplateColumns:"auto auto",gridColumnGap:30,justifyContent:"start",justifySelf:"start",alignItems:"center","& svg":{fontSize:48}},children:[t.jsx(oi,{gradient:{disabled:n}}),t.jsx(N,{fontSize:40,fontWeight:"bold",children:`$${s||0}`})]})]}),t.jsxs(Xe,{elevation:1,sx:{display:"grid",py:1.25,px:2.5,height:150,alignItems:"center",justifyContent:"stretch",gridTemplateRows:"2fr 5fr"},children:[t.jsx(N,{fontWeight:"bold",sx:m=>({color:m.palette.text.secondary}),children:a?"TOTAL NET FEE":"TOTAL WEIGHTED VALUE"}),t.jsxs(b,{sx:{display:"grid",gridTemplateColumns:"auto auto",gridColumnGap:30,justifyContent:"start",justifySelf:"start",alignItems:"center","& svg":{fontSize:48}},children:[t.jsx(ai,{gradient:{disabled:n}}),a?t.jsx(N,{fontSize:40,fontWeight:"bold",children:`$${T||0}`}):t.jsx(N,{fontSize:40,fontWeight:"bold",children:`$${u||0}`})]})]})]})}const ci=p.object({__typename:p.literal("Opportunity"),id:p.string(),name:p.string().optional().nullish(),type:p.string().optional().nullish(),stage:p.string().optional().nullish(),description:p.string().optional().nullish(),companyId:p.string().optional().nullish(),company:it.optional().nullish(),source:p.string().optional().nullish(),campaign:p.string().optional().nullish(),sourceNameId:p.string().optional().nullish(),opportunityMainContactId:p.string().optional().nullish(),estimatedValue:p.number().optional().nullish(),estimatedArr:p.number().optional().nullish(),confidence:p.number().optional().nullish(),externalCost:p.number().optional().nullish(),netValue:p.number().optional().nullish(),isExternalCost:p.boolean().optional().nullish(),opportunitySetting:p.string().optional().nullish(),closeDate:G.awsDateTime().optional().nullable(),opportunityOppManagerId:p.string().optional().nullish(),activities:p.array(on).optional().nullish(),closeDateActual:G.awsDateTime().optional().nullable(),startDateEst:G.awsDateTime().optional().nullable(),endDateEst:G.awsDateTime().optional().nullable(),startDateActual:G.awsDateTime().optional().nullable(),endDateActual:G.awsDateTime().optional().nullable(),opportunityLinkedProjectId:p.string().optional().nullish(),template:p.string().optional().nullish(),costType:p.string().optional().nullish(),costingDetails:p.string().optional().nullish(),code:p.string().optional().nullish(),comments:G.awsJson().optional().nullish(),attributes:G.awsJson().optional().nullish(),commissionType:p.string().optional().nullable().describe("[attribute]"),commission:p.number().optional().nullable().describe("[attribute]"),complexCommission:p.string().optional().nullable().describe("[attribute]"),grossFee:p.number().optional().nullable().describe("[attribute]"),address1:p.string().optional().nullable().describe("[attribute]"),address2:p.string().optional().nullable().describe("[attribute]"),state:p.string().optional().nullable().describe("[attribute]"),suburb:p.string().optional().nullable().describe("[attribute]"),postalCode:p.string().optional().nullable().describe("[attribute]"),...an});p.object({__typename:p.literal("OppItem"),id:p.string(),name:p.string(),title:p.string().optional(),code:p.string().optional(),description:p.string().optional(),status:p.string().optional(),type:p.string(),opportunityId:p.string(),milestoneId:p.string().optional(),precedence:p.number().optional(),taskType:p.string().optional(),jobDetails:p.string().optional(),billable:p.boolean().optional(),estimate:p.number().optional(),estimatedEffort:p.number().optional(),taskSprintId:p.string().optional(),template:p.string().optional(),cost:p.number().optional(),start:G.awsDateTime().optional().nullable(),end:G.awsDateTime().optional().nullable(),progress:p.number().optional(),priority:p.string().optional(),allocationSetting:p.string().optional(),repeatSetting:p.string().optional(),source:p.string().optional(),sourceUrl:p.string().optional(),...an});const di=async(e,o={field:"closeDate",direction:"desc"})=>{var k,v,L,W,y,j,S,I,x,M,U,he,Z,ie,se,ve;const n=V.compact(e.stages),a=V.compact(e.notStages),i=V.compact([(((k=e==null?void 0:e.createdAt)==null?void 0:k.start)||((v=e==null?void 0:e.createdAt)==null?void 0:v.end))&&{range:{createdAt:{gte:(L=e==null?void 0:e.createdAt)==null?void 0:L.start,lte:(W=e==null?void 0:e.createdAt)==null?void 0:W.end}}},(((y=e==null?void 0:e.closeDate)==null?void 0:y.start)||((j=e==null?void 0:e.closeDate)==null?void 0:j.end))&&{range:{closeDate:{gte:(S=e==null?void 0:e.closeDate)==null?void 0:S.start,lte:(I=e==null?void 0:e.closeDate)==null?void 0:I.end}}},(((x=e==null?void 0:e.closeDateActual)==null?void 0:x.start)||((M=e==null?void 0:e.closeDateActual)==null?void 0:M.end))&&{range:{closeDateActual:{gte:(U=e==null?void 0:e.closeDateActual)==null?void 0:U.start,lte:(he=e==null?void 0:e.closeDateActual)==null?void 0:he.end}}},!Number.isNaN(parseFloat(e==null?void 0:e.confidence))&&{range:{confidence:{gt:parseFloat(e==null?void 0:e.confidence)}}}]),d={bool:{must:V.compact([(n==null?void 0:n.length)&&{terms:{"stage.keyword":n}}]),should:V.compact([(e==null?void 0:e.opportunitySearchText)&&{wildcard:{"name.keyword":`*${e==null?void 0:e.opportunitySearchText}*`}},(e==null?void 0:e.opportunitySearchText)&&{wildcard:{"code.keyword":`*${e==null?void 0:e.opportunitySearchText}*`}}]),must_not:V.compact([(a==null?void 0:a.length)&&{terms:{"stage.keyword":a}}]),filter:i}},l=e!=null&&e.companySearchText?await Re({},"company",it,{size:1e4,query:{bool:{filter:V.compact([(e==null?void 0:e.companySearchText)&&{wildcard:{"name.keyword":`*${e==null?void 0:e.companySearchText}*`}}])}}}):[],s=l==null?void 0:l.map(_=>_==null?void 0:_.id),u=V.compact([...s,...(e==null?void 0:e.companyIds)||[]]),T={};T[o.field]={order:o.direction};const w=So({"id.keyword":(Z=V.compact(e.ids))!=null&&Z.length?V.compact(e.ids):void 0,"companyId.keyword":u!=null&&u.length?u:void 0,"type.keyword":(ie=V.compact(e==null?void 0:e.types))!=null&&ie.length?V.compact(e==null?void 0:e.types):void 0,"opportunityOppManagerId.keyword":(se=V.compact(e==null?void 0:e.opportunityOppManagerIds))!=null&&se.length?V.compact(e==null?void 0:e.opportunityOppManagerIds):void 0,"code.keyword":(ve=V.compact(e==null?void 0:e.codes))!=null&&ve.length?V.compact(e==null?void 0:e.codes):void 0}),C=await Re(w,"opportunity",ci,{size:1e4,query:d,sort:[T]}),m=C==null?void 0:C.map(_=>_==null?void 0:_.id),f=V.compact(V.uniq([...C==null?void 0:C.map(_=>_==null?void 0:_.companyId),...(e==null?void 0:e.companyIds)||[],...s||[]])),g=f!=null&&f.length?await Re({"id.keyword":f},"company",it,{size:1e4}):[],O=u!=null&&u.length?await Re({"activityOpportunityId.keyword":m},"activity",on,{size:1e4}):[],r=V.keyBy(g,"id"),F=V.groupBy(O,"activityOpportunityId");return C==null?void 0:C.map(_=>{const Ee=F==null?void 0:F[_==null?void 0:_.id],E=r==null?void 0:r[_==null?void 0:_.companyId];return E&&!Array.isArray(E==null?void 0:E.integrations)&&(E.integrations=V.compact([E.integrations])),{..._,activities:Ee,company:E}})},ui=h.createContext(),zt="mb-opp-list-switch-btn";function or({navKey:e="all",asTab:o,disableViewToggle:n=!1,defaultView:a="cardView"}){var wt;const{globalState:{authUser:i,teamList:d}}=tn(),l=d??[],s=Ln(l,"Admin"),[,{stagesMap:u}]=Io(),[T,w]=h.useState({oppDetails:{},navSwitch:"current",initialSort:!0}),C=o?T.navSwitch:e,m=cn(),{companyId:f}=dn(),[g,O]=h.useState(null),[r,F]=h.useState(null),{enqueueSnackbar:P,closeSnackbar:k}=Ne(),[v]=Ie(ga),[L,W]=h.useState(null),[y,j]=h.useState(null),[S]=Ie(Cn),[I]=Ie(Ca),[x,M]=h.useState(),U=new Date,he=en(),[Z,ie]=h.useState(""),[se,ve]=h.useState(n),[_,Ee]=h.useState(localStorage.getItem(zt)||a),E=$("OPPORTUNITY_TO_SALES_JOB").value,fe=$("OPPORTUNITY_WITH_SECURITY_ACCESS").value,ft=Ba({viewMode:_,isAdmin:s}),{filters:{dateRange:ge,searchText:re,locationId:jn,type:We,companyQuery:H,confidenceRange:vn,stage:Q,stages:Te,teamMember:X,jobType:ee,createdAtStart:Be,createdAtEnd:Ue,jobTypes:De,teamMembers:xe}}=ft,[Tn,Fe]=h.useState(!1);h.useEffect(()=>{console.log("nav key",C),C==="won"||C==="lost"||C==="my opportunities"?(_!=="listView"&&Ee("listView"),se||ve(!0)):se&&ve(!1)},[C,_,se]),wo({paths:[{label:"",link:"/"},{label:"Opportunities",link:"/sales"}]});const wn=No({model:"Opportunity",keyword:re}),[He,gt]=h.useState({field:"closeDate",direction:"asc"});console.log({sortFilter:He,searchText:H==null?void 0:H.searchText,stage:Q,jobType:ee,securityAccessList:l,teamMember:X,securityAccessOn:fe,isAdmin:s,navKey:C,companyId:f,textQuery:re,oppType:We,jobTypes:De,teamMembers:xe});const{data:Ce=[],isLoading:On,refetch:xt}=nn(["LIST_OPPORTUNITIES",He,H==null?void 0:H.searchText,Q,Te,ee,l,X,fe,s,C,f,re,We,Be,Ue,De,xe],async()=>{var z,Ot,It,At,Et,Dt;const c={start:ge==null?void 0:ge.startDate,end:ge==null?void 0:ge.endDate},A=["won","lost"].includes(C),D={current:{exclude:["won","lost"]},won:{include:["won"]},lost:{include:["lost"]}};console.log({navKey:C,authUser:i});let R;Te!=null&&Te.length?R=Te:(z=Q==null?void 0:Q.stage)!=null&&z.toLowerCase()?R=[(Ot=Q==null?void 0:Q.stage)==null?void 0:Ot.toLowerCase()]:R=(It=D==null?void 0:D[C])==null?void 0:It.include;let B;fe&&s&&(ee!=null&&ee.jobType)?B=[(At=ee==null?void 0:ee.jobType)==null?void 0:At.toLowerCase()]:fe&&s&&De?B=De:B=[];let Y;C==="my opportunities"?Y=[i.id]:xe?Y=xe==null?void 0:xe.map(we=>{var Ft;return(Ft=we==null?void 0:we.toLowerCase())==null?void 0:Ft.replaceAll(",","_")}):X!=null&&X.teamMember?Y=[(Et=X==null?void 0:X.teamMember)==null?void 0:Et.toLowerCase()]:Y=void 0;const Ze=fe&&!s?l:[],Je=V.compact([...B,...Ze,We]);return await di({opportunityOppManagerIds:Y,types:Je,[A?"closeDateActual":"closeDate"]:c,companySearchText:H!=null&&H.searchText?H==null?void 0:H.searchText:void 0,opportunitySearchText:re?`*${re==null?void 0:re.toLowerCase()}*`:void 0,notStages:(Dt=D==null?void 0:D[C])==null?void 0:Dt.exclude,stages:R,ids:(wn||[]).map(we=>we.id),confidence:vn,location:jn,companyIds:f?[f]:void 0,createdAt:Be&&Ue?{start:Be,end:Ue}:void 0,securityAccessOn:fe,isAdmin:s},He)}),Ct=Ja();console.log("auth user",i.id),console.log({opportunities:Ce});const ye=ta.includes(C),In=h.useCallback((c,A)=>{localStorage.setItem(zt,A),Ee(A)},[]),yt=!!g,bt=yt?"stage-value":void 0,St=Qn({form:Ua}),An=(c,A,D)=>{F(D),O(c),ie(A)},[jt,{data:vt}]=Me(yn,{variables:{filter:{fieldName:{eq:"stage"},recordId:{eq:r==null?void 0:r.id}}},fetchPolicy:"network-only",nextFetchPolicy:"cache-first"}),ze=async c=>{const A=new Date,D=await S({variables:{input:{currentValue:J,timestamp:Math.round(A.getTime()),fieldName:"stage",previousValue:L,previousDurationTimestamp:y,modelName:"Opportunity",recordId:r==null?void 0:r.id}}});let R;c==="won"||c==="lost"?(R=await S({variables:{input:{currentValue:c,timestamp:Math.round(A.getTime()),fieldName:"stage",previousValue:J,previousDurationTimestamp:Math.round(A.getTime()),modelName:"Opportunity",recordId:r==null?void 0:r.id}}}),v({variables:{UpdateOpportunityInput:{id:r==null?void 0:r.id,stage:c,closeDate:U}}})):v({variables:{UpdateOpportunityInput:{id:r==null?void 0:r.id,stage:c}}});let B=[D.data.createDuration];R&&(B=B.concat([R==null?void 0:R.data.createDuration])),M({searchDurations:{items:x==null?void 0:x.searchDurations.items.concat(B)}}),P("Updated stage",{variant:"success"}),O(null)},Tt=["lead","contacted","qualified","proposed","validated","won"],Ye=Tt[Tt.findIndex(c=>c===(r==null?void 0:r.stage))+1],J=r==null?void 0:r.stage;h.useEffect(()=>{jt()},[jt]),h.useEffect(()=>{M(vt)},[M,vt]),h.useEffect(()=>{var c,A,D,R,B,Y;(c=x==null?void 0:x.searchDurations)!=null&&c.items&&((A=x==null?void 0:x.searchDurations)==null?void 0:A.items.length)>0&&(W((R=x==null?void 0:x.searchDurations)==null?void 0:R.items[((D=x==null?void 0:x.searchDurations)==null?void 0:D.items.length)-1].currentValue),j((Y=x==null?void 0:x.searchDurations)==null?void 0:Y.items[((B=x==null?void 0:x.searchDurations)==null?void 0:B.items.length)-1].timestamp))},[x]),h.useEffect(()=>{if(J&&J==="lead"&&J==="lead"){const c=new Date(r==null?void 0:r.createdAt);j(c.getTime())}},[J,r]);const q=[Ye&&J!=="lost"?{name:`${Ye}`,handler:async()=>await ze(Ye)}:{name:"Finished!",handler:async()=>await O(!1)},J!=="lost"?{name:"Lost",handler:async()=>{St.initializeForm({},!0,{title:"Lost Reason",submitButtonText:"Submit Reason",action:"CREATE"})}}:{name:"Opportunity Lost"},r!=null&&r.opportunityLinkedProjectId?{name:E?"View Sales Job":"View project",handler:()=>{m.push(E?`/lawd/sales-job/${r==null?void 0:r.opportunityLinkedProjectId}`:`/project/${r==null?void 0:r.opportunityLinkedProjectId}`)}}:J==="won"?{name:E?"Convert to Sales Job":"Convert to Project",handler:async()=>{const c=new Date,A=r!=null&&r.estimatedValue?Number(r==null?void 0:r.estimatedValue):void 0,D=Ho({id:jo.v4(),name:r.name,description:r.description,source:r.source,sourceClientId:r.sourceNameId,companyId:r.companyId,managerUserId:r.opportunityOppManagerId,projectMainContactId:r.opportunityMainContactId,template:`Opportunity::${r==null?void 0:r.id}`,type:E?"LAWD_SALES":"task-list",attributes:r==null?void 0:r.attributes,estimatedValue:A,closeDate:c});try{await I({variables:{input:D}});const R=P("Copying task items..",{variant:"info",persist:!0});await he.mutate({mutation:xa,variables:{options:JSON.stringify({opportunityId:r.id,projectId:D.id})}}),k(R),await v({variables:{UpdateOpportunityInput:{id:r.id,opportunityLinkedProjectId:D.id,closeDate:c}}}),await ze("won"),P("Converted to project",{variant:"success"}),setTimeout(()=>{window.location.reload()},1500)}catch(R){P("Something went wrong with convertion",{variant:"warn"}),console.log("Something went wrong with converting to project: ",R)}}}:{name:"",handler:()=>{},visible:!1}];console.log(">>OpportunityList/index::","opportunities",Ce);const En=zo({callback:c=>{console.log(">>OpportunityList/index::","sortData",c),(E?["stage"]:["name","stage"]).includes(c.key)?gt({field:`${c.key}.keyword`,direction:c.sort}):gt({field:c.key,direction:c.sort})}}),Ge=(c,A,D)=>{Ct.open({anchor:c,data:A,fieldName:D})},Dn=c=>{let A=null;c.activities.forEach(R=>{A?Nn(tt(R.when),tt(A.when))===1&&(A=R):A=R});const D=kn(new Date,tt(A.when));return{title:A.subject,date:A.when,desc:A.details,color:(()=>{if(D<14)return ot.green;if(D>=14&&D<28)return ot.amber;if(D>=28)return ot.red})()}};return t.jsxs(ui.Provider,{value:{opportunities:Ce,oppDetails:T.oppDetails},children:[t.jsx(za,{form:St,opportunityId:Z,moveToStage:ze}),t.jsxs(b,{sx:{display:"grid",rowGap:.5,mt:1.25,pl:0},children:[t.jsxs(b,{display:"flex",justifyContent:"space-between",mb:2,mt:2,children:[t.jsx(N,{variant:"h1",textTransform:"uppercase",fontWeight:"bold",fontSize:20,children:"Opportunities"}),t.jsxs(b,{display:"flex",alignItems:"center",children:[o&&t.jsx(b,{width:"175px",mr:1,children:t.jsx(Oe,{fullWidth:!0,variant:"slim",value:C,label:"View",icon:mn,onChange:c=>{const A=c.currentTarget.value;w(D=>({...D,navSwitch:A}))},options:["my opportunities","current","won","lost","all"].map(c=>({value:c,text:ue(c)}))})}),t.jsx(ne,{variant:"contained",color:"primary",onClick:()=>Fe(!0),startIcon:t.jsx(sn,{}),children:"CREATE OPPORTUNITY"})]})]}),t.jsx(li,{opportunities:Ce,stages:u}),t.jsxs(b,{display:"flex",justifyContent:"space-between",mt:2,children:[ft.render,t.jsx(b,{mb:2,children:!se&&t.jsxs(Jo,{size:"small",value:_,exclusive:!0,onChange:In,sx:{gap:1,"& button":{borderColor:"rgba(0, 0, 0, 0.12) !important"}},children:[t.jsx(Bt,{value:"listView",size:"small",children:t.jsx(ha,{fontSize:"small"})}),t.jsx(Bt,{value:"cardView",size:"small",children:t.jsx(fa,{fontSize:"small"})})]})})]}),t.jsx(b,{mt:3.75,children:_==="cardView"?t.jsx(Sa,{opportunities:Ce,refetch:xt}):t.jsx(b,{mb:2,children:t.jsx(Mn,{isLoading:On,sorting:En,headers:V.compact([{name:"Name",sortField:"name",colSpan:3,hasSort:!0},{name:Ae("Company"),sortField:"company",colSpan:2},E&&{name:"Address",sortField:"description",colSpan:2},E&&{name:"Lead Agent",colSpan:1.5},!E&&{name:"Activity",sortField:"activity",colSpan:1,center:!0,icon:t.jsx(st,{fontSize:"small"})},!E&&{name:E?"Pitch Date":"EST Close Date",sortField:"closeDate",colSpan:1.5,hasSort:!0},{name:"Stage",sortField:"stage",colSpan:1,hasSort:!0},{name:E?"Property Value":ye?"Value":"EST Value(Weighted)",sortField:"estimatedValue",colSpan:1,hasSort:!0},!E&&{name:"Confidence",sortField:"confidence",colSpan:1},{name:E?"Net Fee":"EST Arr",sortField:E?"grossFee":"estimatedArr",colSpan:1,hasSort:!0}]),rows:(wt=Ce??[])==null?void 0:wt.map(c=>{var qe;const A=c.closeDate?rt(new Date(c.closeDate),"dd/MM/yyy"):"-",D=c==null?void 0:c.address1,R=c==null?void 0:c.address2,B=c==null?void 0:c.suburb,Y=c==null?void 0:c.state,Ze=c==null?void 0:c.postalCode,Je=[D,R,B,Y,Ze].filter(z=>z).join(", ");return{cells:V.compact([{colSpan:3,children:t.jsx(Go,{data:c})},{colSpan:2,children:t.jsx(rn,{company:c.company,noWrap:!1})},E&&{colSpan:2,children:t.jsx(N,{children:Je})},E&&{colSpan:1.5,children:t.jsx(Xn,{id:c==null?void 0:c.opportunityOppManagerId})},!E&&{colSpan:1,center:!0,children:(qe=c.activities)!=null&&qe.length?t.jsx(ma,{...Dn(c)}):t.jsx(t.Fragment,{})},!E&&{colSpan:1.5,children:t.jsx(ne,{sx:{"&:disabled":{color:"#052649"}},disabled:ye,onClick:z=>Ge(z.target,c,"closeDate"),children:A})},{colSpan:1,children:t.jsx(ne,{"aria-describedby":bt,disabled:ye,onClick:z=>An(z.target,c.id,c),children:t.jsx(pi,{stage:c.stage})})},{colSpan:1,children:t.jsxs(ne,{sx:{minHeight:"36.5px","&:disabled":{color:"#052649"}},disabled:ye,onClick:z=>Ge(z.target,c,"estimatedValue"),children:[t.jsx(N,{sx:{fontSize:"0.875rem"},children:de.numberFormatter(c.estimatedValue).toCurrency()||"--"}),t.jsx(mi,{stage:c.stage,estimatedValue:c.estimatedValue})]})},!E&&{colSpan:1,children:!ye&&t.jsx(hi,{stage:c.stage})},E&&{colSpan:1,children:t.jsx(ne,{sx:{minHeight:"36.5px","&:disabled":{color:"#184E9A"}},disabled:!0,children:c!=null&&c.grossFee?de.numberFormatter(c.grossFee).toCurrencyRounded():"0"})},!E&&{colSpan:1,children:t.jsx(ne,{sx:{minHeight:"36.5px","&:disabled":{color:"#052649"}},disabled:ye,onClick:z=>Ge(z.target,c,"estimatedArr"),children:c.estimatedArr?de.numberFormatter(c.estimatedArr).toCurrency():"--"})}])}}),rowsPerPage:30})})}),t.jsx(vo,{disableEscapeKeyDown:!0,maxWidth:"sm",onClose:()=>Fe(!1),scroll:"body",open:Tn,children:t.jsx(b,{children:t.jsx($a,{onCancel:()=>Fe(!1),onSubmit:async()=>{Fe(!1),xt()}})})}),t.jsx(Jt,{id:bt,open:yt,anchorEl:g,onClose:()=>O(!1),anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},children:t.jsx(b,{style:{padding:20,display:"flex"},children:t.jsxs(h.Fragment,{children:[t.jsx(at,{name:q[0].name,handler:q[0].handler,visible:q[0].visible}),t.jsx(at,{name:q[1].name,handler:q[1].handler,visible:q[1].visible}),t.jsx(at,{name:q[2].name,handler:q[2].handler,visible:q[2].visible})]})})}),Ct.render()]})]})}const pi=({stage:e})=>{const[o]=dt(e),n={color:"white",bgcolor:"grey",borderRadius:5,display:"inline",padding:"0 10px"};return e?n.bgcolor=gn[e.toLowerCase()]:n.color="black",t.jsx(b,{...n,children:e?To((o==null?void 0:o.name)??e):"-"})};function at({name:e,handler:o,visible:n=!0}){const[a,i]=h.useState({loading:!1});return t.jsx(h.Fragment,{children:n&&t.jsx(ne,{onClick:async(...d)=>{i(l=>({...l,loading:!0})),o&&await Promise.resolve(o(...d)),i(l=>({...l,loading:!1}))},variant:"outlined",disabled:a.loading,style:{marginLeft:5,whiteSpace:"nowrap",overflow:"hidden"},children:e},e)})}const mi=({stage:e,estimatedValue:o})=>{const[n]=Sn({stage:e,estimatedValue:o});return n==="$0"?null:t.jsxs(b,{sx:{fontSize:"14px",textAlign:"right"},children:["(",n,")"]})},hi=({stage:e})=>{const[o]=dt(e);return o?t.jsx(Kt,{label:`${(o==null?void 0:o.rate)*100} %`,color:"primary"}):t.jsx(b,{textAlign:"center",children:"-"})};export{ui as OpportunityListContext,pi as StageCell,hi as StageRate,mi as WeightedValueColumn,or as default};
